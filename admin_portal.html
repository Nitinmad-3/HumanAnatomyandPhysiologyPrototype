<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Portal | Human Anatomy & Physiology Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family:'Segoe UI',Arial,sans-serif; margin:0; color:#222; background:#f6f9ff; }
    header { padding:1rem; background:#e3f2fd; border-bottom:1px solid #cfe0ff; }
    header .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    header a { color:#1565c0; text-decoration:none; font-weight:600; }
    h1 { margin:0; font-size:1.4rem; color:#0d47a1; }
    main { max-width:1100px; margin:18px auto; padding:0 12px 24px; display:flex; flex-direction:column; gap:14px; }
    .panel { background:#fff; border:1px solid #cfe0ff; border-radius:10px; padding:14px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .muted { color:#375a9e; font-size:.95rem; }
    .badge { display:inline-block; font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid #cfe0ff; color:#375a9e; }
    label { font-size:13px; color:#0d47a1; font-weight:600; display:inline-block; margin-bottom:4px; }
    .input, select, textarea, input[type="datetime-local"] { width:100%; padding:10px; border:1px solid #cfe0ff; border-radius:8px; background:#fff; }
    .btn { background:#1565c0; color:#fff; border:0; padding:9px 12px; border-radius:8px; cursor:pointer; font-size:14px; }
    .btn.ghost { background:transparent; color:#1565c0; border:1px solid #cfe0ff; }
    .btn.warn { background:#c62828; }
    .btn.small { padding:6px 10px; font-size:12px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:10px; }
    .hint { font-size:12px; color:#6b84c7; }
    .ok { color:#1b5e20; font-weight:600; }
    .warn-text { color:#c62828; font-weight:600; }
    .list { display:flex; flex-direction:column; gap:8px; }
    .item { border:1px dashed #d4e4ff; border-radius:8px; padding:8px; background:#f9fbff; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; min-width:90px; text-align:center; }
    .pill.success { background:#e8f5e9; color:#1b5e20; border:1px solid #a5d6a7; }
    .pill.error { background:#ffebee; color:#c62828; border:1px solid #ef9a9a; }
    .pill.info { background:#e3f2fd; color:#1565c0; border:1px solid #bbdefb; }
    textarea { min-height:80px; }
    .chat-box { display:flex; flex-direction:column; gap:8px; max-height:420px; overflow:auto; background:#f7f9fe; border:1px solid #d4e4ff; border-radius:8px; padding:8px; }
    .chat-line { display:flex; gap:8px; align-items:flex-start; }
    .me { background:#e8f5e9; }
    .them { background:#fff; }
    .msg { padding:6px 8px; border-radius:8px; border:1px solid #d4e4ff; }
    .time { font-size:11px; color:#6b84c7; }
    .section-title { margin:0 0 10px; color:#0d47a1; }
    .status { font-size:12px; color:#6b84c7; }
    .divider { height:1px; background:#d4e4ff; margin:8px 0; }
    .danger { color:#c62828; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    /* Users */
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px dashed #cfe0ff; padding:8px 6px; text-align:left; font-size:14px; }
    th { background:#f0f6ff; color:#1565c0; }
    .lock-on { color:#2e7d32; font-weight:700; }
    .lock-off { color:#c62828; font-weight:700; }

    /* Assessments table */
    .assess-table { width:100%; border-collapse:collapse; margin-top:8px; }
    .assess-table th, .assess-table td { border-bottom:1px dashed #cfe0ff; padding:8px 6px; text-align:left; font-size:14px; }
    .assess-table th { background:#f0f6ff; color:#1565c0; }
    .btn.all { font-size:15px; font-weight:600; margin:0 8px 8px 0; }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <a href="index.html">← Home</a>
      <h1>Admin Portal</h1>
      <span id="role-badge" class="badge">Checking role…</span>
      <span id="status" class="muted" role="status" aria-live="polite" style="margin-left:auto">Initializing…</span>
    </div>
  </header>

  <main>
    <!-- Users (list, search, add, lock toggle) -->
    <section class="panel" id="users-panel">
      <h2 class="section-title">Users</h2>
      <div class="grid">
        <div>
          <label for="user-search">Search</label>
          <input id="user-search" class="input" placeholder="name, email, PRN, batch" />
        </div>
        <div class="row" style="align-items:flex-end;">
          <button id="user-refresh" class="btn">Refresh</button>
          <span id="users-status" class="muted" role="status" aria-live="polite"></span>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <details>
          <summary><b>Add Student</b></summary>
          <div class="grid" style="margin-top:8px;">
            <div><label for="new-email">Email</label><input id="new-email" class="input" type="email" placeholder="student@domain.com" /></div>
            <div><label for="new-name">Name</label><input id="new-name" class="input" placeholder="Full name" /></div>
            <div><label for="new-prn">PRN</label><input id="new-prn" class="input" placeholder="e.g., 2023-PRN-001" /></div>
            <div><label for="new-batch">Batch</label><input id="new-batch" class="input" placeholder="e.g., B1, 2024" /></div>
          </div>
          <div class="row" style="margin-top:8px;">
            <button id="user-create" class="btn">Create Student</button>
            <span id="user-create-hint" class="hint">Requires Edge Function admin_create_user (service role).</span>
          </div>
          <div id="user-create-status" class="muted" role="status" aria-live="polite"></div>
        </details>
      </div>

      <div style="overflow:auto; max-height:55vh; margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th scope="col">Name</th>
              <th scope="col">PRN</th>
              <th scope="col">Batch</th>
              <th scope="col">Email</th>
              <th scope="col">Role</th>
              <th scope="col">Profile Editing</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody id="users-tbody">
            <tr><td colspan="7" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
      <div id="users-setup-hint" class="hint" style="display:none; margin-top:6px;">
        If listing fails, ensure RLS allows admin to SELECT profiles.
      </div>
    </section>

    <!-- Assessment Lock & Schedule (full list + per-row and bulk controls) -->
    <section class="panel" aria-labelledby="assess-table-title">
      <h2 id="assess-table-title" class="section-title">Assessment Lock & Schedule</h2>
      <div class="row" style="margin-bottom:12px;">
        <button id="unlock-all-btn" class="btn all">Unlock All</button>
        <button id="lock-all-btn" class="btn all warn">Lock All</button>
        <span id="table-status" class="muted" style="margin-left:10px;"></span>
      </div>
      <div style="overflow:auto; max-height:65vh;">
        <table class="assess-table" id="assess-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Locked?</th>
              <th>Status</th>
              <th>Start (IST)</th>
              <th>Deadline (IST)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="assess-tbody">
            <tr><td colspan="7" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
      <div id="assess-table-hint" class="hint" style="margin-top:8px; display:none;">
        No rows found in public.assessments.
      </div>
    </section>

    <!-- Notifications -->
    <section class="panel" aria-labelledby="notif-title">
      <h2 id="notif-title" class="section-title">Notifications (Flash on Home)</h2>
      <div class="grid">
        <div>
          <label for="notif-message">Message</label>
          <textarea id="notif-message" class="input" placeholder="Short notice shown to all users on Home"></textarea>
        </div>
        <div>
          <label for="notif-severity">Severity</label>
          <select id="notif-severity" class="input">
            <option value="info">Info (blue)</option>
            <option value="warning">Warning (amber)</option>
            <option value="danger">Danger (red)</option>
          </select>
        </div>
        <div>
          <label for="notif-start-ist">Starts (IST)</label>
          <input type="datetime-local" id="notif-start-ist" class="input" />
        </div>
        <div>
          <label for="notif-end-ist">Ends (IST)</label>
          <input type="datetime-local" id="notif-end-ist" class="input" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="publish-notif" class="btn">Publish Notification</button>
        <span id="notif-status" class="status" role="status" aria-live="polite"></span>
      </div>
      <div class="divider"></div>
      <div class="list" id="notif-list" aria-live="polite"></div>
      <div id="notif-setup-hint" class="hint" style="margin-top:8px; display:none;">
        Backend table missing. Run setup for portal_notifications.
      </div>
    </section>

    <!-- Communication -->
    <section class="panel" aria-labelledby="chat-title">
      <h2 id="chat-title" class="section-title">Communication (Admin ↔ Students)</h2>
      <div class="grid">
        <div>
          <label for="chat-room">Room</label>
          <select id="chat-room" class="input">
            <option value="global">Global</option>
          </select>
          <div class="hint">Pick an assessment to talk in a dedicated room</div>
        </div>
      </div>
      <div id="chat-box" class="chat-box" aria-live="polite"></div>
      <div class="row">
        <label for="chat-input" class="sr-only">Message</label>
        <input id="chat-input" class="input" placeholder="Type a message…" />
        <button id="chat-send" class="btn">Send</button>
      </div>
      <div id="chat-status" class="status" role="status" aria-live="polite"></div>
      <div id="chat-setup-hint" class="hint" style="margin-top:8px; display:none;">
        Backend table missing. Run setup for portal_chat.
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script>
    // Supabase init (anon key)
    const sb = window.supabase.createClient(
      'https://hunlistfklwvpivfjmbk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bmxpc3Rma2x3dnBpdmZqbWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzA1NDUsImV4cCI6MjA3MzQwNjU0NX0.e-o_qL1Uf5DpW4gX60ktXyuUXmw5YWhqaw6Cx8Xc8Qs'
    );

    const $ = s => document.querySelector(s);
    const statusEl = $('#status');
    const roleBadge = $('#role-badge');

    // Users
    const userSearch = $('#user-search');
    const userRefresh = $('#user-refresh');
    const usersStatus = $('#users-status');
    const usersTbody = $('#users-tbody');
    const usersSetupHint = $('#users-setup-hint');

    const newEmail = $('#new-email');
    const newName = $('#new-name');
    const newPRN = $('#new-prn');
    const newBatch = $('#new-batch');
    const userCreate = $('#user-create');
    const userCreateStatus = $('#user-create-status');

    // Assessments table
    const assessTbody = $('#assess-tbody');
    const assessTableHint = $('#assess-table-hint');
    const unlockAllBtn = $('#unlock-all-btn');
    const lockAllBtn = $('#lock-all-btn');
    const tableStatus = $('#table-status');
    let allAssessRows = [];

    // Notifications
    const notifMsg = $('#notif-message');
    const notifSeverity = $('#notif-severity');
    const notifStartIst = $('#notif-start-ist');
    const notifEndIst = $('#notif-end-ist');
    const notifPublishBtn = $('#publish-notif');
    const notifStatus = $('#notif-status');
    const notifList = $('#notif-list');
    const notifSetupHint = $('#notif-setup-hint');

    // Chat
    const chatRoom = $('#chat-room');
    const chatBox = $('#chat-box');
    const chatInput = $('#chat-input');
    const chatSend = $('#chat-send');
    const chatStatus = $('#chat-status');
    const chatSetupHint = $('#chat-setup-hint');

    let currentUser = null;

    // Helpers: datetime-local (treat as local), convert to/from UTC for DB
    function pad(n){ return String(n).padStart(2,'0'); }
    // Convert a datetime-local string (local clock) to UTC ISO string
    function istLocalToUTC(dtLocal){
      if(!dtLocal) return null;
      const [d,t] = dtLocal.split('T');
      const [y,m,day] = d.split('-').map(Number);
      const [hh,mm] = (t||'00:00').split(':').map(Number);
      const local = new Date(y, (m||1)-1, day||1, hh||0, mm||0, 0, 0); // local time
      return local.toISOString(); // UTC ISO
    }
    // Convert a UTC ISO string from DB to a datetime-local value in the admin's local timezone
    function utcToIstDatetimeLocal(utcStr){
      if(!utcStr) return '';
      const d = new Date(utcStr); // this represents the same instant; getters use local tz
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function stateForRow(row){
      if(row.locked) return 'locked';
      const now = Date.now();
      const s = row.window_start ? new Date(row.window_start).getTime() : null;
      const e = row.window_end ? new Date(row.window_end).getTime() : null;
      if(s && now < s) return 'upcoming';
      if(e && now > e) return 'closed';
      return 'open';
    }
    function pillClass(state){
      if(state==='open') return 'pill success';
      if(state==='upcoming') return 'pill info';
      if(state==='closed') return 'pill error';
      return 'pill error';
    }

    function setStatus(msg){ statusEl.textContent = msg; }
    function htmlesc(s){ return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

    async function requireAdmin(){
      const { data:{ session } } = await sb.auth.getSession();
      if(!session?.user){
        window.location.replace('login_Version4.html');
        return false;
      }
      currentUser = session.user;
      const { data } = await sb.from('profiles').select('role').eq('id', currentUser.id).maybeSingle();
      const role = (data?.role || '').toLowerCase();
      const isAdmin = role === 'admin';
      roleBadge.textContent = isAdmin ? 'Admin' : 'Student';
      if(!isAdmin){
        roleBadge.classList.add('danger');
        alert('Admin only. Redirecting home.');
        window.location.replace('index.html');
        return false;
      }
      return true;
    }

    // USERS — direct SELECT (no RPC), only role='student'
    async function listStudents(){
      usersStatus.textContent = 'Loading…';
      usersTbody.innerHTML = '<tr><td colspan="7" class="muted">Loading…</td></tr>';
      try{
        const search = (userSearch?.value || '').trim();
        const orFilter = search
          ? `name.ilike.%${search}%,email.ilike.%${search}%,prn.ilike.%${search}%,batch.ilike.%${search}%`
          : null;

        let q = sb.from('profiles')
          .select('id,name,prn,batch,role,email,profile_edit_locked')
          .eq('role','student')
          .order('name', { ascending:true });

        if(orFilter) q = q.or(orFilter);

        const { data, error } = await q;
        if(error) throw error;

        usersSetupHint.style.display='none';
        renderUsers(data || []);
        usersStatus.textContent = '';
      } catch(e){
        console.warn('listStudents failed', e);
        usersStatus.textContent = 'Failed to load.';
        usersTbody.innerHTML = '<tr><td colspan="7" class="muted">Failed.</td></tr>';
        usersSetupHint.style.display='block';
      }
    }

    function renderUsers(rows){
      if(!rows.length){
        usersTbody.innerHTML = '<tr><td colspan="7" class="muted">No students found.</td></tr>';
        return;
      }
      usersTbody.innerHTML = rows.map(r=>{
        const lockTxt = r.profile_edit_locked ? '<span class="lock-on">Locked</span>' : '<span class="lock-off">Editable</span>';
        const btnLabel = r.profile_edit_locked ? 'Unlock' : 'Lock';
        return `<tr data-id="${r.id}">
          <td>${htmlesc(r.name || '')}</td>
          <td>${htmlesc(r.prn || '')}</td>
          <td>${htmlesc(r.batch || '')}</td>
          <td>${htmlesc(r.email || '')}</td>
          <td>${htmlesc(r.role || '')}</td>
          <td>${lockTxt}</td>
          <td><button class="btn small" data-act="toggle">${btnLabel}</button></td>
        </tr>`;
      }).join('');

      usersTbody.querySelectorAll('button[data-act="toggle"]').forEach(btn=>{
        btn.onclick = async ()=>{
          const tr = btn.closest('tr');
          const id = tr.getAttribute('data-id');
          btn.disabled = true;
          usersStatus.textContent = 'Updating…';
          try{
            const lockedNow = !!tr.querySelector('.lock-on');
            const { error } = await sb.from('profiles').update({ profile_edit_locked: !lockedNow }).eq('id', id);
            if(error) throw error;
            await listStudents();
          } catch(e){
            alert('Update failed: ' + (e?.message || e));
          } finally {
            btn.disabled = false;
            usersStatus.textContent = '';
          }
        };
      });
    }

    async function createStudent(){
      const email = newEmail.value.trim();
      const name = newName.value.trim();
      const prn = newPRN.value.trim();
      const batch = newBatch.value.trim();
      if(!email){ return alert('Email is required'); }
      userCreate.disabled = true;
      userCreateStatus.textContent = 'Creating user…';
      try{
        const { data, error } = await sb.functions.invoke('admin_create_user', { body:{ email, name, prn, batch, role:'student' } });
        if(error){ throw error; }
        if(!data?.ok){ throw new Error(data?.error || 'Create failed'); }
        userCreateStatus.textContent = 'Created.';
        newEmail.value = ''; newName.value=''; newPRN.value=''; newBatch.value='';
        await listStudents();
      } catch(e){
        console.warn('createStudent failed', e);
        userCreateStatus.textContent = 'Failed: ' + (e?.message || e);
        alert('Failed: ' + (e?.message || e));
      } finally {
        userCreate.disabled = false;
        setTimeout(()=> userCreateStatus.textContent='', 3000);
      }
    }

    // Assessments
    async function loadAssessments(){
      const { data, error } = await sb
        .from('assessments')
        .select('*')
        .order('id', { ascending:true });
      if(error){
        console.warn('loadAssessments', error);
        return [];
      }
      return data || [];
    }

    function renderAssessments(rows){
      allAssessRows = rows;
      if(!rows.length){
        assessTbody.innerHTML = '<tr><td colspan="7" class="muted">No assessments found.</td></tr>';
        assessTableHint.style.display='block';
        return;
      }
      assessTableHint.style.display='none';
      assessTbody.innerHTML = rows.map(r=>{
        const state = stateForRow(r);
        return `<tr data-id="${r.id}">
          <td>${r.id}</td>
          <td>${htmlesc(r.title || '')}</td>
          <td>${r.locked ? '<span class="lock-on">Locked</span>' : '<span class="lock-off">Unlocked</span>'}</td>
          <td><span class="${pillClass(state)}">${
            state==='open' ? 'Open to students' :
            state==='upcoming' ? 'Upcoming' :
            state==='closed' ? 'Closed' : 'Locked'
          }</span></td>
          <td><input type="datetime-local" class="input start-input" value="${utcToIstDatetimeLocal(r.window_start)}" /></td>
          <td><input type="datetime-local" class="input end-input" value="${utcToIstDatetimeLocal(r.window_end)}" /></td>
          <td>
            <button class="btn small lock-btn">${r.locked ? 'Unlock' : 'Lock'}</button>
            <button class="btn small ghost save-btn">Save Dates</button>
          </td>
        </tr>`;
      }).join('');

      // Wire row actions
      assessTbody.querySelectorAll('button.lock-btn').forEach(btn=>{
        btn.onclick = async ()=>{
          const tr = btn.closest('tr');
          const id = tr.getAttribute('data-id');
          btn.disabled = true;
          tableStatus.textContent = 'Toggling…';
          try{
            const row = allAssessRows.find(r=>String(r.id)===String(id));
            const newLocked = !row.locked;
            const { error } = await sb.from('assessments').update({ locked: newLocked }).eq('id', id);
            if(error) throw error;
            const updated = await loadAssessments();
            renderAssessments(updated);
            tableStatus.textContent = newLocked ? 'Assessment locked.' : 'Assessment unlocked.';
          }catch(e){
            console.warn('toggle row', e);
            tableStatus.textContent = 'Toggle failed: ' + (e?.message || e);
          }finally{
            btn.disabled = false;
            setTimeout(()=>tableStatus.textContent='', 2500);
          }
        };
      });

      assessTbody.querySelectorAll('button.save-btn').forEach(btn=>{
        btn.onclick = async ()=>{
          const tr = btn.closest('tr');
          const id = tr.getAttribute('data-id');
          const startVal = tr.querySelector('.start-input').value;
          const endVal = tr.querySelector('.end-input').value;
          btn.disabled = true;
          tableStatus.textContent = 'Saving dates…';
          try{
            const payload = {
              window_start: istLocalToUTC(startVal),
              window_end: istLocalToUTC(endVal)
            };
            let { error } = await sb.from('assessments').update(payload).eq('id', id);
            // If window_end column doesn't exist, retry with only window_start
            if(error && (String(error.code) === '42703' || /column .*window_end.* does not exist/i.test(error.message || ''))){
              const { error:err2 } = await sb.from('assessments')
                .update({ window_start: istLocalToUTC(startVal) })
                .eq('id', id);
              if(err2) throw err2;
            } else if(error){
              throw error;
            }
            const updated = await loadAssessments();
            renderAssessments(updated);
            tableStatus.textContent = 'Dates saved.';
          }catch(e){
            console.warn('save dates', e);
            tableStatus.textContent = 'Save failed: ' + (e?.message || e);
          }finally{
            btn.disabled = false;
            setTimeout(()=>tableStatus.textContent='', 2500);
          }
        };
      });
    }

    // Bulk lock/unlock (PostgREST requires a WHERE clause)
    async function unlockAll(){
      unlockAllBtn.disabled = true; lockAllBtn.disabled = true;
      tableStatus.textContent = 'Unlocking all…';
      try{
        const { error } = await sb
          .from('assessments')
          .update({ locked:false })
          .not('id','is', null); // matches all rows
        if(error) throw error;
        const updated = await loadAssessments();
        renderAssessments(updated);
        tableStatus.textContent = 'All assessments unlocked.';
      }catch(e){
        tableStatus.textContent = 'Unlock all failed: ' + (e?.message || e);
      }finally{
        unlockAllBtn.disabled = false; lockAllBtn.disabled = false;
        setTimeout(()=>tableStatus.textContent='', 2500);
      }
    }
    async function lockAll(){
      unlockAllBtn.disabled = true; lockAllBtn.disabled = true;
      tableStatus.textContent = 'Locking all…';
      try{
        const { error } = await sb
          .from('assessments')
          .update({ locked:true })
          .not('id','is', null); // matches all rows
        if(error) throw error;
        const updated = await loadAssessments();
        renderAssessments(updated);
        tableStatus.textContent = 'All assessments locked.';
      }catch(e){
        tableStatus.textContent = 'Lock all failed: ' + (e?.message || e);
      }finally{
        unlockAllBtn.disabled = false; lockAllBtn.disabled = false;
        setTimeout(()=>tableStatus.textContent='', 2500);
      }
    }

    // Notifications
    function severityPillClass(sev){
      if(sev === 'danger') return 'error';
      if(sev === 'warning') return 'info';
      return 'success';
    }
    async function publishNotification(){
      const msg = notifMsg.value.trim();
      if(!msg){ alert('Enter a message.'); return; }
      const sev = notifSeverity.value || 'info';
      const sUtc = istLocalToUTC(notifStartIst.value);
      const eUtc = istLocalToUTC(notifEndIst.value);
      notifStatus.textContent = 'Publishing…';
      try{
        const { error } = await sb.from('portal_notifications').insert([{
          message: msg, severity: sev, active: true,
          starts_at: sUtc, ends_at: eUtc
        }]);
        if(error){
          if(String(error?.code) === '42P01'){ notifSetupHint.style.display = 'block'; }
          throw error;
        }
        notifMsg.value = ''; notifStartIst.value = ''; notifEndIst.value = '';
        await loadNotifications();
        notifStatus.textContent = 'Published.';
      } catch(e){
        notifStatus.textContent = 'Publish failed.';
        alert('Publish failed: ' + (e?.message || e));
      }
    }
    async function loadNotifications(){
      notifList.innerHTML = '<div class="muted">Loading…</div>';
      try{
        const { data, error } = await sb.from('portal_notifications')
          .select('id,message,severity,active,starts_at,ends_at,created_at')
          .order('created_at', { ascending:false })
          .limit(25);
        if(error){
          if(String(error?.code) === '42P01'){ notifSetupHint.style.display = 'block'; }
          throw error;
        }
        // render
        notifList.innerHTML = '';
        (data||[]).forEach(n=>{
          const el = document.createElement('div');
          el.className = 'item';
          el.innerHTML = `
            <div class="row" style="justify-content:space-between;">
              <div>
                <span class="pill ${severityPillClass(n.severity)}">${n.severity}</span>
                <span class="${n.active ? 'ok':'warn-text'}" style="margin-left:6px;">${n.active?'Active':'Inactive'}</span>
                <span class="muted" style="margin-left:8px;">${new Date(n.created_at).toLocaleString()}</span>
              </div>
              <div class="row">
                <button class="btn small ghost" data-action="toggle" data-id="${n.id}">${n.active?'Deactivate':'Activate'}</button>
                <button class="btn small warn" data-action="delete" data-id="${n.id}">Delete</button>
              </div>
            </div>
            <div style="margin-top:6px;">${n.message}</div>
          `;
          notifList.appendChild(el);
        });

        notifList.querySelectorAll('button[data-action="toggle"]').forEach(b=>{
          b.onclick = async () => {
            const id = b.getAttribute('data-id');
            const row = (data||[]).find(x=>String(x.id)===String(id));
            const { error } = await sb.from('portal_notifications').update({ active: !row.active }).eq('id', id);
            if(error) return alert(error.message);
            loadNotifications();
          };
        });
        notifList.querySelectorAll('button[data-action="delete"]').forEach(b=>{
          b.onclick = async () => {
            const id = b.getAttribute('data-id');
            if(!confirm('Delete this notification?')) return;
            const { error } = await sb.from('portal_notifications').delete().eq('id', id);
            if(error) return alert(error.message);
            loadNotifications();
          };
        });

      } catch(e){
        notifList.innerHTML = '<div class="muted">Failed to load notifications.</div>';
        console.warn('loadNotifications', e);
      }
    }

    // Chat
    function renderMsg(m){
      const me = m.sender_id === currentUser?.id;
      const wrap = document.createElement('div');
      wrap.className = 'chat-line';
      wrap.innerHTML = `
        <div class="msg ${me?'me':'them'}">
          <div style="font-size:12px; color:#0d47a1; font-weight:600;">${m.sender_name || (me?'You':'User')}</div>
          <div>${(m.message || '').replace(/</g,'&lt;')}</div>
          <div class="time">${new Date(m.created_at).toLocaleString()}</div>
        </div>`;
      chatBox.appendChild(wrap);
    }
    async function loadChat(room){
      chatBox.innerHTML = '';
      try{
        const { data, error } = await sb.from('portal_chat')
          .select('id,room,sender_id,sender_name,role,message,created_at')
          .eq('room', room)
          .order('created_at', { ascending:true })
          .limit(200);
        if(error){
          if(String(error?.code) === '42P01'){ chatSetupHint.style.display = 'block'; }
          throw error;
        }
        chatSetupHint.style.display = 'none';
        (data||[]).forEach(renderMsg);
        chatBox.scrollTop = chatBox.scrollHeight;
      } catch(e){
        console.warn('loadChat', e);
      }
    }
    function subscribeChat(room){
      const ch = sb.channel('portal_chat_room_'+room)
        .on('postgres_changes', { event:'INSERT', schema:'public', table:'portal_chat', filter: 'room=eq.'+room }, payload => {
          renderMsg(payload.new);
          chatBox.scrollTop = chatBox.scrollHeight;
        })
        .subscribe(status => {
          chatStatus.textContent = status === 'SUBSCRIBED' ? 'Live' : ('Status: ' + status);
        });
      return ch;
    }
    async function sendChat(){
      const txt = chatInput.value.trim();
      if(!txt) return;
      const room = chatRoom.value || 'global';
      chatInput.value = '';
      const { data:prof } = await sb.from('profiles').select('name,role').eq('id', currentUser.id).maybeSingle();
      const senderName = prof?.name || currentUser.email || 'Admin';
      const role = 'admin';
      const { error } = await sb.from('portal_chat').insert([{
        room, sender_id: currentUser.id, sender_name: senderName, role, message: txt
      }]);
      if(error){
        if(String(error?.code) === '42P01'){ chatSetupHint.style.display = 'block'; }
        alert('Send failed: '+error.message);
      }
    }

    // Init
    async function init(){
      setStatus('Checking admin…');
      if(!(await requireAdmin())) return;
      setStatus('Loading data…');

      // Users
      await listStudents();
      userRefresh.onclick = listStudents;
      userSearch.addEventListener('keydown', (e)=>{ if(e.key==='Enter') listStudents(); });
      userCreate.onclick = createStudent;

      // Assessments
      const rows = await loadAssessments();
      renderAssessments(rows);
      unlockAllBtn.onclick = unlockAll;
      lockAllBtn.onclick = lockAll;

      // Notifications
      notifPublishBtn.onclick = publishNotification;
      await loadNotifications();

      // Chat
      const defaultRoom = 'global';
      await loadChat(defaultRoom);
      subscribeChat(defaultRoom);
      chatSend.onclick = sendChat;
      chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });
      chatRoom.onchange = async () => {
        const room = chatRoom.value || 'global';
        await loadChat(room);
        subscribeChat(room);
      };

      setStatus('Ready.');
    }
    init();
  </script>
</body>
</html>
