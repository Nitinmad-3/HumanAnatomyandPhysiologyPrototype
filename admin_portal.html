<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Portal | Human Anatomy & Physiology Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Base */
    :root{
      --th-bg:#f0f6ff;
      --th-fg:#1565c0;
      --th-pad-y:8px;
      --th-pad-x:6px;

      /* Actions header/body grid sizing (space-optimized) */
      --grid-col-min:120px;
      --grid-gap-x:8px;
      --grid-gap-y:2px;

      /* Make Actions header text look like normal th labels */
      --head-font-size:14px;
      --head-font-weight:700;
    }
    *{ box-sizing:border-box; }
    body { font-family:'Segoe UI',Arial,sans-serif; margin:0; color:#222; background:#f6f9ff; }
    header { padding:1rem; background:#e3f2fd; border-bottom:1px solid #cfe0ff; }
    header .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    header a { color:#1565c0; text-decoration:none; font-weight:600; }
    h1 { margin:0; font-size:1.4rem; color:#0d47a1; }
    main { max-width:1100px; margin:18px auto; padding:0 12px 24px; display:flex; flex-direction:column; gap:14px; }
    .panel { background:#fff; border:1px solid #cfe0ff; border-radius:10px; padding:14px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .muted { color:#375a9e; font-size:.95rem; }
    .badge { display:inline-block; font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid #cfe0ff; color:#375a9e; }
    label { font-size:13px; color:#0d47a1; font-weight:600; display:inline-block; margin-bottom:4px; }
    .input, select, textarea, input[type="datetime-local"] { width:100%; padding:10px; border:1px solid #cfe0ff; border-radius:8px; background:#fff; }
    .btn { background:#1565c0; color:#fff; border:0; padding:9px 12px; border-radius:8px; cursor:pointer; font-size:14px; }
    .btn.ghost { background:transparent; color:#1565c0; border:1px solid #cfe0ff; }
    .btn.warn { background:#c62828; color:#fff; }
    .btn.small { padding:6px 10px; font-size:12px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:10px; }
    .hint { font-size:12px; color:#6b84c7; }
    .ok { color:#1b5e20; font-weight:600; }
    .warn-text { color:#c62828; font-weight:600; }
    .list { display:flex; flex-direction:column; gap:8px; }
    .item { border:1px dashed #d4e4ff; border-radius:8px; padding:8px; background:#f9fbff; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; min-width:90px; text-align:center; }
    .pill.success { background:#e8f5e9; color:#1b5e20; border:1px solid #a5d6a7; }
    .pill.error { background:#ffebee; color:#c62828; border:1px solid #ef9a9a; }
    .pill.info { background:#e3f2fd; color:#1565c0; border:1px solid #bbdefb; }
    textarea { min-height:80px; }

    /* Users Tables */
    table { width:100%; border-collapse:collapse; table-layout:auto; }
    th, td { border-bottom:1px dashed #cfe0ff; padding:var(--th-pad-y) var(--th-pad-x); text-align:left; font-size:14px; vertical-align:top; }
    th { background:var(--th-bg); color:var(--th-fg); white-space:nowrap; }
    .lock-on { color:#2e7d32; font-weight:700; }
    .lock-off { color:#c62828; font-weight:700; }
    .chip { display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; border:1px solid #cfe0ff; }
    .chip.approved { background:#e8f5e9; color:#1b5e20; }
    .chip.pending { background:#fff8e1; color:#e65100; }
    .chip.active { background:#e3f2fd; color:#1565c0; }
    .chip.inactive { background:#ffebee; color:#c62828; }

    /* Assessments table */
    .assess-table { width:100%; border-collapse:collapse; margin-top:8px; }
    .assess-table th, .assess-table td { border-bottom:1px dashed #cfe0ff; padding:var(--th-pad-y) var(--th-pad-x); text-align:left; font-size:14px; }
    .assess-table th { background:var(--th-bg); color:var(--th-fg); }
    .btn.all { font-size:15px; font-weight:600; margin:0 8px 8px 0; }

    /* Actions header ribbon (now styled like normal th text) */
    .actions-th { min-width: 460px; padding-top:var(--th-pad-y); padding-bottom:var(--th-pad-y); }
    .actions-head-grid {
      display:grid;
      gap:var(--grid-gap-y) var(--grid-gap-x);
      align-items:center;
    }
    .actions-head-grid.cols-4 { grid-template-columns: repeat(4, minmax(var(--grid-col-min), 1fr)); }
    .actions-head-grid.cols-5 { grid-template-columns: repeat(5, minmax(var(--grid-col-min), 1fr)); }
    .head-pill {
      /* Match th style (no teal pill) */
      background:transparent;
      color:var(--th-fg);
      border:0;
      border-radius:0;
      padding:0;
      text-align:center;
      font-weight:var(--head-font-weight);
      font-size:var(--head-font-size);
      line-height:1.1;
      white-space:nowrap;
    }

    /* Actions body grid (aligns with header ribbon) */
    .actions-cell { min-width: 460px; }
    .actions-cell .action-grid {
      display:grid;
      gap:var(--grid-gap-y) var(--grid-gap-x);
      align-items:start;
    }
    .actions-cell .action-grid.cols-4 { grid-template-columns: repeat(4, minmax(var(--grid-col-min), 1fr)); }
    .actions-cell .action-grid.cols-5 { grid-template-columns: repeat(5, minmax(var(--grid-col-min), 1fr)); }
    .actions-cell .action-buttons {
      display:flex;
      justify-content:center;
      flex-wrap:wrap;
      gap:6px;
      padding-top:2px;
      border-right:1px solid #d4e4ff;
      min-height:30px;
    }
    .actions-cell .action-buttons:last-child { border-right:0; }

    /* Responsive */
    @media (max-width: 900px) {
      .actions-th, .actions-cell { min-width: 0; }
      .actions-head-grid.cols-4, .actions-head-grid.cols-5,
      .actions-cell .action-grid.cols-4, .actions-cell .action-grid.cols-5 {
        grid-template-columns: repeat(2, minmax(var(--grid-col-min), 1fr));
      }
    }
    @media (max-width: 520px) {
      .actions-head-grid.cols-4, .actions-head-grid.cols-5,
      .actions-cell .action-grid.cols-4, .actions-cell .action-grid.cols-5 {
        grid-template-columns: 1fr;
      }
      .actions-cell .action-buttons { border-right:0; }
    }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <a href="index.html">← Home</a>
      <h1>Admin Portal</h1>
      <span id="role-badge" class="badge">Checking role…</span>
      <span id="status" class="muted" role="status" aria-live="polite" style="margin-left:auto">Initializing…</span>
    </div>
  </header>

  <main>
    <!-- Users: Pending Approval + Approved Students -->
    <section class="panel" id="users-panel">
      <h2 class="section-title">Users</h2>
      <div class="grid">
        <div>
          <label for="user-search">Search</label>
          <input id="user-search" class="input" placeholder="name, email, PRN, batch" />
        </div>
        <div class="row" style="align-items:flex-end;">
          <button id="user-refresh" class="btn">Refresh</button>
          <span id="users-status" class="muted" role="status" aria-live="polite"></span>
        </div>
      </div>

      <!-- Pending approvals -->
      <div style="margin-top:14px;">
        <div class="row" style="justify-content:space-between;">
          <h3 class="section-title" style="margin:0;">Pending Approvals</h3>
          <span id="count-pending" class="badge">0</span>
        </div>
        <div style="overflow:auto; max-height:40vh; margin-top:8px;">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>PRN</th>
                <th>Batch</th>
                <th>Email</th>
                <th>Status</th>
                <th>Profile Editing</th>
                <th class="actions-th">
                  <div class="actions-head-grid cols-5" aria-label="Actions ribbon headers">
                    <div class="head-pill">Approval</div>
                    <div class="head-pill">Activate/Deactivate</div>
                    <div class="head-pill">Profile</div>
                    <div class="head-pill">Export Data</div>
                    <div class="head-pill">Delete Permanently</div>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody id="pending-tbody">
              <tr><td colspan="7" class="muted">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Approved students -->
      <div style="margin-top:18px;">
        <div class="row" style="justify-content:space-between;">
          <h3 class="section-title" style="margin:0;">Approved Students</h3>
          <span id="count-approved" class="badge">0</span>
        </div>
        <div style="overflow:auto; max-height:40vh; margin-top:8px;">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>PRN</th>
                <th>Batch</th>
                <th>Email</th>
                <th>Status</th>
                <th>Profile Editing</th>
                <th class="actions-th">
                  <div class="actions-head-grid cols-4" aria-label="Actions ribbon headers">
                    <div class="head-pill">Activate/Deactivate</div>
                    <div class="head-pill">Profile</div>
                    <div class="head-pill">Export Data</div>
                    <div class="head-pill">Delete Permanently</div>
                  </div>
                </th>
              </tr>
            </thead>
            <tbody id="approved-tbody">
              <tr><td colspan="7" class="muted">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="users-setup-hint" class="hint" style="display:none; margin-top:6px;">
        If listing fails, ensure RLS allows admin to SELECT profiles.
      </div>
    </section>

    <!-- Assessment Lock & Schedule -->
    <section class="panel" aria-labelledby="assess-table-title">
      <h2 id="assess-table-title" class="section-title">Assessment Lock & Schedule</h2>
      <div class="row" style="margin-bottom:12px;">
        <button id="unlock-all-btn" class="btn all">Unlock All</button>
        <button id="lock-all-btn" class="btn all warn">Lock All</button>
        <span id="table-status" class="muted" style="margin-left:10px;"></span>
      </div>
      <div style="overflow:auto; max-height:65vh;">
        <table class="assess-table" id="assess-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Locked?</th>
              <th>Status</th>
              <th>Start (IST)</th>
              <th>Deadline (IST)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="assess-tbody">
            <tr><td colspan="7" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
      <div id="assess-table-hint" class="hint" style="margin-top:8px; display:none;">
        No rows found in public.assessments.
      </div>
    </section>

    <!-- Notifications -->
    <section class="panel" aria-labelledby="notif-title">
      <h2 id="notif-title" class="section-title">Notifications (Flash on Home)</h2>
      <div class="grid">
        <div>
          <label for="notif-message">Message</label>
          <textarea id="notif-message" class="input" placeholder="Short notice shown to all users on Home"></textarea>
        </div>
        <div>
          <label for="notif-severity">Severity</label>
          <select id="notif-severity" class="input">
            <option value="info">Info (blue)</option>
            <option value="warning">Warning (amber)</option>
            <option value="danger">Danger (red)</option>
          </select>
        </div>
        <div>
          <label for="notif-start-ist">Starts (Local)</label>
          <input type="datetime-local" id="notif-start-ist" class="input" />
        </div>
        <div>
          <label for="notif-end-ist">Ends (Local)</label>
          <input type="datetime-local" id="notif-end-ist" class="input" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="publish-notif" class="btn">Publish Notification</button>
        <span id="notif-status" class="status" role="status" aria-live="polite"></span>
      </div>
      <div class="divider"></div>
      <div class="list" id="notif-list" aria-live="polite"></div>
      <div id="notif-setup-hint" class="hint" style="margin-top:8px; display:none;">
        Backend table missing. Run setup for portal_notifications.
      </div>
    </section>
  </main>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

  <script>
    // Supabase init (anon key)
    const sb = window.supabase.createClient(
      'https://hunlistfklwvpivfjmbk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bmxpc3Rma2x3dnBpdmZqbWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzA1NDUsImV4cCI6MjA3MzQwNjU0NX0.e-o_qL1Uf5DpW4gX60ktXyuUXmw5YWhqaw6Cx8Xc8Qs'
    );

    // Edge Function slug for server export (current deployed slug)
    const EXPORT_FN = 'SERVICE_ROLE_KEY';

    const $ = s => document.querySelector(s);
    const statusEl = $('#status');
    const roleBadge = $('#role-badge');

    // Users
    const userSearch = $('#user-search');
    const userRefresh = $('#user-refresh');
    const usersStatus = $('#users-status');
    const usersSetupHint = $('#users-setup-hint');

    const pendingTbody = $('#pending-tbody');
    const approvedTbody = $('#approved-tbody');
    const countPending = $('#count-pending');
    const countApproved = $('#count-approved');

    // Assessments table
    const assessTbody = $('#assess-tbody');
    const assessTableHint = $('#assess-table-hint');
    const unlockAllBtn = $('#unlock-all-btn');
    const lockAllBtn = $('#lock-all-btn');
    const tableStatus = $('#table-status');
    let allAssessRows = [];

    // Notifications
    const notifMsg = $('#notif-message');
    const notifSeverity = $('#notif-severity');
    const notifStartIst = $('#notif-start-ist');
    const notifEndIst = $('#notif-end-ist');
    const notifPublishBtn = $('#publish-notif');
    const notifStatus = $('#notif-status');
    const notifList = $('#notif-list');
    const notifSetupHint = $('#notif-setup-hint');

    let currentUser = null;

    // Helpers
    function pad(n){ return String(n).padStart(2,'0'); }
    function istLocalToUTC(dtLocal){
      if(!dtLocal) return null;
      const [d,t] = dtLocal.split('T');
      const [y,m,day] = d.split('-').map(Number);
      const [hh,mm] = (t||'00:00').split(':').map(Number);
      const local = new Date(y, (m||1)-1, day||1, hh||0, mm||0, 0, 0);
      return local.toISOString();
    }
    function utcToIstDatetimeLocal(utcStr){
      if(!utcStr) return '';
      const d = new Date(utcStr);
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function stateForRow(row){
      if(row.locked) return 'locked';
      const now = Date.now();
      const s = row.window_start ? new Date(row.window_start).getTime() : null;
      const e = row.window_end ? new Date(row.window_end).getTime() : null;
      if(s && now < s) return 'upcoming';
      if(e && now > e) return 'closed';
      return 'open';
    }
    function pillClass(state){
      if(state==='open') return 'pill success';
      if(state==='upcoming') return 'pill info';
      if(state==='closed') return 'pill error';
      return 'pill error';
    }
    function setStatus(msg){ statusEl.textContent = msg; }
    function htmlesc(s){ return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

    async function requireAdmin(){
      const { data:{ session } } = await sb.auth.getSession();
      if(!session?.user){
        window.location.replace('login_Version4.html');
        return false;
      }
      currentUser = session.user;
      const { data } = await sb.from('profiles').select('role').eq('id', currentUser.id).maybeSingle();
      const role = (data?.role || '').toLowerCase();
      const isAdmin = role === 'admin';
      roleBadge.textContent = isAdmin ? 'Admin' : 'Student';
      if(!isAdmin){
        roleBadge.classList.add('danger');
        alert('Admin only. Redirecting home.');
        window.location.replace('index.html');
        return false;
      }
      return true;
    }

    // USERS — Queries
    function buildSearchOr(search){
      return search
        ? `name.ilike.%${search}%,email.ilike.%${search}%,prn.ilike.%${search}%,batch.ilike.%${search}%`
        : null;
    }
    async function listPendingStudents(){
      const search = (userSearch?.value || '').trim();
      const orFilter = buildSearchOr(search);
      let q = sb.from('profiles')
        .select('id,name,prn,batch,role,email,profile_edit_locked,approved,active,approved_at,approved_by')
        .eq('role','student')
        .eq('approved', false)
        .order('created_at', { ascending:true });
      if(orFilter) q = q.or(orFilter);
      const { data, error } = await q;
      if(error) throw error;
      return data || [];
    }
    async function listApprovedStudents(){
      const search = (userSearch?.value || '').trim();
      const orFilter = buildSearchOr(search);
      let q = sb.from('profiles')
        .select('id,name,prn,batch,role,email,profile_edit_locked,approved,active,approved_at,approved_by')
        .eq('role','student')
        .eq('approved', true)
        .order('name', { ascending:true });
      if(orFilter) q = q.or(orFilter);
      const { data, error } = await q;
      if(error) throw error;
      return data || [];
    }

    // USERS — Actions (RPCs)
    async function approveUser(id){
      usersStatus.textContent = 'Approving…';
      try{
        const { error } = await sb.rpc('admin_set_user_approved', {
          target_user: id,
          is_approved: true,
          reason: null
        });
        if(error) throw error;
        await refreshUsers();
      }catch(e){
        alert('Approve failed: ' + (e?.message || e));
      }finally{
        usersStatus.textContent = '';
      }
    }
    async function deactivateUser(id){
      const reason = prompt('Deactivation reason (optional):','');
      usersStatus.textContent = 'Deactivating…';
      try{
        const { error } = await sb.rpc('admin_set_user_active', {
          target_user: id,
          make_active: false,
          reason
        });
        if(error) throw error;
        await refreshUsers();
      }catch(e){
        alert('Deactivate failed: ' + (e?.message || e));
      }finally{
        usersStatus.textContent = '';
      }
    }
    async function activateUser(id){
      usersStatus.textContent = 'Reactivating…';
      try{
        const { error } = await sb.rpc('admin_set_user_active', {
          target_user: id,
          make_active: true,
          reason: null
        });
        if(error) throw error;
        await refreshUsers();
      }catch(e){
        alert('Activate failed: ' + (e?.message || e));
      }finally{
        usersStatus.textContent = '';
      }
    }
    async function toggleProfileLock(id, currentLocked){
      usersStatus.textContent = 'Updating…';
      try{
        const { error } = await sb.from('profiles')
          .update({ profile_edit_locked: !currentLocked })
          .eq('id', id);
        if(error) throw error;
        await refreshUsers();
      }catch(e){
        alert('Update failed: ' + (e?.message || e));
      }finally{
        usersStatus.textContent = '';
      }
    }

    // Export (server) via Edge Function (disables button during request)
    async function exportUserResultsServer(userId){
      usersStatus.textContent = 'Exporting (server)…';
      try{
        const { data: { session } } = await sb.auth.getSession();
        if(!session?.access_token){
          alert('Not signed in. Please log in again.');
          return;
        }
        const { data, error } = await sb.functions.invoke(EXPORT_FN, {
          headers: { Authorization: `Bearer ${session.access_token}` },
          body: { user_id: userId }
        });
        if(error) throw error;
        const s = data?.files?.summary?.url;
        const d = data?.files?.details?.url;
        if(!s && !d){ alert('Export ready, but URLs are missing.'); return; }
        if(s) window.open(s, '_blank');
        if(d) window.open(d, '_blank');
      }catch(e){
        alert('Server export failed: ' + (e?.message || e));
      }finally{
        usersStatus.textContent = '';
      }
    }

    // USERS — Renderers (buttons aligned under header ribbon)
    function renderStatusChips(row){
      const chips = [];
      chips.push(row.approved ? '<span class="chip approved">Approved</span>' : '<span class="chip pending">Pending</span>');
      chips.push(row.active ? '<span class="chip active">Active</span>' : '<span class="chip inactive">Inactive</span>');
      return chips.join(' ');
    }

    function renderPending(rows){
      countPending.textContent = rows.length;
      if(!rows.length){
        pendingTbody.innerHTML = '<tr><td colspan="7" class="muted">No pending students.</td></tr>';
        return;
      }
      pendingTbody.innerHTML = rows.map(r=>{
        const lockTxt = r.profile_edit_locked ? '<span class="lock-on">Locked</span>' : '<span class="lock-off">Editable</span>';
        const btnLabel = r.profile_edit_locked ? 'Unlock' : 'Lock';
        return `<tr data-id="${r.id}">
          <td>${htmlesc(r.name || '')}</td>
          <td>${htmlesc(r.prn || '')}</td>
          <td>${htmlesc(r.batch || '')}</td>
          <td data-email="${htmlesc(r.email || '')}">${htmlesc(r.email || '')}</td>
          <td>${renderStatusChips(r)}</td>
          <td>${lockTxt}</td>
          <td class="actions-cell">
            <div class="action-grid cols-5">
              <div class="action-buttons">
                <button class="btn small" data-act="approve" title="Approve this student">Approve</button>
              </div>
              <div class="action-buttons">
                <button class="btn small warn" data-act="deactivate" title="Deactivate account" ${r.active ? '' : 'disabled'}>Deactivate</button>
                <button class="btn small" data-act="activate" title="Reactivate account" ${r.active ? 'disabled' : ''}>Activate</button>
              </div>
              <div class="action-buttons">
                <button class="btn small ghost" data-act="toggle" title="Toggle profile edit lock">${btnLabel}</button>
              </div>
              <div class="action-buttons">
                <button class="btn small ghost" data-act="export-server" title="Generate and download CSVs">Export (Server)</button>
              </div>
              <div class="action-buttons">
                <button class="btn small warn" data-act="delete" title="Permanently delete student and related data">Delete</button>
              </div>
            </div>
          </td>
        </tr>`;
      }).join('');

      // Wire actions
      pendingTbody.querySelectorAll('button[data-act="approve"]').forEach(b=>{
        b.onclick = () => approveUser(b.closest('tr').getAttribute('data-id'));
      });
      pendingTbody.querySelectorAll('button[data-act="deactivate"]').forEach(b=>{
        b.onclick = () => deactivateUser(b.closest('tr').getAttribute('data-id'));
      });
      pendingTbody.querySelectorAll('button[data-act="activate"]').forEach(b=>{
        b.onclick = () => activateUser(b.closest('tr').getAttribute('data-id'));
      });
      pendingTbody.querySelectorAll('button[data-act="toggle"]').forEach(b=>{
        b.onclick = () => {
          const tr = b.closest('tr');
          const lockedNow = !!tr.querySelector('.lock-on');
          toggleProfileLock(tr.getAttribute('data-id'), lockedNow);
        };
      });
      pendingTbody.querySelectorAll('button[data-act="export-server"]').forEach(b=>{
        b.onclick = async () => {
          const tr = b.closest('tr');
          b.disabled = true;
          try { await exportUserResultsServer(tr.getAttribute('data-id')); }
          finally { setTimeout(()=>{ b.disabled = false; }, 800); }
        };
      });
      pendingTbody.querySelectorAll('button[data-act="delete"]').forEach(b=>{
        b.onclick = () => deleteStudentPermanently(b.closest('tr').getAttribute('data-id'));
      });
    }

    function renderApproved(rows){
      countApproved.textContent = rows.length;
      if(!rows.length){
        approvedTbody.innerHTML = '<tr><td colspan="7" class="muted">No approved students.</td></tr>';
        return;
      }
      approvedTbody.innerHTML = rows.map(r=>{
        const lockTxt = r.profile_edit_locked ? '<span class="lock-on">Locked</span>' : '<span class="lock-off">Editable</span>';
        const btnLabel = r.profile_edit_locked ? 'Unlock' : 'Lock';
        return `<tr data-id="${r.id}">
          <td>${htmlesc(r.name || '')}</td>
          <td>${htmlesc(r.prn || '')}</td>
          <td>${htmlesc(r.batch || '')}</td>
          <td data-email="${htmlesc(r.email || '')}">${htmlesc(r.email || '')}</td>
          <td>${renderStatusChips(r)}</td>
          <td>${lockTxt}</td>
          <td class="actions-cell">
            <div class="action-grid cols-4">
              <div class="action-buttons">
                <button class="btn small warn" data-act="deactivate" title="Deactivate account" ${r.active ? '' : 'disabled'}>Deactivate</button>
                <button class="btn small" data-act="activate" title="Reactivate account" ${r.active ? 'disabled' : ''}>Activate</button>
              </div>
              <div class="action-buttons">
                <button class="btn small ghost" data-act="toggle" title="Toggle profile edit lock">${btnLabel}</button>
              </div>
              <div class="action-buttons">
                <button class="btn small ghost" data-act="export-server" title="Generate and download CSVs">Export (Server)</button>
              </div>
              <div class="action-buttons">
                <button class="btn small warn" data-act="delete" title="Permanently delete student and related data">Delete</button>
              </div>
            </div>
          </td>
        </tr>`;
      }).join('');

      // Wire actions
      approvedTbody.querySelectorAll('button[data-act="deactivate"]').forEach(b=>{
        b.onclick = () => deactivateUser(b.closest('tr').getAttribute('data-id'));
      });
      approvedTbody.querySelectorAll('button[data-act="activate"]').forEach(b=>{
        b.onclick = () => activateUser(b.closest('tr').getAttribute('data-id'));
      });
      approvedTbody.querySelectorAll('button[data-act="toggle"]').forEach(b=>{
        b.onclick = () => {
          const tr = b.closest('tr');
          const lockedNow = !!tr.querySelector('.lock-on');
          toggleProfileLock(tr.getAttribute('data-id'), lockedNow);
        };
      });
      approvedTbody.querySelectorAll('button[data-act="export-server"]').forEach(b=>{
        b.onclick = async () => {
          const tr = b.closest('tr');
          b.disabled = true;
          try { await exportUserResultsServer(tr.getAttribute('data-id')); }
          finally { setTimeout(()=>{ b.disabled = false; }, 800); }
        };
      });
      approvedTbody.querySelectorAll('button[data-act="delete"]').forEach(b=>{
        b.onclick = () => deleteStudentPermanently(b.closest('tr').getAttribute('data-id'));
      });
    }

    async function refreshUsers(){
      usersStatus.textContent = 'Loading…';
      try{
        const [pending, approved] = await Promise.all([
          listPendingStudents(),
          listApprovedStudents()
        ]);
        usersSetupHint.style.display='none';
        renderPending(pending);
        renderApproved(approved);
        usersStatus.textContent = '';
      }catch(e){
        console.warn('Users listing failed', e);
        usersStatus.textContent = 'Failed to load.';
        usersSetupHint.style.display='block';
        pendingTbody.innerHTML = '<tr><td colspan="7" class="muted">Failed to load.</td></tr>';
        approvedTbody.innerHTML = '<tr><td colspan="7" class="muted">Failed to load.</td></tr>';
      }
    }

    // Assessments
    async function loadAssessments(){
      const { data, error } = await sb
        .from('assessments')
        .select('*')
        .order('id', { ascending:true });
      if(error){
        console.warn('loadAssessments', error);
        return [];
      }
      return data || [];
    }
    function renderAssessments(rows){
      allAssessRows = rows;
      if(!rows.length){
        assessTbody.innerHTML = '<tr><td colspan="7" class="muted">No assessments found.</td></tr>';
        assessTableHint.style.display='block';
        return;
      }
      assessTableHint.style.display='none';
      assessTbody.innerHTML = rows.map(r=>{
        const state = stateForRow(r);
        return `<tr data-id="${r.id}">
          <td>${r.id}</td>
          <td>${htmlesc(r.title || '')}</td>
          <td>${r.locked ? '<span class="lock-on">Locked</span>' : '<span class="lock-off">Unlocked</span>'}</td>
          <td><span class="${pillClass(state)}">${
            state==='open' ? 'Open to students' :
            state==='upcoming' ? 'Upcoming' :
            state==='closed' ? 'Closed' : 'Locked'
          }</span></td>
          <td><input type="datetime-local" class="input start-input" value="${utcToIstDatetimeLocal(r.window_start)}" /></td>
          <td><input type="datetime-local" class="input end-input" value="${utcToIstDatetimeLocal(r.window_end)}" /></td>
          <td>
            <button class="btn small lock-btn">${r.locked ? 'Unlock' : 'Lock'}</button>
            <button class="btn small ghost save-btn">Save Dates</button>
          </td>
        </tr>`;
      }).join('');

      assessTbody.querySelectorAll('button.lock-btn').forEach(btn=>{
        btn.onclick = async ()=>{
          const tr = btn.closest('tr');
          const id = tr.getAttribute('data-id');
          btn.disabled = true;
          tableStatus.textContent = 'Toggling…';
          try{
            const row = allAssessRows.find(r=>String(r.id)===String(id));
            const newLocked = !row.locked;
            const { error } = await sb.from('assessments').update({ locked: newLocked }).eq('id', id);
            if(error) throw error;
            const updated = await loadAssessments();
            renderAssessments(updated);
            tableStatus.textContent = newLocked ? 'Assessment locked.' : 'Assessment unlocked.';
          }catch(e){
            console.warn('toggle row', e);
            tableStatus.textContent = 'Toggle failed: ' + (e?.message || e);
          }finally{
            btn.disabled = false;
            setTimeout(()=>tableStatus.textContent='', 2500);
          }
        };
      });

      assessTbody.querySelectorAll('button.save-btn').forEach(btn=>{
        btn.onclick = async ()=>{
          const tr = btn.closest('tr');
          const id = tr.getAttribute('data-id');
          const startVal = tr.querySelector('.start-input').value;
          const endVal = tr.querySelector('.end-input').value;
          btn.disabled = true;
          tableStatus.textContent = 'Saving dates…';
          try{
            const payload = {
              window_start: istLocalToUTC(startVal),
              window_end: istLocalToUTC(endVal)
            };
            let { error } = await sb.from('assessments').update(payload).eq('id', id);
            if (error && (String(error.code) === '42703' || /column .*window_end.* does not exist/i.test(error.message || ''))) {
              const { error:err2 } = await sb.from('assessments').update({ window_start: istLocalToUTC(startVal) }).eq('id', id);
              if(err2) throw err2;
            } else if(error){
              throw error;
            }
            const updated = await loadAssessments();
            renderAssessments(updated);
            tableStatus.textContent = 'Dates saved.';
          }catch(e){
            console.warn('save dates', e);
            tableStatus.textContent = 'Save failed: ' + (e?.message || e);
          }finally{
            btn.disabled = false;
            setTimeout(()=>tableStatus.textContent='', 2500);
          }
        };
      });
    }

    // Bulk lock/unlock
    async function unlockAll(){
      unlockAllBtn.disabled = true; lockAllBtn.disabled = true;
      tableStatus.textContent = 'Unlocking all…';
      try{
        const { error } = await sb
          .from('assessments')
          .update({ locked:false })
          .not('id','is', null);
        if(error) throw error;
        const updated = await loadAssessments();
        renderAssessments(updated);
        tableStatus.textContent = 'All assessments unlocked.';
      }catch(e){
        tableStatus.textContent = 'Unlock all failed: ' + (e?.message || e);
      }finally{
        unlockAllBtn.disabled = false; lockAllBtn.disabled = false;
        setTimeout(()=>tableStatus.textContent='', 2500);
      }
    }
    async function lockAll(){
      unlockAllBtn.disabled = true; lockAllBtn.disabled = true;
      tableStatus.textContent = 'Locking all…';
      try{
        const { error } = await sb
          .from('assessments')
          .update({ locked:true })
          .not('id','is', null);
        if(error) throw error;
        const updated = await loadAssessments();
        renderAssessments(updated);
        tableStatus.textContent = 'All assessments locked.';
      }catch(e){
        tableStatus.textContent = 'Lock all failed: ' + (e?.message || e);
      }finally{
        unlockAllBtn.disabled = false; lockAllBtn.disabled = false;
        setTimeout(()=>tableStatus.textContent='', 2500);
      }
    }

    // Notifications
    function severityPillClass(sev){
      if(sev === 'danger') return 'error';
      if(sev === 'warning') return 'info';
      return 'success';
    }
    async function publishNotification(){
      const msg = notifMsg.value.trim();
      if(!msg){ alert('Enter a message.'); return; }
      const sev = notifSeverity.value || 'info';
      const sUtc = istLocalToUTC(notifStartIst.value);
      const eUtc = istLocalToUTC(notifEndIst.value);
      notifStatus.textContent = 'Publishing…';
      try{
        const { error } = await sb.from('portal_notifications').insert([{
          message: msg, severity: sev, active: true, starts_at: sUtc, ends_at: eUtc
        }]);
        if(error){
          if(String(error?.code) === '42P01'){ notifSetupHint.style.display = 'block'; }
          throw error;
        }
        notifMsg.value = ''; notifStartIst.value = ''; notifEndIst.value = '';
        await loadNotifications();
        notifStatus.textContent = 'Published.';
      } catch(e){
        notifStatus.textContent = 'Publish failed.';
        alert('Publish failed: ' + (e?.message || e));
      }
    }
    async function loadNotifications(){
      notifList.innerHTML = '<div class="muted">Loading…</div>';
      try{
        const { data, error } = await sb.from('portal_notifications')
          .select('id,message,severity,active,starts_at,ends_at,created_at')
          .order('created_at', { ascending:false })
          .limit(25);
        if(error){
          if(String(error?.code) === '42P01'){ notifSetupHint.style.display = 'block'; }
          throw error;
        }
        notifList.innerHTML = '';
        (data||[]).forEach(n=>{
          const el = document.createElement('div');
          el.className = 'item';
          el.innerHTML = `
            <div class="row" style="justify-content:space-between;">
              <div>
                <span class="pill ${severityPillClass(n.severity)}">${n.severity}</span>
                <span class="${n.active ? 'ok':'warn-text'}" style="margin-left:6px;">${n.active?'Active':'Inactive'}</span>
                <span class="muted" style="margin-left:8px;">${new Date(n.created_at).toLocaleString()}</span>
              </div>
              <div class="row">
                <button class="btn small ghost" data-action="toggle" data-id="${n.id}">${n.active?'Deactivate':'Activate'}</button>
                <button class="btn small warn" data-action="delete" data-id="${n.id}">Delete</button>
              </div>
            </div>
            <div style="margin-top:6px;">${n.message}</div>
          `;
          notifList.appendChild(el);
        });

        notifList.querySelectorAll('button[data-action="toggle"]').forEach(b=>{
          b.onclick = async () => {
            const id = b.getAttribute('data-id');
            const row = (data||[]).find(x=>String(x.id)===String(id));
            const { error } = await sb.from('portal_notifications').update({ active: !row.active }).eq('id', id);
            if(error) return alert(error.message);
            loadNotifications();
          };
        });
        notifList.querySelectorAll('button[data-action="delete"]').forEach(b=>{
          b.onclick = async () => {
            const id = b.getAttribute('data-id');
            if(!confirm('Delete this notification?')) return;
            const { error } = await sb.from('portal_notifications').delete().eq('id', id);
            if(error) return alert(error.message);
            loadNotifications();
          };
        });

      } catch(e){
        notifList.innerHTML = '<div class="muted">Failed to load notifications.</div>';
        console.warn('loadNotifications', e);
      }
    }

    // Delete — Edge Function (with Authorization header)
    async function deleteStudentPermanently(id){
      if(!id) return;
      if(!confirm('Have you exported this student’s results?\nThis will PERMANENTLY delete the account and related data.')) return;
      usersStatus.textContent = 'Deleting…';
      try{
        const { data: { session } } = await sb.auth.getSession();
        if(!session?.access_token){
          alert('Not signed in. Please log in again.');
          return;
        }
        const { data, error } = await sb.functions.invoke('admin_delete_user', {
          headers: { Authorization: `Bearer ${session.access_token}` },
          body: { user_id: id, delete_storage: true }
        });
        if(error) throw error;
        alert('Student deleted permanently.');
        await refreshUsers();
      }catch(e){
        alert('Delete failed: ' + (e?.message || e));
      }finally{
        usersStatus.textContent = '';
      }
    }

    // Init
    async function init(){
      setStatus('Checking admin…');
      if(!(await requireAdmin())) return;
      setStatus('Loading data…');

      // Users
      await refreshUsers();
      userRefresh.onclick = refreshUsers;
      userSearch.addEventListener('keydown', (e)=>{ if(e.key==='Enter') refreshUsers(); });

      // Assessments
      const rows = await loadAssessments();
      renderAssessments(rows);
      unlockAllBtn.onclick = unlockAll;
      lockAllBtn.onclick = lockAll;

      // Notifications
      notifPublishBtn.onclick = publishNotification;
      await loadNotifications();

      setStatus('Ready.');
    }
    init();
  </script>
</body>
</html>
