<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Portal | Human Anatomy & Physiology Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family:'Segoe UI',Arial,sans-serif; margin:0; color:#222; background:#f6f9ff; }
    header { padding:1rem; background:#e3f2fd; border-bottom:1px solid #cfe0ff; }
    header .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    header a { color:#1565c0; text-decoration:none; font-weight:600; }
    h1 { margin:0; font-size:1.4rem; color:#0d47a1; }
    main { max-width:1100px; margin:18px auto; padding:0 12px 24px; display:flex; flex-direction:column; gap:14px; }
    .panel { background:#fff; border:1px solid #cfe0ff; border-radius:10px; padding:14px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .muted { color:#375a9e; font-size:.95rem; }
    .badge { display:inline-block; font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid #cfe0ff; color:#375a9e; }
    label { font-size:13px; color:#0d47a1; font-weight:600; }
    .input, select, textarea, input[type="datetime-local"] { width:100%; padding:10px; border:1px solid #cfe0ff; border-radius:8px; background:#fff; }
    .btn { background:#1565c0; color:#fff; border:0; padding:9px 12px; border-radius:8px; cursor:pointer; font-size:14px; }
    .btn.ghost { background:transparent; color:#1565c0; border:1px solid #cfe0ff; }
    .btn.warn { background:#c62828; }
    .btn.small { padding:6px 10px; font-size:12px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:10px; }
    .hint { font-size:12px; color:#6b84c7; }
    .ok { color:#1b5e20; font-weight:600; }
    .warn-text { color:#c62828; font-weight:600; }
    .list { display:flex; flex-direction:column; gap:8px; }
    .item { border:1px dashed #d4e4ff; border-radius:8px; padding:8px; background:#f9fbff; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; }
    .pill.success { background:#e8f5e9; color:#1b5e20; border:1px solid #a5d6a7; }
    .pill.error { background:#ffebee; color:#c62828; border:1px solid #ef9a9a; }
    .pill.info { background:#e3f2fd; color:#1565c0; border:1px solid #bbdefb; }
    textarea { min-height:80px; }
    .chat-box { display:flex; flex-direction:column; gap:8px; max-height:420px; overflow:auto; background:#f7f9fe; border:1px solid #d4e4ff; border-radius:8px; padding:8px; }
    .chat-line { display:flex; gap:8px; align-items:flex-start; }
    .me { background:#e8f5e9; }
    .them { background:#fff; }
    .msg { padding:6px 8px; border-radius:8px; border:1px solid #d4e4ff; }
    .time { font-size:11px; color:#6b84c7; }
    .section-title { margin:0 0 10px; color:#0d47a1; }
    .status { font-size:12px; color:#6b84c7; }
    .divider { height:1px; background:#d4e4ff; margin:8px 0; }
    .danger { color:#c62828; }
    @media (max-width:640px){ .grid { grid-template-columns:1fr; } }

    /* Users */
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px dashed #cfe0ff; padding:8px 6px; text-align:left; font-size:14px; }
    th { background:#f0f6ff; color:#1565c0; }
    .lock-on { color:#2e7d32; font-weight:700; }
    .lock-off { color:#c62828; font-weight:700; }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <a href="index.html">← Home</a>
      <h1>Admin Portal</h1>
      <span id="role-badge" class="badge">Checking role…</span>
      <span id="status" class="muted" style="margin-left:auto">Initializing…</span>
    </div>
  </header>

  <main>
    <!-- Users (list, search, add, lock toggle) -->
    <section class="panel" id="users-panel">
      <h2 class="section-title">Users</h2>
      <div class="grid">
        <div>
          <label>Search</label>
          <input id="user-search" class="input" placeholder="name, email, PRN, batch" />
        </div>
        <div class="row" style="align-items:flex-end;">
          <button id="user-refresh" class="btn">Refresh</button>
          <span id="users-status" class="muted"></span>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <details>
          <summary><b>Add Student</b></summary>
          <div class="grid" style="margin-top:8px;">
            <div><label>Email</label><input id="new-email" class="input" type="email" placeholder="student@domain.com" /></div>
            <div><label>Name</label><input id="new-name" class="input" placeholder="Full name" /></div>
            <div><label>PRN</label><input id="new-prn" class="input" placeholder="e.g., 2023-PRN-001" /></div>
            <div><label>Batch</label><input id="new-batch" class="input" placeholder="e.g., B1, 2024" /></div>
          </div>
          <div class="row" style="margin-top:8px;">
            <button id="user-create" class="btn">Create Student</button>
            <span class="hint">Requires Edge Function admin_create_user (service role). Shows hint if not configured.</span>
          </div>
          <div id="user-create-status" class="muted"></div>
        </details>
      </div>

      <div style="overflow:auto; max-height:55vh; margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>PRN</th>
              <th>Batch</th>
              <th>Email</th>
              <th>Role</th>
              <th>Profile Editing</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="users-tbody">
            <tr><td colspan="7" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
      <div id="users-setup-hint" class="hint" style="display:none; margin-top:6px;">
        If emails are blank or listing fails, run sql/user_admin.sql and use the admin_list_students RPC. Also deploy the admin_create_user Edge Function to add users.
      </div>
    </section>

    <!-- Release + Lock Controls -->
    <section class="panel" id="release-panel">
      <h2 class="section-title">Assessment Lock, Release & Deadline</h2>
      <div class="grid">
        <div>
          <label>Assessment</label>
          <select id="exp-select" class="input">
            <option value="">Select an assessment</option>
          </select>
          <div class="hint">Source: list_experiments_for_results or assessments fallback</div>
        </div>
        <div>
          <label>Locked (Block assessment)</label>
          <div class="row">
            <input type="checkbox" id="locked-toggle" />
            <span id="locked-effective" class="pill info">—</span>
          </div>
          <div class="hint">If locked, students cannot see/start this assessment.</div>
        </div>
        <div>
          <label>Released to students</label>
          <div class="row">
            <input type="checkbox" id="released-toggle" />
            <span id="release-effective" class="pill info">—</span>
          </div>
          <div class="hint">Effective release depends on window start/end and "Released".</div>
        </div>
        <div>
          <label>Start (IST)</label>
          <input type="datetime-local" id="start-ist" class="input" />
          <div class="hint">If empty, opens immediately after release.</div>
        </div>
        <div>
          <label>Deadline (IST)</label>
          <input type="datetime-local" id="end-ist" class="input" />
          <div class="hint">If empty, no deadline.</div>
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="save-release" class="btn">Save</button>
        <button id="close-release" class="btn ghost">Close (Unrelease)</button>
        <span id="release-status" class="status"></span>
      </div>
      <div id="release-setup-hint" class="hint" style="margin-top:8px; display:none;">
        Backend table missing. Ensure public.assessments exists.
      </div>
    </section>

    <!-- Notifications -->
    <section class="panel" id="notif-panel">
      <h2 class="section-title">Notifications (Flash on Home)</h2>
      <div class="grid">
        <div>
          <label>Message</label>
          <textarea id="notif-message" class="input" placeholder="Short notice shown to all users on Home"></textarea>
        </div>
        <div>
          <label>Severity</label>
          <select id="notif-severity" class="input">
            <option value="info">Info (blue)</option>
            <option value="warning">Warning (amber)</option>
            <option value="danger">Danger (red)</option>
          </select>
        </div>
        <div>
          <label>Starts (IST)</label>
          <input type="datetime-local" id="notif-start-ist" class="input" />
        </div>
        <div>
          <label>Ends (IST)</label>
          <input type="datetime-local" id="notif-end-ist" class="input" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="publish-notif" class="btn">Publish Notification</button>
        <span id="notif-status" class="status"></span>
      </div>
      <div class="divider"></div>
      <div class="list" id="notif-list"></div>
      <div id="notif-setup-hint" class="hint" style="margin-top:8px; display:none;">
        Backend table missing. Run setup for portal_notifications.
      </div>
    </section>

    <!-- Communication -->
    <section class="panel" id="chat-panel">
      <h2 class="section-title">Communication (Admin ↔ Students)</h2>
      <div class="grid">
        <div>
          <label>Room</label>
          <select id="chat-room" class="input">
            <option value="global">Global</option>
          </select>
          <div class="hint">Pick an assessment to talk in a dedicated room</div>
        </div>
      </div>
      <div id="chat-box" class="chat-box" aria-live="polite"></div>
      <div class="row">
        <input id="chat-input" class="input" placeholder="Type a message…" />
        <button id="chat-send" class="btn">Send</button>
      </div>
      <div id="chat-status" class="status"></div>
      <div id="chat-setup-hint" class="hint" style="margin-top:8px; display:none;">
        Backend table missing. Run setup for portal_chat.
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script>
    // Feature flags to avoid 404 noise while you focus on lock/unlock
    const ENABLE_USERS = true;          // set false to hide Users section
    const ENABLE_NOTIFICATIONS = false; // set true if portal_notifications table exists
    const ENABLE_CHAT = false;          // set true if portal_chat table exists

    // Supabase init (same project as your current app)
    const sb = window.supabase.createClient(
      'https://hunlistfklwvpivfjmbk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bmxpc3Rma2x3dnBpdmZqbWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzA1NDUsImV4cCI6MjA3MzQwNjU0NX0.e-o_qL1Uf5DpW4gX60ktXyuUXmw5YWhqaw6Cx8Xc8Qs'
    );

    const $ = s => document.querySelector(s);
    const statusEl = $('#status');
    const roleBadge = $('#role-badge');

    // Panels for optional features
    const usersPanel = $('#users-panel');
    const notifPanel = $('#notif-panel');
    const chatPanel = $('#chat-panel');

    // Users
    const userSearch = $('#user-search');
    const userRefresh = $('#user-refresh');
    const usersStatus = $('#users-status');
    const usersTbody = $('#users-tbody');
    const usersSetupHint = $('#users-setup-hint');

    const newEmail = $('#new-email');
    const newName = $('#new-name');
    const newPRN = $('#new-prn');
    const newBatch = $('#new-batch');
    const userCreate = $('#user-create');
    const userCreateStatus = $('#user-create-status');

    // Release controls
    const expSelect = $('#exp-select');
    const lockedToggle = $('#locked-toggle');
    const lockedEffective = $('#locked-effective');
    const releasedToggle = $('#released-toggle');
    const releaseEffective = $('#release-effective');
    const startIst = $('#start-ist');
    const endIst = $('#end-ist');
    const saveReleaseBtn = $('#save-release');
    const closeReleaseBtn = $('#close-release');
    const releaseStatus = $('#release-status');
    const releaseSetupHint = $('#release-setup-hint');

    // Notifications
    const notifMsg = $('#notif-message');
    const notifSeverity = $('#notif-severity');
    const notifStartIst = $('#notif-start-ist');
    const notifEndIst = $('#notif-end-ist');
    const notifPublishBtn = $('#publish-notif');
    const notifStatus = $('#notif-status');
    const notifList = $('#notif-list');
    const notifSetupHint = $('#notif-setup-hint');

    // Chat
    const chatRoom = $('#chat-room');
    const chatBox = $('#chat-box');
    const chatInput = $('#chat-input');
    const chatSend = $('#chat-send');
    const chatStatus = $('#chat-status');
    const chatSetupHint = $('#chat-setup-hint');

    let currentUser = null;
    let isAdmin = false;
    let chatSubscription = null;

    // Helpers: IST ⇄ UTC
    function pad(n){ return String(n).padStart(2,'0'); }
    function istLocalToUTC(dtLocal){
      if(!dtLocal) return null; // "YYYY-MM-DDTHH:MM"
      const [d,t] = dtLocal.split('T');
      const [y,m,day] = d.split('-').map(Number);
      const [hh,mm] = (t||'00:00').split(':').map(Number);
      const utcMs = Date.UTC(y, m-1, day, (hh??0)-5, (mm??0)-30, 0, 0); // IST -> UTC
      return new Date(utcMs).toISOString();
    }
    function utcToIstDatetimeLocal(utcStr){
      if(!utcStr) return '';
      const d = new Date(utcStr);
      const istMs = d.getTime() + 5.5*3600000;
      const ist = new Date(istMs);
      return `${ist.getFullYear()}-${pad(ist.getMonth()+1)}-${pad(ist.getDate())}T${pad(ist.getHours())}:${pad(ist.getMinutes())}`;
    }
    function nowUtcISO(){ return new Date().toISOString(); }
    function withinWindow(released, startUtc, endUtc){
      if(!released) return false;
      const now = new Date();
      const start = startUtc ? new Date(startUtc) : null;
      const end = endUtc ? new Date(endUtc) : null;
      if(start && now < start) return false;
      if(end && now > end) return false;
      return true;
    }

    function setStatus(msg){ statusEl.textContent = msg; }
    function setPill(el, ok, text){
      el.textContent = text;
      el.className = 'pill ' + (ok ? 'success' : 'error');
    }
    function htmlesc(s){ return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

    async function requireAdmin(){
      const { data:{ session } } = await sb.auth.getSession();
      if(!session?.user){
        window.location.replace('login_Version4.html');
        return false;
      }
      currentUser = session.user;
      const { data, error } = await sb.from('profiles').select('role').eq('id', currentUser.id).maybeSingle();
      const role = (data?.role || '').toLowerCase();
      isAdmin = role === 'admin';
      roleBadge.textContent = isAdmin ? 'Admin' : 'Student';
      if(!isAdmin){
        roleBadge.classList.add('danger');
        alert('Admin only. Redirecting home.');
        window.location.replace('index.html');
        return false;
      }
      return true;
    }

    // USERS
    async function listStudents(){
      usersStatus.textContent = 'Loading…';
      usersTbody.innerHTML = '<tr><td colspan="7" class="muted">Loading…</td></tr>';
      try{
        // Preferred: RPC joins auth.users (may not exist)
        const search = userSearch?.value?.trim() || null;
        const { data, error } = await sb.rpc('admin_list_students', { search_text: search });
        if(error){
          console.warn('admin_list_students error', error);
          usersSetupHint.style.display='block';
          // Fallback: profiles only (email may be blank)
          const { data:pf, error:pfErr } = await sb.from('profiles')
            .select('id,name,prn,batch,role,email,profile_edit_locked')
            .eq('role','student')
            .order('name');
          if(pfErr){ throw pfErr; }
          renderUsers((pf||[]).map(p => ({ ...p, created_at: null })));
        } else {
          usersSetupHint.style.display='none';
          renderUsers(data || []);
        }
        usersStatus.textContent = '';
      } catch(e){
        console.warn('listStudents failed', e);
        usersStatus.textContent = 'Failed to load.';
        usersTbody.innerHTML = '<tr><td colspan="7" class="muted">Failed.</td></tr>';
      }
    }

    function renderUsers(rows){
      if(!rows?.length){
        usersTbody.innerHTML = '<tr><td colspan="7" class="muted">No students found.</td></tr>';
        return;
      }
      usersTbody.innerHTML = rows.map(r=>{
        const lockTxt = r.profile_edit_locked ? '<span class="lock-on">Locked</span>' : '<span class="lock-off">Editable</span>';
        const btnLabel = r.profile_edit_locked ? 'Unlock' : 'Lock';
        return `<tr data-id="${r.id}">
          <td>${htmlesc(r.name || '')}</td>
          <td>${htmlesc(r.prn || '')}</td>
          <td>${htmlesc(r.batch || '')}</td>
          <td>${htmlesc(r.email || '')}</td>
          <td>${htmlesc(r.role || '')}</td>
          <td>${lockTxt}</td>
          <td><button class="btn small" data-act="toggle">${btnLabel}</button></td>
        </tr>`;
      }).join('');

      usersTbody.querySelectorAll('button[data-act="toggle"]').forEach(btn=>{
        btn.onclick = async ()=>{
          const tr = btn.closest('tr');
          const id = tr.getAttribute('data-id');
          btn.disabled = true;
          usersStatus.textContent = 'Updating…';
          try{
            const lockedNow = !!tr.querySelector('.lock-on');
            const { error } = await sb.from('profiles').update({ profile_edit_locked: !lockedNow }).eq('id', id);
            if(error) throw error;
            await listStudents();
          } catch(e){
            alert('Update failed: ' + (e?.message || e));
          } finally {
            btn.disabled = false;
            usersStatus.textContent = '';
          }
        };
      });
    }

    async function createStudent(){
      const email = newEmail.value.trim();
      const name = newName.value.trim();
      const prn = newPRN.value.trim();
      const batch = newBatch.value.trim();
      if(!email){ return alert('Email is required'); }
      userCreate.disabled = true;
      userCreateStatus.textContent = 'Creating user…';
      try{
        const { data, error } = await sb.functions.invoke('admin_create_user', { body:{ email, name, prn, batch, role:'student' } });
        if(error){ throw error; }
        if(!data?.ok){ throw new Error(data?.error || 'Create failed'); }
        userCreateStatus.textContent = 'Created.';
        newEmail.value = ''; newName.value=''; newPRN.value=''; newBatch.value='';
        await listStudents();
      } catch(e){
        console.warn('createStudent failed', e);
        userCreateStatus.textContent = 'Failed: ' + (e?.message || e));
        alert('Failed: ' + (e?.message || e));
      } finally {
        userCreate.disabled = false;
        setTimeout(()=> userCreateStatus.textContent='', 3000);
      }
    }

    // Load experiments and hydrate selects
    async function loadExperiments(){
      // Try RPC first
      const fromRpc = await sb.rpc('list_experiments_for_results');
      if(!fromRpc.error && Array.isArray(fromRpc.data)){
        buildExperimentOptions(fromRpc.data.map(row => ({
          experiment_id: row.experiment_id || row.experiment || row.id,
          title: row.title || row.experiment_id || row.id
        })));
        return;
      }
      // Fallback: read from assessments
      const { data, error } = await sb.from('assessments')
        .select('experiment_id,title')
        .order('id', { ascending: true });
      if(error){
        console.warn('loadExperiments fallback error', error);
        return;
      }
      buildExperimentOptions((data||[]).map(r => ({
        experiment_id: r.experiment_id,
        title: r.title || r.experiment_id
      })));
    }

    function buildExperimentOptions(rows){
      expSelect.innerHTML = '<option value="">Select an assessment</option>';
      (rows||[]).forEach(row=>{
        if(!row.experiment_id) return;
        const opt = document.createElement('option');
        opt.value = row.experiment_id;
        opt.textContent = row.experiment_id;
        expSelect.appendChild(opt);
      });
    }

    async function loadReleaseFor(expId){
      startIst.value = ''; endIst.value = '';
      releasedToggle.checked = false;
      lockedToggle.checked = false;
      releaseStatus.textContent = 'Loading…';
      try{
        const { data, error } = await sb.from('assessments')
          .select('experiment_id,released,locked,window_start,window_end,updated_at')
          .eq('experiment_id', expId)
          .maybeSingle();

        if(error && String(error?.code) === '42P01'){ // undefined_table
          releaseSetupHint.style.display = 'block';
          releaseStatus.textContent = 'Backend table not found.';
          return;
        }
        releaseSetupHint.style.display = 'none';

        if(!data){
          setPill(releaseEffective, false, 'Not released');
          setPill(lockedEffective, false, 'Unlocked');
          releaseStatus.textContent = 'No record yet.';
          return;
        }
        releasedToggle.checked = !!data.released;
        lockedToggle.checked = !!data.locked;
        startIst.value = utcToIstDatetimeLocal(data.window_start);
        endIst.value = utcToIstDatetimeLocal(data.window_end);

        const effective = withinWindow(!!data.released, data.window_start, data.window_end) && !data.locked;
        setPill(releaseEffective, effective, effective ? 'Open to students' : 'Closed');
        setPill(lockedEffective, !!data.locked, !!data.locked ? 'Locked' : 'Unlocked');
        releaseStatus.textContent = `Updated: ${data.updated_at ? new Date(data.updated_at).toLocaleString() : '—'}`;
      } catch(e){
        console.warn('loadReleaseFor', e);
        releaseStatus.textContent = 'Failed to load.';
      }
    }

    // Save release/lock — use UPDATE (no upsert) to avoid on_conflict errors
    async function saveRelease(){
      const expId = expSelect.value;
      if(!expId){ alert('Select an assessment.'); return; }
      const payload = {
        released: !!releasedToggle.checked,
        locked: !!lockedToggle.checked,
        window_start: istLocalToUTC(startIst.value),
        window_end: istLocalToUTC(endIst.value),
        updated_at: nowUtcISO()
      };
      releaseStatus.textContent = 'Saving…';
      try{
        const { data:exists } = await sb.from('assessments').select('id').eq('experiment_id', expId).maybeSingle();
        if(!exists){
          alert('No row found in assessments for experiment_id=' + expId + '. Please create it first.');
          releaseStatus.textContent = 'Save blocked (row missing).';
          return;
        }
        const { error } = await sb.from('assessments').update(payload).eq('experiment_id', expId);
        if(error){
          if(String(error?.code) === '42P01'){ releaseSetupHint.style.display = 'block'; }
          throw error;
        }
        await loadReleaseFor(expId);
        releaseStatus.textContent = 'Saved.';
      } catch(e){
        console.warn('saveRelease', e);
        releaseStatus.textContent = 'Save failed.';
        alert('Save failed: ' + (e?.message || e));
      }
    }

    async function closeRelease(){
      const expId = expSelect.value;
      if(!expId){ alert('Select an assessment.'); return; }
      releaseStatus.textContent = 'Closing…';
      try{
        const { error } = await sb.from('assessments')
          .update({ released:false, updated_at: nowUtcISO() })
          .eq('experiment_id', expId);
        if(error){
          if(String(error?.code) === '42P01'){ releaseSetupHint.style.display = 'block'; }
          throw error;
        }
        await loadReleaseFor(expId);
        releaseStatus.textContent = 'Closed.';
      } catch(e){
        releaseStatus.textContent = 'Close failed.';
        alert('Close failed: ' + (e?.message || e));
      }
    }

    // Notifications (optional)
    function severityPillClass(sev){
      if(sev === 'danger') return 'error';
      if(sev === 'warning') return 'info';
      return 'success';
    }

    async function publishNotification(){
      const msg = notifMsg.value.trim();
      if(!msg){ alert('Enter a message.'); return; }
      const sev = notifSeverity.value || 'info';
      const sUtc = istLocalToUTC(notifStartIst.value);
      const eUtc = istLocalToUTC(notifEndIst.value);
      notifStatus.textContent = 'Publishing…';
      try{
        const { error } = await sb.from('portal_notifications').insert([{
          message: msg, severity: sev, active: true,
          starts_at: sUtc, ends_at: eUtc, created_by: currentUser.id
        }]);
        if(error){
          if(String(error?.code) === '42P01'){ notifSetupHint.style.display = 'block'; }
          throw error;
        }
        notifMsg.value = ''; notifStartIst.value = ''; notifEndIst.value = '';
        await loadNotifications();
        notifStatus.textContent = 'Published.';
      } catch(e){
        notifStatus.textContent = 'Publish failed.';
        console.warn('publishNotification', e);
        alert('Publish failed: ' + (e?.message || e));
      }
    }

    async function loadNotifications(){
      notifList.innerHTML = '<div class="muted">Loading…</div>';
      try{
        const { data, error } = await sb.from('portal_notifications')
          .select('id,message,severity,active,starts_at,ends_at,created_at')
          .order('created_at', { ascending:false })
          .limit(25);
        if(error){
          if(String(error?.code) === '42P01'){ notifSetupHint.style.display = 'block'; }
          throw error;
        }
        notifSetupHint.style.display = 'none';
        const now = Date.now();
        notifList.innerHTML = '';
        (data||[]).forEach(n=>{
          const activeWindow = (!n.starts_at || new Date(n.starts_at).getTime() <= now) &&
                               (!n.ends_at || new Date(n.ends_at).getTime() >= now);
          const el = document.createElement('div');
          el.className = 'item';
          el.innerHTML = `
            <div class="row" style="justify-content:space-between;">
              <div>
                <span class="pill ${severityPillClass(n.severity)}">${n.severity}</span>
                <span class="${n.active ? 'ok':'warn-text'}" style="margin-left:6px;">${n.active?'Active':'Inactive'}</span>
                <span class="muted" style="margin-left:8px;">${new Date(n.created_at).toLocaleString()}</span>
              </div>
              <div class="row">
                <button class="btn small ghost" data-action="toggle" data-id="${n.id}">${n.active?'Deactivate':'Activate'}</button>
                <button class="btn small warn" data-action="delete" data-id="${n.id}">Delete</button>
              </div>
            </div>
            <div style="margin-top:6px;">${n.message}</div>
            <div class="hint">Window: ${n.starts_at?new Date(n.starts_at).toLocaleString():'—'} → ${n.ends_at?new Date(n.ends_at).toLocaleString():'—'} | In window now: ${activeWindow}</div>
          `;
          notifList.appendChild(el);
        });

        notifList.querySelectorAll('button[data-action="toggle"]').forEach(b=>{
          b.onclick = async () => {
            const id = b.getAttribute('data-id');
            const row = (data||[]).find(x=>String(x.id)===String(id));
            const { error } = await sb.from('portal_notifications').update({ active: !row.active }).eq('id', id);
            if(error) return alert(error.message);
            loadNotifications();
          };
        });
        notifList.querySelectorAll('button[data-action="delete"]').forEach(b=>{
          b.onclick = async () => {
            const id = b.getAttribute('data-id');
            if(!confirm('Delete this notification?')) return;
            const { error } = await sb.from('portal_notifications').delete().eq('id', id);
            if(error) return alert(error.message);
            loadNotifications();
          };
        });

      } catch(e){
        notifList.innerHTML = '<div class="muted">Failed to load notifications.</div>';
        console.warn('loadNotifications', e);
      }
    }

    // Chat (optional)
    function renderMsg(m){
      const me = m.sender_id === currentUser?.id;
      const wrap = document.createElement('div');
      wrap.className = 'chat-line';
      wrap.innerHTML = `
        <div class="msg ${me?'me':'them'}">
          <div style="font-size:12px; color:#0d47a1; font-weight:600;">${m.sender_name || (me?'You':'User')}</div>
          <div>${(m.message || '').replace(/</g,'&lt;')}</div>
          <div class="time">${new Date(m.created_at).toLocaleString()}</div>
        </div>`;
      chatBox.appendChild(wrap);
    }

    async function loadChat(room){
      chatBox.innerHTML = '';
      try{
        const { data, error } = await sb.from('portal_chat')
          .select('id,room,sender_id,sender_name,role,message,created_at')
          .eq('room', room)
          .order('created_at', { ascending:true })
          .limit(200);
        if(error){
          if(String(error?.code) === '42P01'){ chatSetupHint.style.display = 'block'; }
          throw error;
        }
        chatSetupHint.style.display = 'none';
        (data||[]).forEach(renderMsg);
        chatBox.scrollTop = chatBox.scrollHeight;
      } catch(e){
        console.warn('loadChat', e);
      }
    }

    function subscribeChat(room){
      if(chatSubscription){ sb.removeChannel(chatSubscription); chatSubscription = null; }
      chatSubscription = sb.channel('portal_chat_room_'+room)
        .on('postgres_changes', { event:'INSERT', schema:'public', table:'portal_chat', filter: 'room=eq.'+room }, payload => {
          renderMsg(payload.new);
          chatBox.scrollTop = chatBox.scrollHeight;
        })
        .subscribe(status => {
          chatStatus.textContent = status === 'SUBSCRIBED' ? 'Live' : ('Status: ' + status);
        });
    }

    async function sendChat(){
      const txt = chatInput.value.trim();
      if(!txt) return;
      const room = chatRoom.value || 'global';
      chatInput.value = '';
      const { data:prof } = await sb.from('profiles').select('name,role').eq('id', currentUser.id).maybeSingle();
      const senderName = prof?.name || currentUser.email || 'Admin';
      const role = 'admin';
      const { error } = await sb.from('portal_chat').insert([{
        room, sender_id: currentUser.id, sender_name: senderName, role, message: txt
      }]);
      if(error){
        if(String(error?.code) === '42P01'){ chatSetupHint.style.display = 'block'; }
        alert('Send failed: '+error.message);
      }
    }

    // Init
    async function init(){
      // Hide optional panels based on flags
      if(!ENABLE_USERS) usersPanel.style.display = 'none';
      if(!ENABLE_NOTIFICATIONS) notifPanel.style.display = 'none';
      if(!ENABLE_CHAT) chatPanel.style.display = 'none';

      setStatus('Checking admin…');
      if(!(await requireAdmin())) return;
      setStatus('Loading data…');

      // Users
      if(ENABLE_USERS){
        await listStudents();
        userRefresh.onclick = listStudents;
        userSearch?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') listStudents(); });
        userCreate.onclick = createStudent;
      }

      // Releases
      await loadExperiments();

      expSelect.onchange = async () => {
        const expId = expSelect.value;
        if(!expId) return;
        await loadReleaseFor(expId);
      };
      const expParam = new URLSearchParams(location.search).get('exp');
      if(expParam){
        const setLater = () => {
          const opt = Array.from(expSelect.options).find(o => o.value === expParam);
          if(opt){ expSelect.value = expParam; loadReleaseFor(expParam); }
        };
        // options may not be ready immediately if network slow
        setTimeout(setLater, 100);
      }

      saveReleaseBtn.onclick = saveRelease;
      closeReleaseBtn.onclick = closeRelease;

      // Notifications
      if(ENABLE_NOTIFICATIONS){
        notifPublishBtn.onclick = publishNotification;
        await loadNotifications();
      }

      // Chat
      if(ENABLE_CHAT){
        const defaultRoom = 'global';
        await loadChat(defaultRoom);
        subscribeChat(defaultRoom);
        chatSend.onclick = sendChat;
        chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });
        chatRoom.onchange = async () => {
          const room = chatRoom.value || 'global';
          await loadChat(room);
          subscribeChat(room);
        };
      }

      setStatus('Ready.');
    }
    init();
  </script>
</body>
</html>
