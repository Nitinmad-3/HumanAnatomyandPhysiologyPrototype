<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Assessments | Human Anatomy & Physiology</title>
  <link rel="stylesheet" href="style.css">
  <style>
    :root{
      --green:#33691e;
      --green-2:#558b2f;
      --leaf:#c5e1a5;
      --leaf-2:#aed581;
      --ink:#1f2b1f;
      --muted:#5b6f99;
      --chip-bg:#eef7e6;
      --chip-bd:#d7e9c2;
      --warn:#e65100;
      --danger:#b71c1c;
      --shadow:0 6px 24px rgba(28,57,20,.12);
      --shadow-soft:0 2px 10px rgba(28,57,20,.10);
    }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f4c3; margin: 0; color: var(--ink);}
    header { text-align: center; padding: 2rem 1rem 1rem 1rem;}
    h1 { color: var(--green); margin-bottom: .8rem; }
    nav { display: flex; justify-content: center; gap: .75rem; margin-bottom: 1.25rem; flex-wrap:wrap;}
    nav a, nav button {
      color: var(--green-2); font-weight: 700; text-decoration: none;
      background: var(--leaf); padding: 0.55em 1.1em; border-radius: 10px; border: 1px solid #b7d48f;
      cursor: pointer; box-shadow: var(--shadow-soft); transition: transform .04s ease, background .2s ease;
      font-size: 1rem;
    }
    nav a:hover, nav button:hover { background: var(--leaf-2); transform: translateY(-1px); }

    .wrap { max-width: 960px; margin: 0 auto; padding: 0 12px 28px; }

    .assess-card {
      background: #fff; border-radius: 16px; padding: 1.2rem; box-shadow: var(--shadow);
      border: 1px solid #e2f0c2; margin: 0 auto 14px auto;
    }
    .assess-header { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .assess-title { font-size: 1.1rem; font-weight: 800; color: var(--green); }
    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .pill {
      display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:.85rem; font-weight:700;
      border:1px solid var(--chip-bd); background: var(--chip-bg); color: var(--green-2);
    }
    .pill.open { background:#e8f5e9; border-color:#c8e6c9; color:#1b5e20; }
    .pill.upcoming { background:#fff8e1; border-color:#ffe0b2; color:var(--warn); }
    .pill.closed { background:#ffebee; border-color:#ffcdd2; color:var(--danger); }
    .meta { color:#335; font-size:.92rem; }
    .muted { color:#556; font-size:.9rem; }
    .btn {
      border:0; border-radius:10px; padding:.55rem .9rem; font-size:.95rem; font-weight:800; cursor:pointer;
      transition: transform .04s ease, background .2s ease, box-shadow .2s ease; box-shadow: var(--shadow-soft);
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn-primary { background: var(--green-2); color:#fff; }
    .btn-ghost { background:#fff; color: var(--green-2); border:1px solid #b7d48f; }
    .btn:disabled { opacity:.6; cursor:not-allowed; transform:none; }
    .list { display:flex; flex-direction:column; gap:12px; margin-top:10px; }

    #messages { max-width: 960px; margin: 0 auto; padding: 0 12px; }
    .msg {
      font-weight: 700; text-align: center; margin: 1rem auto 0 auto; max-width: 960px;
      padding: 0.9rem 1rem; border-radius: 8px; border: 1px solid transparent;
    }
    #not-logged-in-message { color: #1b5e20; background: #e8f5e9; border-color: #c8e6c9; }
    #access-denied-message, #error-message { color: #b71c1c; background: #ffebee; border-color: #ffcdd2; }
    .hidden { display:none; }

    .tips { margin-top: 10px; color:#435; font-size: .92rem; }
    .time-line { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .time-piece { padding:2px 8px; border-radius:8px; border:1px dashed #dfeacc; background:#f8fff1; font-size:.86rem; color:#2e521b; }
    .admin-tools { margin-left:auto; display:flex; gap:8px; align-items:center; }

    @media (max-width: 640px) {
      .assess-header { align-items:flex-start; }
      nav { gap: .55rem; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Assessment Questions</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="experiments.html">Experiments</a>
      <a id="assessment-tab" href="assessments.html">Assessments</a>
      <a id="results-tab" href="result.html" style="display:none;">Results</a>
      <a href="references.html">References</a>
      <a id="login-btn" href="login_Version4.html" style="display:inline;">Login</a>
      <button id="logout-btn" style="display:none;">Logout</button>
    </nav>
  </header>

  <div id="messages">
    <div id="error-message" class="msg hidden">Unexpected error loading page. Please refresh.</div>
    <div id="not-logged-in-message" class="msg hidden">
      You must be logged in to view assessment questions.<br>
      <a id="login-direct" class="btn btn-primary" href="login_Version4.html" style="margin-top:10px; display:inline-block;">Go to Login Page</a>
    </div>
    <div id="access-denied-message" class="msg hidden">
      Access denied. You are not authorized for this portal.<br>
      <a id="login-direct-2" class="btn btn-primary" href="login_Version4.html" style="margin-top:10px; display:inline-block;">Go to Login Page</a>
    </div>
  </div>

  <main class="wrap">
    <section id="assess-container" class="assess-card hidden" aria-live="polite">
      <div class="assess-header">
        <div class="row">
          <div class="assess-title">Available Assessments</div>
          <span id="assess-count" class="pill">0</span>
        </div>
        <div class="row">
          <span class="muted">Assessments are open when Unlocked and within the optional Start/Deadline window.</span>
        </div>
      </div>

      <div id="assess-list" class="list" role="list"></div>

      <div class="tips">
        Note: If an assessment is “Upcoming” or “Closed”, the Start button will be disabled. Times are shown in IST.
      </div>
    </section>
  </main>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

  <script>
    // Map assessment id -> URL (use integer keys matching public.assessments.id)
    const URLS_BY_ID = {
      1:  'assesments/assessments_assessment-1-study-of-compound-microscope_Version12.html',
      2:  'assesments/assessments_assessment-2-identification-of-axial-bones_Version7.html',
      3:  'assesments/assessments_assessment-3-identification-of-appendicular-bones_Version7.html',
      4:  'assesments/assessments_assessment-4-study-of-permanent-slides-of-muscle-tissues_Version2.html',
      5:  'assesments/assessments_assessment-5-study-of-permanent-slides-of-nervous-tissue_Version2.html',
      6:  'assesments/assessments_assessment-6-study-of-permanent-slides-of-epithelial-tissue_Version2.html',
      7:  'assesments/assessments_assessment-7-study-of-permanent-slides-of-connective-tissue_Version2.html',
      8:  'assesments/assessments_assessment-8-study-of-human-heart-model_Version2.html',
      9:  'assesments/assessments_assessment-9-study-of-human-brain-model_Version2.html',
      10: 'assesments/assessments_assessment-10-study-of-human-eye-model_Version2.html',
      11: 'assesments/assessments_assessment-11-study-of-human-ear-model_Version2.html',
      12: 'assesments/assessments_assessment-12-study-of-human-kidney-model_Version2.html',
      13: 'assesments/assessments_assessment-13-study-of-human-liver-model_Version2.html',
      14: 'assesments/assessments_assessment-14-study-of-human-lungs-model_Version2.html',
      15: 'assesments/assessments_assessment-15-study-of-human-skin-model_Version2.html',
    };

    document.addEventListener('DOMContentLoaded', () => {
      if (!window.supabase) { console.error('Supabase SDK missing.'); showState('error'); return; }

      const sb = window.sb || (window.sb = window.supabase.createClient(
        'https://hunlistfklwvpivfjmbk.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bmxpc3Rma2x3dnBpdmZqbWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzA1NDUsImV4cCI6MjA3MzQwNjU0NX0.e-o_qL1Uf5DpW4gX60ktXyuUXmw5YWhqaw6Cx8Xc8Qs'
      ));

      // UI handles
      const assessContainer = document.getElementById('assess-container');
      const assessListEl = document.getElementById('assess-list');
      const assessCount = document.getElementById('assess-count');

      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const resultsTab = document.getElementById('results-tab');

      const msgError = document.getElementById('error-message');
      const msgLoggedOut = document.getElementById('not-logged-in-message');
      const msgDenied = document.getElementById('access-denied-message');

      function hideAllMsgs(){ [msgError,msgLoggedOut,msgDenied].forEach(el=>el.classList.add('hidden')); }
      function showState(state){
        hideAllMsgs();
        if(state==='error') msgError.classList.remove('hidden');
        if(state==='loggedOut') msgLoggedOut.classList.remove('hidden');
        if(state==='denied') msgDenied.classList.remove('hidden');
        if(state==='allowed'){
          assessContainer.classList.remove('hidden');
        } else {
          assessContainer.classList.add('hidden');
        }
      }

      function setNav(loggedIn){
        if(loggedIn){
          if(loginBtn) loginBtn.style.display='none';
          if(logoutBtn) logoutBtn.style.display='inline';
          if(resultsTab) resultsTab.style.display='inline';
        }else{
          if(logoutBtn) logoutBtn.style.display='none';
          if(loginBtn){ loginBtn.style.display='inline'; loginBtn.href='login_Version4.html'; }
          if(resultsTab) resultsTab.style.display='none';
        }
      }

      async function getRole(uid){
        const { data, error } = await sb.from('profiles').select('role').eq('id', uid).maybeSingle();
        if(error) console.warn('role fetch error', error);
        return (data?.role || '').toString().trim().toLowerCase();
      }

      // IST helpers
      function toIST(iso){
        if(!iso) return '';
        let s = iso;
        if (typeof s==='string' && s.includes(' ') && !s.includes('T')) s = s.replace(' ','T');
        if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?$/.test(s)) s += 'Z';
        try {
          return new Date(s).toLocaleString('en-IN',{ timeZone:'Asia/Kolkata', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false });
        } catch { return iso; }
      }
      function msLeft(toIso){
        if(!toIso) return null;
        const t = new Date(toIso).getTime() - Date.now();
        return t;
      }
      function fmtCountdown(ms){
        if(ms==null) return '';
        if(ms<=0) return 'now';
        const s = Math.floor(ms/1000);
        const d = Math.floor(s/86400);
        const h = Math.floor((s%86400)/3600);
        const m = Math.floor((s%3600)/60);
        const sec = s%60;
        if(d>0) return `${d}d ${h}h ${m}m`;
        if(h>0) return `${h}h ${m}m`;
        if(m>0) return `${m}m ${sec}s`;
        return `${sec}s`;
      }

      // Simple availability: open = !locked && within optional window
      function stateForRow(row){
        if(row.locked) return { state:'locked', start:row.window_start, end:row.window_end };
        const now = Date.now();
        const s = row.window_start ? new Date(row.window_start).getTime() : null;
        const e = row.window_end ? new Date(row.window_end).getTime() : null;
        if(s && now < s) return { state:'upcoming', start:row.window_start, end:row.window_end };
        if(e && now > e) return { state:'closed',   start:row.window_start, end:row.window_end };
        return { state:'open', start:row.window_start, end:row.window_end };
      }

      async function canStartById(id){
        const { data, error } = await sb.from('assessments')
          .select('locked,window_start,window_end')
          .eq('id', id)
          .maybeSingle();
        if(error){ return { ok:false, reason:'Error checking availability.' }; }
        if(!data){ return { ok:false, reason:'Assessment not configured.' }; }
        if(data.locked) return { ok:false, reason:'Locked by admin.' };
        const now = Date.now();
        const s = data.window_start ? new Date(data.window_start).getTime() : null;
        const e = data.window_end ? new Date(data.window_end).getTime() : null;
        if(s && now < s) return { ok:false, reason:`Opens at ${toIST(data.window_start)}` };
        if(e && now > e) return { ok:false, reason:`Closed at ${toIST(data.window_end)}` };
        return { ok:true };
      }

      function pillClass(state){
        if(state==='open') return 'pill open';
        if(state==='upcoming') return 'pill upcoming';
        if(state==='closed') return 'pill closed';
        return 'pill';
      }

      function renderList(rows, role){
        assessListEl.innerHTML = '';
        let visibleCount = 0;

        rows.forEach(row=>{
          const url = URLS_BY_ID[row.id];
          if(!url) return; // only show items with a page mapped

          const st = stateForRow(row);

          const li = document.createElement('div');
          li.className = 'row';
          li.role = 'listitem';
          li.style.justifyContent='space-between';
          li.style.alignItems='flex-start';
          li.style.padding='8px 6px';
          li.style.borderBottom='1px dashed #e1edc8';

          const left = document.createElement('div');
          left.style.display='flex';
          left.style.flexDirection='column';
          left.style.gap='6px';

          const title = document.createElement('div');
          title.className = 'assess-title';
          title.textContent = row.title || `Assessment ${row.id}`;

          const meta = document.createElement('div');
          meta.className = 'row';

          const pill = document.createElement('span');
          pill.className = pillClass(st.state);
          pill.id = `pill-${row.id}`;
          pill.textContent = st.state==='open' ? 'Open to students'
                         : st.state==='upcoming' ? 'Upcoming'
                         : st.state==='closed' ? 'Closed'
                         : 'Locked';

          const timeLine = document.createElement('div');
          timeLine.className = 'time-line';
          timeLine.id = `tl-${row.id}`;

          if(st.start){
            const d1 = document.createElement('div');
            d1.className='time-piece';
            d1.id = `start-${row.id}`;
            d1.textContent = `Starts: ${toIST(st.start)}`;
            timeLine.appendChild(d1);
          }
          if(st.end){
            const d2 = document.createElement('div');
            d2.className='time-piece';
            d2.id = `end-${row.id}`;
            d2.textContent = `Ends: ${toIST(st.end)}`;
            timeLine.appendChild(d2);
          }
          const cd = document.createElement('div');
          cd.className = 'time-piece';
          cd.id = `cd-${row.id}`;
          cd.textContent = st.state==='open'
            ? (st.end ? `Closes in: ${fmtCountdown(msLeft(st.end))}` : 'No deadline')
            : (st.state==='upcoming' && st.start ? `Opens in: ${fmtCountdown(msLeft(st.start))}` : '');
          timeLine.appendChild(cd);

          meta.appendChild(pill);
          if(timeLine.textContent) meta.appendChild(timeLine);

          left.appendChild(title);
          left.appendChild(meta);

          const right = document.createElement('div');
          right.className='row';
          const startBtn = document.createElement('a');
          startBtn.href = url;
          startBtn.className = 'btn btn-primary';
          startBtn.textContent = 'Start';
          startBtn.setAttribute('data-id', String(row.id));

          // Enforce UI preflight for non-admins
          startBtn.addEventListener('click', async (e)=>{
            if(role === 'admin') return;
            e.preventDefault();
            const id = Number(e.currentTarget.getAttribute('data-id'));
            const r = await canStartById(id);
            if(!r.ok){
              alert(`Cannot start: ${r.reason}`);
              return;
            }
            window.location.href = url;
          });

          if(st.state !== 'open' && role !== 'admin'){
            startBtn.classList.add('btn-ghost');
            startBtn.classList.remove('btn-primary');
            startBtn.textContent = 'Start (Unavailable)';
            startBtn.addEventListener('click', (e)=>{ if(role!=='admin') e.preventDefault(); });
          }

          right.appendChild(startBtn);

          if(role==='admin'){
            const adminTools = document.createElement('div');
            adminTools.className='admin-tools';
            const manage = document.createElement('a');
            manage.href = `admin_portal.html?exp=${encodeURIComponent(String(row.id))}`;
            manage.className='btn btn-ghost';
            manage.textContent='Manage';
            adminTools.appendChild(manage);
            right.appendChild(adminTools);
          }

          li.appendChild(left);
          li.appendChild(right);
          assessListEl.appendChild(li);
          visibleCount++;
        });

        assessCount.textContent = visibleCount;
      }

      // Countdown refresher
      let tickTimer = null;
      function startTicker(rows){
        if(tickTimer) clearInterval(tickTimer);
        tickTimer = setInterval(()=>{
          rows.forEach(row=>{
            const st = stateForRow(row);
            const cdEl = document.getElementById(`cd-${row.id}`);
            const pill = document.getElementById(`pill-${row.id}`);
            if(!cdEl || !pill) return;

            if(st.state==='open'){
              const ms = msLeft(st.end);
              cdEl.textContent = st.end ? `Closes in: ${fmtCountdown(ms)}` : 'No deadline';
              pill.textContent = 'Open to students';
              pill.className = 'pill open';
            } else if(st.state==='upcoming'){
              const ms = msLeft(st.start);
              cdEl.textContent = st.start ? `Opens in: ${fmtCountdown(ms)}` : '';
              pill.textContent = 'Upcoming';
              pill.className = 'pill upcoming';
            } else if(st.state==='closed'){
              cdEl.textContent = st.end ? `Closed at: ${toIST(st.end)}` : 'Closed';
              pill.textContent = 'Closed';
              pill.className = 'pill closed';
            } else {
              cdEl.textContent = '';
              pill.textContent = 'Locked';
              pill.className = 'pill';
            }
          });
        }, 1000);
      }

      async function loadAssessments(){
        const { data, error } = await sb
          .from('assessments')
          .select('id,title,locked,window_start,window_end')
          .order('id', { ascending:true });
        if(error){
          console.error('Failed to load assessments:', error);
          throw error;
        }
        // Keep only rows that have a URL mapped
        return (data || []).filter(r => URLS_BY_ID[r.id]);
      }

      async function init(){
        try{
          const { data:{ session } } = await sb.auth.getSession();
          if(!session?.user){
            setNav(false);
            showState('loggedOut');
            return;
          }
          setNav(true);

          const role = await getRole(session.user.id);
          if(!role){
            showState('denied');
            return;
          }
          showState('allowed');

          const rows = await loadAssessments();
          renderList(rows, role);
          startTicker(rows);

          // Auth changes
          sb.auth.onAuthStateChange(async (_evt, newSession)=>{
            if(!newSession?.user){
              setNav(false);
              showState('loggedOut');
              return;
            }
            setNav(true);
            const r = await getRole(newSession.user.id);
            if(!r) showState('denied'); else showState('allowed');
          });

          // Protect Results link
          if(resultsTab){
            resultsTab.addEventListener('click', async (e)=>{
              const { data:{ session } } = await sb.auth.getSession();
              if(!session?.user){ e.preventDefault(); window.location.href='login_Version4.html'; }
            });
          }

          // Logout hardened
          if(logoutBtn){
            logoutBtn.onclick = async (e)=>{
              e.preventDefault();
              try { await sb.auth.signOut({ scope:'global' }); } catch {}
              try { await sb.auth.signOut({ scope:'local' }); } catch {}
              try {
                for (const k of Object.keys(localStorage)) {
                  const key = k.toLowerCase();
                  if (key.includes('supabase') || key.startsWith('sb-')) localStorage.removeItem(k);
                }
                for (const k of Object.keys(sessionStorage)) {
                  const key = k.toLowerCase();
                  if (key.includes('supabase') || key.startsWith('sb-')) sessionStorage.removeItem(k);
                }
              } catch {}
              try { indexedDB.deleteDatabase('supabase-auth'); } catch {}
              window.location.href = 'index.html';
            };
          }

        } catch(e){
          console.error('Assessments init error:', e);
          showState('error');
        }
      }

      init();
    });
  </script>
</body>
</html>
