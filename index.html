<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Human Anatomy & Physiology Portal</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      color: #222;
      position: relative;
      min-height: 100vh;
      overflow-x: hidden;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      background: url('wallpaper.jpg') no-repeat center center fixed;
      background-size: cover;
      opacity: 1.0;
      pointer-events: none;
    }
    .overlay {
      background: rgba(255,255,255,0.90);
      min-height: 100vh;
      padding-bottom: 40px;
    }
    header {
      text-align: center;
      padding: 2rem 1rem 1rem 1rem;
    }
    h1 {
      font-size: 2.5rem;
      margin: 0.5rem 0 1rem 0;
      color: #1a237e;
      letter-spacing: 2px;
      text-shadow: 1px 1px 8px #cfd8dc;
    }
    nav {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    nav a, nav button {
      font-size: 1.2rem;
      font-weight: bold;
      color: #1565c0;
      text-decoration: none;
      padding: 0.6em 1.2em;
      border-radius: 4px;
      background: #e3f2fd;
      transition: background 0.2s;
      border: none;
      cursor: pointer;
    }
    nav a:hover, nav button:hover {
      background: #bbdefb;
    }
    .intro {
      max-width: 700px;
      margin: auto;
      background: rgba(255,255,255,0.85);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 2px 8px #90caf9;
      font-size: 1.15rem;
    }
    /* Unified dashboard styling */
    #admin-features, #student-features {
      display: none;
      max-width: 700px;
      margin: 2rem auto 0 auto;
      padding: 1.5rem;
      border-radius: 12px;
      background: #f5faff;
      box-shadow: 0 1px 8px #e3f2fd;
      text-align: left;
    }
    .dashboard-title {
      font-size: 1.6rem;
      font-weight: bold;
      color: #1565c0;
      margin-bottom: 0.5em;
      letter-spacing: 1px;
    }
    .dashboard-welcome {
      font-size: 1.15rem;
      font-weight: 500;
      color: #1565c0;
      margin-bottom: 1em;
      margin-top: 0;
    }
    /* Avatar card (private, signed URL preview) */
    #avatar-card {
      display: none;
      max-width: 700px;
      margin: 1rem auto 0 auto;
      padding: 1rem;
      border-radius: 12px;
      background: #f5faff;
      box-shadow: 0 1px 8px #e3f2fd;
      text-align: left;
    }
    .avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      background: #f3f3f3;
      box-shadow: 0 0 0 2px #e3f2fd inset;
    }
    @media (max-width: 600px) {
      h1 { font-size: 1.5rem; }
      nav { flex-direction: column; gap: 1rem; }
      .intro { padding: 1rem; }
      #admin-features, #student-features { padding: 1rem; }
      .dashboard-title { font-size: 1.2rem; }
      .dashboard-welcome { font-size: 1rem; }
    }
  </style>
</head>
<body>
  <div class="overlay">
    <header>
      <h1>Human Anatomy & Physiology Experiments Portal</h1>
      <nav>
        <a href="index.html">Home</a>
        <a href="experiments.html">Experiments</a>
        <a id="assessment-tab" href="assessments.html">Assessments</a>
        <a id="results-tab" href="result.html" style="display:none;">Results</a>
        <a href="profile.html" id="profile-tab" style="display:none;">Profile</a>
        <a href="references.html">References</a>
        <a id="login-btn" href="login_Version4.html" style="display:inline;">Login</a>
        <button id="logout-btn" style="display:none;">Logout</button>
      </nav>
    </header>

    <!-- Private avatar preview + upload (signed URL) -->
    <div id="avatar-card">
      <div class="dashboard-title" style="margin-bottom: 0.75rem;">Your Avatar</div>
      <div style="display:flex; align-items:center; gap:1rem; flex-wrap:wrap;">
        <img id="avatar-preview" class="avatar" alt="Avatar preview" />
        <div>
          <label for="avatar-input" style="display:block; font-weight:600; color:#1565c0;">Update your avatar</label>
          <input id="avatar-input" type="file" accept="image/*" />
          <div style="font-size:0.9rem; color:#555; margin-top:0.25rem;">
            Private preview: only you and admins can access this image.
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard Features FIRST -->
    <div id="admin-features">
      <div class="dashboard-title">Admin Dashboard</div>
      <p class="dashboard-welcome" id="dashboard-welcome-admin"></p>
      <ul>
        <li>Manage all profiles and assessments</li>
        <li>View all experiment data</li>
        <li>Edit or add new experiments and references</li>
      </ul>
    </div>
    <div id="student-features">
      <div class="dashboard-title">Student Dashboard</div>
      <p class="dashboard-welcome" id="dashboard-welcome-student"></p>
      <ul>
        <li>View your profile and batch assignments</li>
        <li>Access experiments and submit assessments</li>
        <li>See references and learning material</li>
      </ul>
    </div>
    <!-- Welcome/Intro Message AFTER dashboard -->
    <div class="intro">
      <p>
        Welcome to the Human Anatomy & Physiology Experiments Portal!
        <br><br>
        This site provides a comprehensive set of laboratory experiments, assessments, and references for students and instructors. Explore interactive resources, answer experiment-based questions, and discover curated references for deeper study.
        <br><br>
        <strong>Navigation:</strong><br>
        <ul>
          <li><b>Experiments</b> – browse all practical experiments with direct links to their contents.</li>
          <li><b>Assessments</b> – find and answer experiment-specific questions.</li>
          <li><b>References</b> – access textbooks and websites for further learning.</li>
        </ul>
        <br>
        <em>Start exploring and build your knowledge of the amazing human body!</em>
      </p>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (!window.supabase) {
        console.error('Supabase SDK failed to load.');
        return;
      }

      // IMPORTANT: Use a different variable name than "supabase" to avoid shadowing the SDK global.
      const sb = window.sb || (window.sb = window.supabase.createClient(
        'https://hunlistfklwvpivfjmbk.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bmxpc3Rma2x3dnBpdmZqbWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzA1NDUsImV4cCI6MjA3MzQwNjU0NX0.e-o_qL1Uf5DpW4gX60ktXyuUXmw5YWhqaw6Cx8Xc8Qs'
      ));

      const AVATAR_BUCKET = 'Avatar'; // case-sensitive

      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const profileTab = document.getElementById('profile-tab');
      const adminFeatures = document.getElementById('admin-features');
      const studentFeatures = document.getElementById('student-features');
      const welcomeAdmin = document.getElementById('dashboard-welcome-admin');
      const welcomeStudent = document.getElementById('dashboard-welcome-student');
      const assessmentTab = document.getElementById('assessment-tab');
      const resultsTab = document.getElementById('results-tab'); // Results link

      // Avatar elements
      const avatarCard = document.getElementById('avatar-card');
      const avatarImg = document.getElementById('avatar-preview');
      const avatarInput = document.getElementById('avatar-input');

      // State to avoid duplicate listeners/refresh timers
      let avatarListenerBound = false;
      let avatarRefreshTimerId = null;
      let currentAvatarPath = null;

      function setNav(loggedIn) {
        if (loggedIn) {
          if (loginBtn) loginBtn.style.display = 'none';
          if (logoutBtn) logoutBtn.style.display = 'inline';
          if (profileTab) profileTab.style.display = 'inline';
          if (resultsTab) resultsTab.style.display = 'inline'; // SHOW results when logged in
          if (avatarCard) avatarCard.style.display = 'block';
        } else {
          if (logoutBtn) logoutBtn.style.display = 'none';
          if (loginBtn) { loginBtn.style.display = 'inline'; loginBtn.href = 'login_Version4.html'; }
          if (profileTab) profileTab.style.display = 'none';
          if (resultsTab) resultsTab.style.display = 'none'; // HIDE results when logged out
          if (avatarCard) avatarCard.style.display = 'none';
          if (avatarImg) avatarImg.removeAttribute('src');
          if (avatarRefreshTimerId) { clearInterval(avatarRefreshTimerId); avatarRefreshTimerId = null; }
          currentAvatarPath = null;
        }
      }

      async function getUserRole(userId) {
        const { data, error } = await sb
          .from('profiles')
          .select('role')
          .eq('id', userId)
          .maybeSingle();
        if (error) console.warn('Role fetch error:', error);
        // Normalize role to avoid casing/whitespace issues like 'Admin'/'ADMIN'
        return (data?.role || 'unknown').toString().trim().toLowerCase();
      }

      async function setDashboardWelcome(userId, role) {
        const { data, error } = await sb
          .from('profiles')
          .select('name')
          .eq('id', userId)
          .maybeSingle();
        if (error) console.warn('Name fetch error:', error);
        const name = data?.name || '';
        if (role === 'admin') {
          if (welcomeAdmin) welcomeAdmin.textContent = name ? `Welcome ${name}` : '';
        } else if (role === 'student') {
          if (welcomeStudent) welcomeStudent.textContent = name ? `Welcome ${name}` : '';
        }
      }

      // Create and set a signed URL for the avatar image
      async function setSignedAvatar(path) {
        if (!avatarImg) return;
        if (!path) {
          avatarImg.removeAttribute('src');
          return;
        }
        try {
          const { data, error } = await sb
            .storage
            .from(AVATAR_BUCKET)
            .createSignedUrl(path, 60); // valid for 60 seconds

          if (error) {
            console.error('createSignedUrl error:', error);
            return;
          }
          avatarImg.src = data.signedUrl;
        } catch (err) {
          console.error('setSignedAvatar error:', err);
        }
      }

      // Keep the signed URL fresh while the page is open
      function startAvatarAutoRefresh(path) {
        if (avatarRefreshTimerId) clearInterval(avatarRefreshTimerId);
        if (!path) return;
        avatarRefreshTimerId = setInterval(() => setSignedAvatar(path), 50 * 1000); // refresh a bit before expiry
      }

      // Bind upload handler once
      function ensureAvatarUploadHandler(userId) {
        if (!avatarInput || avatarListenerBound) return;
        avatarInput.addEventListener('change', async (e) => {
          const file = e.target.files?.[0];
          if (!file) return;

          // Local preview while upload occurs
          if (avatarImg) avatarImg.src = URL.createObjectURL(file);

          const filePath = `${userId}/${Date.now()}_${file.name}`;

          // Upload to private bucket (RLS must allow insert for owner/admin)
          const { error: upErr } = await sb
            .storage
            .from(AVATAR_BUCKET)
            .upload(filePath, file, {
              upsert: true,
              contentType: file.type || 'image/*'
            });

          if (upErr) {
            console.error('Upload error:', upErr);
            return;
          }

          // Save storage path (NOT a public URL) to profile
          const { error: updErr } = await sb
            .from('profiles')
            .update({ avatar_path: filePath })
            .eq('id', userId);

          if (updErr) {
            console.error('Update profile error:', updErr);
            return;
          }

          currentAvatarPath = filePath;
          await setSignedAvatar(currentAvatarPath);
          startAvatarAutoRefresh(currentAvatarPath);
        });
        avatarListenerBound = true;
      }

      // Helper for robust "has value" checks
      const has = (v) => typeof v === 'string' ? v.trim().length > 0 : !!v;

      async function refreshUI() {
        try {
          const { data: { session } } = await sb.auth.getSession();
          if (session?.user) {
            setNav(true);

            const userId = session.user.id;
            const role = await getUserRole(userId); // normalized lower-case: 'admin' | 'student' | 'unknown'

            // Toggle dashboards by role (case-insensitive)
            if (role === 'admin') {
              if (adminFeatures) adminFeatures.style.display = 'block';
              if (studentFeatures) studentFeatures.style.display = 'none';
              await setDashboardWelcome(userId, 'admin');
            } else if (role === 'student') {
              if (adminFeatures) adminFeatures.style.display = 'none';
              if (studentFeatures) studentFeatures.style.display = 'block';
              await setDashboardWelcome(userId, 'student');
            } else {
              if (adminFeatures) adminFeatures.style.display = 'none';
              if (studentFeatures) studentFeatures.style.display = 'none';
              if (welcomeAdmin) welcomeAdmin.textContent = '';
              if (welcomeStudent) welcomeStudent.textContent = '';
            }

            // Profile completeness + avatar
            const { data: profile, error: profErr } = await sb
              .from('profiles')
              .select('name, role, prn, batch, avatar_path')
              .eq('id', userId)
              .maybeSingle();

            if (profErr) console.warn('Profile fetch error:', profErr);

            // Use role from earlier fetch, fall back to profile.role if needed
            const roleVal = (role || profile?.role || 'unknown').toString().trim().toLowerCase();

            // Required fields:
            // - For everyone: name + role
            // - For students: PRN + batch as well
            const baseComplete = !!profile && has(profile.name) && has(profile.role);
            const studentComplete = baseComplete && has(profile.prn) && has(profile.batch);
            const adminComplete = baseComplete; // admins do NOT need PRN/batch

            const isComplete = (roleVal === 'admin') ? adminComplete : studentComplete;

            if (!isComplete && !window.location.pathname.includes('profile.html')) {
              // Optional debug to see which fields are missing for affected users
              console.warn('Profile incomplete; redirecting to profile.html', {
                role: roleVal,
                baseComplete,
                studentComplete,
                adminComplete,
                nameOK: has(profile?.name),
                roleOK: has(profile?.role),
                prnOK: has(profile?.prn),
                batchOK: has(profile?.batch)
              });
              window.location.href = 'profile.html';
              return; // stop further logic if redirecting
            }

            // Signed avatar preview (private)
            currentAvatarPath = profile?.avatar_path || null;
            await setSignedAvatar(currentAvatarPath);
            startAvatarAutoRefresh(currentAvatarPath);
            ensureAvatarUploadHandler(userId);

          } else {
            // Logged out
            setNav(false);
            if (adminFeatures) adminFeatures.style.display = 'none';
            if (studentFeatures) studentFeatures.style.display = 'none';
            if (welcomeAdmin) welcomeAdmin.textContent = '';
            if (welcomeStudent) welcomeStudent.textContent = '';
          }
        } catch (e) {
          console.error('refreshUI error:', e);
        }
      }

      // Initial UI
      refreshUI();

      // Keep UI in sync with auth changes and when returning focus to the tab
      sb.auth.onAuthStateChange((_event, _session) => { refreshUI(); });
      window.addEventListener('focus', refreshUI);

      // Protect Assessments link: require login
      if (assessmentTab) {
        assessmentTab.addEventListener('click', async (e) => {
          const { data: { session } } = await sb.auth.getSession();
          if (!session?.user) {
            e.preventDefault();
            window.location.href = 'login_Version4.html';
          }
        });
      }

      // Protect Results link: require login
      if (resultsTab) {
        resultsTab.addEventListener('click', async (e) => {
          const { data: { session } } = await sb.auth.getSession();
          if (!session?.user) {
            e.preventDefault();
            window.location.href = 'login_Version4.html';
          }
        });
      }

      // Hardened Logout handler (fixes "stuck session" on some browsers)
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          try { await sb.auth.signOut({ scope: 'global' }); } catch (err) { console.warn('global signOut error:', err); }
          try { await sb.auth.signOut({ scope: 'local'  }); } catch (err) { console.warn('local signOut error:', err); }
          try {
            for (const k of Object.keys(localStorage)) {
              const key = k.toLowerCase();
              if (key.includes('supabase') || key.startsWith('sb-')) localStorage.removeItem(k);
            }
            for (const k of Object.keys(sessionStorage)) {
              const key = k.toLowerCase();
              if (key.includes('supabase') || key.startsWith('sb-')) sessionStorage.removeItem(k);
            }
          } catch (e2) { console.warn('storage cleanup error:', e2); }
          try { indexedDB.deleteDatabase('supabase-auth'); } catch (e3) { /* ignore */ }
          window.location.replace('index.html');
        });
      }
    });
  </script>
</body>
</html>
