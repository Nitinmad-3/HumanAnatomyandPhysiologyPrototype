<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Human Anatomy & Physiology Portal</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Fix favicon 404 by providing an inline SVG favicon -->
  <link
    rel="icon"
    href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" fill="%231565c0"/><text x="32" y="39" font-size="28" text-anchor="middle" fill="white" font-family="Arial, Helvetica, sans-serif">H</text></svg>'
  />

  <style>
    :root{
      --blue:#1565c0;
      --blue-600:#1a237e;
      --ink:#222;
      --muted:#5b6f99;
      --chip-bg:#e3f2fd;
      --chip-bd:#cfe0ff;
      --card-bg:#f7fbff;
      --shadow:0 6px 24px rgba(13,37,62,.12);
      --shadow-soft:0 2px 10px rgba(13,37,62,.10);
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      color: var(--ink);
      position: relative;
      min-height: 100vh;
      overflow-x: hidden;
      background: #fff;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      background: url('wallpaper.jpg') no-repeat center center fixed;
      background-size: cover;
      opacity: 1.0;
      pointer-events: none;
      filter: saturate(1.05) contrast(1.02);
    }
    .overlay {
      background: rgba(255,255,255,0.90);
      min-height: 100vh;
      padding-bottom: 48px;
    }
    header {
      text-align: center;
      padding: 2rem 1rem 1rem 1rem;
    }
    h1 {
      font-size: 2.2rem;
      margin: 0.25rem 0 1rem 0;
      color: var(--blue-600);
      letter-spacing: 1.2px;
      text-shadow: 0 1px 8px #cfd8dc;
    }
    nav {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 1.2rem;
      flex-wrap: wrap;
    }
    nav a, nav button {
      font-size: 1rem;
      font-weight: 600;
      color: var(--blue);
      text-decoration: none;
      padding: 0.55em 1.0em;
      border-radius: 10px;
      background: var(--chip-bg);
      border: 1px solid var(--chip-bd);
      transition: transform .04s ease, background .2s ease, box-shadow .2s ease;
      cursor: pointer;
      box-shadow: var(--shadow-soft);
    }
    nav a:hover, nav button:hover {
      background: #dceefd;
      transform: translateY(-1px);
    }

    /* Modern Profile Dashboard Card */
    .card {
      max-width: 920px;
      margin: 18px auto 12px auto;
      background: linear-gradient(180deg, #ffffff 0%, var(--card-bg) 100%);
      border: 1px solid var(--chip-bd);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .profile-wrap{
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 16px;
      align-items: center;
    }
    .avatar {
      width: 110px;
      height: 110px;
      border-radius: 16px;
      object-fit: cover;
      background: #f3f6fb;
      border: 1px solid var(--chip-bd);
      box-shadow: inset 0 0 0 2px #eef5ff;
    }
    .title-row{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .name{
      font-size: 1.35rem;
      font-weight: 700;
      color: var(--blue-600);
      letter-spacing: .2px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      font-size:.85rem;
      font-weight:600;
      border-radius:999px;
      background: var(--chip-bg);
      border:1px solid var(--chip-bd);
      color: var(--blue);
    }
    .muted{ color: var(--muted); }
    .meta-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin:8px 0 6px 0;
    }
    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .btn{
      border:0;
      border-radius:10px;
      padding: 10px 14px;
      font-size:.95rem;
      font-weight:700;
      cursor:pointer;
      transition: transform .04s ease, background .2s ease, box-shadow .2s ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn-primary{
      background: var(--blue);
      color:#fff;
      box-shadow: var(--shadow-soft);
    }
    .btn-ghost{
      background:#ffffff;
      color: var(--blue);
      border:1px solid var(--chip-bd);
      box-shadow: var(--shadow-soft);
    }
    .note{
      font-size:.95rem;
      color:#0d47a1;
      background:#eef6ff;
      border:1px dashed var(--chip-bd);
      border-radius:10px;
      padding:8px 10px;
      margin-top:8px;
    }

    /* Chat styles */
    .chat-card{
      margin-top:14px;
      border:1px solid var(--chip-bd);
      background:#fff;
      border-radius:14px;
      box-shadow: var(--shadow-soft);
      padding:12px;
    }
    .chat-head{ display:flex; align-items:center; gap:8px; justify-content:space-between; }
    .chat-head .left{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .chat-title{ font-weight:800; color:var(--blue-600); }
    .room-select{ padding:6px 10px; border-radius:10px; border:1px solid var(--chip-bd); background:#f9fbff; }
    .chat-box{
      margin-top:10px; max-height:280px; overflow:auto; background:#f7f9fe;
      border:1px solid var(--chip-bd); border-radius:10px; padding:8px; display:flex; flex-direction:column; gap:8px;
    }
    .chat-line{ display:flex; gap:8px; }
    .msg{ padding:8px 10px; border-radius:10px; border:1px solid var(--chip-bd); background:#fff; max-width:75%; }
    .me .msg{ background:#e8f5e9; border-color:#c8e6c9; }
    .meta{ font-size:11px; color:#6b84c7; margin-top:4px; }
    .chat-input-row{ display:flex; gap:8px; margin-top:10px; }
    .chat-input{ flex:1; padding:10px; border-radius:10px; border:1px solid var(--chip-bd); }
    .chat-send{ padding:10px 14px; border-radius:10px; border:0; background:var(--blue); color:#fff; font-weight:800; }

    .intro {
      max-width: 920px;
      margin: 14px auto 0 auto;
      background: rgba(255,255,255,0.85);
      border-radius: 16px;
      padding: 1.2rem 1.4rem;
      box-shadow: var(--shadow-soft);
      font-size: 1.05rem;
      border: 1px solid var(--chip-bd);
    }
    .intro ul{ margin: .5rem 0 .25rem 1.2rem; }
    .intro li{ margin: .15rem 0; }

    /* Efficient Marquee notification bar: two-segment loop */
    .marquee-notification {
      position: relative;
      overflow: hidden;
      background: #f0f6ff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(13,37,62,.10);
      border: 1px solid #cfe0ff;
      margin: 10px auto;
      max-width: 920px;
      height: 38px;
      display: flex;
      align-items: center;
      padding: 0;
    }
    .marquee-track {
      display: inline-flex;
      align-items: center;
      white-space: nowrap;
      will-change: transform;
      animation-name: marquee;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
      /* Set via inline style: --scroll-distance and animation-duration */
    }
    .marquee-segment {
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      padding-right: 2rem; /* visual gap between loops */
    }
    @keyframes marquee {
      from { transform: translateX(0); }
      to   { transform: translateX(calc(-1 * var(--scroll-distance, 0px))); }
    }
    .marquee-notification:hover .marquee-track { animation-play-state: paused; }
    @media (prefers-reduced-motion: reduce) {
      .marquee-track { animation: none !important; transform: none !important; }
    }
  </style>
</head>
<body>
  <div class="overlay">
    <header>
      <h1>Human Anatomy & Physiology Experiments Portal</h1>
      <nav>
        <a href="index.html">Home</a>
        <a href="experiments.html">Experiments</a>
        <a id="assessment-tab" href="assessments.html">Assessments</a>
        <a id="results-tab" href="result.html" style="display:none;">Results</a>
        <a href="profile.html" id="profile-tab" style="display:none;">Profile</a>
        <a href="references.html">References</a>
        <a href="admin_portal.html" id="admin-portal-link" style="display:none;">Admin Portal</a>
        <a id="login-btn" href="login_Version4.html" style="display:inline;">Login</a>
        <button id="logout-btn" style="display:none;">Logout</button>
      </nav>
    </header>

    <!-- Notifications Banner (JS will render marquee banners here) -->
    <div id="home-notifications" aria-live="polite" aria-atomic="true"></div>

    <!-- Unified Profile + Dashboard card (modern, no avatar upload) -->
    <section id="profile-dashboard-card" class="card" style="display:none;">
      <div class="profile-wrap">
        <img id="pc-avatar" class="avatar" alt="Profile avatar" />
        <div>
          <div class="title-row">
            <span id="pc-name" class="name">Welcome</span>
            <span id="pc-role" class="chip">Role</span>
          </div>
          <div id="pc-message" class="muted" style="margin-top:4px;">Loading…</div>
          <div id="pc-meta" class="meta-row" style="display:none;">
            <span id="pc-prn" class="chip">PRN: —</span>
            <span id="pc-batch" class="chip">Batch: —</span>
          </div>
          <div class="actions">
            <a href="profile.html" class="btn btn-ghost" id="pc-update-profile">Update your profile</a>
            <a href="assessments.html" class="btn btn-primary" id="pc-start-assessments">Go to Assessments</a>
            <a href="result.html" class="btn btn-ghost" id="pc-view-results">View Results</a>
            <a href="admin_portal.html" class="btn btn-primary" id="pc-admin-portal" style="display:none;">Open Admin Portal</a>
          </div>
          <div id="pc-note" class="note" style="display:none;"></div>

          <!-- Student Chat (disabled by feature flag in JS) -->
          <div id="chat-section" class="chat-card" style="display:none;">
            <div class="chat-head">
              <div class="left">
                <div class="chat-title">Messages</div>
                <select id="chat-room" class="room-select" aria-label="Select chat audience">
                  <option value="global">Global (everyone)</option>
                  <option value="dm">Admin (private)</option>
                </select>
              </div>
              <div id="chat-status" class="muted">—</div>
            </div>
            <div id="chat-box" class="chat-box" aria-live="polite"></div>
            <div class="chat-input-row">
              <input id="chat-input" class="chat-input" placeholder="Type a message…" />
              <button id="chat-send" class="chat-send">Send</button>
            </div>
            <div id="chat-setup-hint" class="muted" style="margin-top:6px; display:none;">
              Chat backend is not set up yet. Ask admin to run setup_portal.sql (portal_chat).
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Welcome/Intro -->
    <div class="intro">
      <p>
        Welcome to the Human Anatomy & Physiology Experiments Portal!
      </p>
      <ul>
        <li><b>Experiments</b> – browse all practical experiments with direct links to their contents.</li>
        <li><b>Assessments</b> – find and answer experiment-specific questions.</li>
        <li><b>References</b> – access textbooks and websites for further learning.</li>
      </ul>
      <p class="muted" style="margin:.4rem 0 0 0;">
        Tip: If an assessment is not visible, your admin may not have released it yet or it may be outside its time window.
      </p>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

  <script>
    (function () {
      // Reusable hidden measurer to avoid repeated DOM churn
      const __measure = document.createElement('div');
      __measure.style.cssText = 'position:absolute; left:-99999px; top:-99999px; visibility:hidden; white-space:nowrap;';

      document.addEventListener('DOMContentLoaded', () => {
        if (!document.body.contains(__measure)) document.body.appendChild(__measure);
      });

      // Safely escape notification text
      function escapeHtml(str) {
        return String(str || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function segmentHTML(color, sev, messageText) {
        return `<strong style="color:${color}; text-transform:uppercase;">${sev}</strong>
                <span style="margin-left:.5rem; color:#123;">${messageText}</span>`;
      }

      function renderNotification(n) {
        let color = '#1565c0';
        const sev = (n.severity || 'info').toLowerCase();
        if (sev === 'danger') color = '#c62828';
        else if (sev === 'warning') color = '#ffb300';

        const messageText = escapeHtml(n.message || '');
        const segment = segmentHTML(color, sev, messageText);

        // Ensure measurer is attached (in case called before DOMContentLoaded)
        if (document.body && !document.body.contains(__measure)) {
          try { document.body.appendChild(__measure); } catch (_) {}
        }
        __measure.innerHTML = `<div class="marquee-segment" style="font: inherit;">${segment}</div>`;

        const segmentWidth = Math.max(__measure.firstChild?.scrollWidth || 0, 1);
        const gapPx = 32; // matches padding-right in .marquee-segment

        // Distance to scroll for one full cycle = one segment + gap
        const distance = segmentWidth + gapPx;

        // Speed: ~100 px/s feels smooth; clamp to [12s, 40s]
        const pxPerSec = 100;
        const duration = Math.min(40, Math.max(12, distance / pxPerSec));

        // Two segments only (second is aria-hidden) for a seamless loop
        return `
          <div class="marquee-notification" style="border-left:6px solid ${color};">
            <div class="marquee-track" style="--scroll-distance:${distance}px; animation-duration:${duration}s;">
              <div class="marquee-segment">${segment}</div>
              <div class="marquee-segment" aria-hidden="true">${segment}</div>
            </div>
          </div>
        `;
      }

      function isWithinWindow(n, now) {
        const sOk = !n.starts_at || new Date(n.starts_at) <= now;
        const eOk = !n.ends_at || new Date(n.ends_at) >= now;
        return sOk && eOk;
      }

      // Avoid unnecessary DOM writes if unchanged
      let __lastNotifHTML = '';
      async function loadHomeNotifications(sb) {
        const container = document.getElementById('home-notifications');
        if (!container) return;

        try {
          const { data: { session } } = await sb.auth.getSession();
          if (!session?.user) { container.innerHTML = ''; __lastNotifHTML = ''; return; }
        } catch (_) {}

        const now = new Date();
        const { data, error } = await sb
          .from('portal_notifications')
          .select('id,message,severity,active,starts_at,ends_at,created_at')
          .eq('active', true)
          .order('created_at', { ascending: false })
          .limit(25);

        if (error) { console.warn('home_notifications load error:', error); return; }
        const rows = (data || []).filter(n => isWithinWindow(n, now));

        const html = rows.map(renderNotification).join('');
        if (html !== __lastNotifHTML) {
          container.innerHTML = html;
          __lastNotifHTML = html;
        }
      }
      window.__loadHomeNotifications = loadHomeNotifications;
    })();
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (!window.supabase) {
        console.error('Supabase SDK failed to load.');
        return;
      }
      const sb = window.sb || (window.sb = window.supabase.createClient(
        'https://hunlistfklwvpivfjmbk.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bmxpc3Rma2x3dnBpdmZqbWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzA1NDUsImV4cCI6MjA3MzQwNjU0NX0.e-o_qL1Uf5DpW4gX60ktXyuUXmw5YWhqaw6Cx8Xc8Qs'
      ));

      const ENABLE_CHAT = false;
      const AVATAR_BUCKET = 'Avatar';

      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const profileTab = document.getElementById('profile-tab');
      const assessmentTab = document.getElementById('assessment-tab');
      const resultsTab = document.getElementById('results-tab');
      const adminPortalLink = document.getElementById('admin-portal-link');
      const profileCard = document.getElementById('profile-dashboard-card');
      const pcAvatar = document.getElementById('pc-avatar');
      const pcName = document.getElementById('pc-name');
      const pcRole = document.getElementById('pc-role');
      const pcMessage = document.getElementById('pc-message');
      const pcMeta = document.getElementById('pc-meta');
      const pcPRN = document.getElementById('pc-prn');
      const pcBatch = document.getElementById('pc-batch');
      const pcAdminBtn = document.getElementById('pc-admin-portal');
      const pcNote = document.getElementById('pc-note');
      const chatSection = document.getElementById('chat-section');
      const chatRoomSel = document.getElementById('chat-room');
      const chatBox = document.getElementById('chat-box');
      const chatInput = document.getElementById('chat-input');
      const chatSend = document.getElementById('chat-send');
      const chatStatus = document.getElementById('chat-status');
      const chatSetupHint = document.getElementById('chat-setup-hint');
      const pcStartAssessments = document.getElementById('pc-start-assessments');
      const pcViewResults = document.getElementById('pc-view-results');

      let currentUser = null;
      let currentRole = 'unknown';
      let dmRoom = null;
      let chatSubscription = null;

      async function setSignedAvatar(path) {
        if (!pcAvatar) return;
        if (!path) {
          pcAvatar.removeAttribute('src');
          pcAvatar.alt = 'No avatar';
          return;
        }
        try {
          const { data, error } = await sb.storage.from(AVATAR_BUCKET).createSignedUrl(path, 60);
          if (error) { console.warn('avatar signedUrl error', error); return; }
          pcAvatar.src = data.signedUrl;
        } catch (err) {
          console.warn('avatar error', err);
        }
      }
      let avatarRefreshTimerId = null;
      function startAvatarAutoRefresh(path) {
        if (avatarRefreshTimerId) clearInterval(avatarRefreshTimerId);
        if (!path) return;
        avatarRefreshTimerId = setInterval(() => setSignedAvatar(path), 50 * 1000);
      }

      function setNav(loggedIn) {
        if (loggedIn) {
          if (loginBtn) loginBtn.style.display = 'none';
          if (logoutBtn) logoutBtn.style.display = 'inline';
          if (profileTab) profileTab.style.display = 'inline';
          if (resultsTab) resultsTab.style.display = 'inline';
        } else {
          if (logoutBtn) logoutBtn.style.display = 'none';
          if (loginBtn) { loginBtn.style.display = 'inline'; loginBtn.href = 'login_Version4.html'; }
          if (profileTab) profileTab.style.display = 'none';
          if (resultsTab) resultsTab.style.display = 'none';
          if (adminPortalLink) adminPortalLink.style.display = 'none';
          if (profileCard) profileCard.style.display = 'none';
          if (chatSection) chatSection.style.display = 'none';
          if (avatarRefreshTimerId) { clearInterval(avatarRefreshTimerId); avatarRefreshTimerId = null; }
        }
      }

      async function getUserRole(userId) {
        const { data, error } = await sb.from('profiles').select('role').eq('id', userId).maybeSingle();
        if (error) console.warn('Role fetch error:', error);
        return (data?.role || 'unknown').toString().trim().toLowerCase();
      }

      // Approval/Active helpers and link protection
      async function getApprovalStatus(sb) {
        const { data: { session } } = await sb.auth.getSession();
        if (!session?.user) return { loggedIn: false };
        const { data: p, error } = await sb
          .from('profiles')
          .select('role, approved, active')
          .eq('id', session.user.id)
          .maybeSingle();
        if (error) console.warn('approval status fetch error', error);
        return {
          loggedIn: true,
          role: (p?.role || '').toLowerCase(),
          approved: !!p?.approved,
          active: !!p?.active
        };
      }

      function protectLinkApproved(el, allowedRoles = ['student','admin']) {
        if (!el) return;
        el.addEventListener('click', async (e) => {
          const st = await getApprovalStatus(sb);
          if (!st.loggedIn) {
            e.preventDefault();
            window.location.href = 'login_Version4.html';
            return;
          }
          if (!allowedRoles.includes(st.role)) {
            e.preventDefault();
            alert('You do not have permission to access this page.');
            return;
          }
          if (!st.active) {
            e.preventDefault();
            alert('Your account is deactivated. Please contact admin.');
            return;
          }
          if (!st.approved && st.role !== 'admin') {
            e.preventDefault();
            alert('Your account is awaiting admin approval.');
            return;
          }
        });
      }

      function renderMsg(m){
        const me = m.sender_id === currentUser?.id;
        const line = document.createElement('div');
        line.className = 'chat-line ' + (me ? 'me' : 'them');
        const bubble = document.createElement('div');
        bubble.className = 'msg';
        const who = m.sender_name || (me ? 'You' : (m.role === 'admin' ? 'Admin' : 'User'));
        bubble.innerHTML = '<div style="font-size:12px; color:#0d47a1; font-weight:700;">'+who+'</div>'
          + (m.message || '').replace(/</g,'&lt;')
          + '<div class="meta">'+new Date(m.created_at).toLocaleString()+'</div>';
        line.appendChild(bubble);
        chatBox.appendChild(line);
      }

      async function loadChat(room){
        if (!ENABLE_CHAT) return;
        chatBox.innerHTML = '';
        chatStatus.textContent = 'Loading…';
        try{
          const { data, error } = await sb.from('portal_chat')
            .select('id,room,sender_id,sender_name,role,message,created_at')
            .eq('room', room)
            .order('created_at', { ascending:true })
            .limit(200);
          if(error){
            chatSetupHint.style.display='block';
            chatStatus.textContent='Unavailable';
            return;
          }
          chatSetupHint.style.display='none';
          (data||[]).forEach(renderMsg);
          chatBox.scrollTop = chatBox.scrollHeight;
          chatStatus.textContent = 'Live';
        }catch(e){
          chatSetupHint.style.display='block';
          chatStatus.textContent = 'Unavailable';
        }
      }

      function subscribeChat(room){
        if (!ENABLE_CHAT) return null;
        if(chatSubscription){ sb.removeChannel(chatSubscription); chatSubscription = null; }
        chatSubscription = sb.channel('portal_chat_room_'+room)
          .on('postgres_changes', { event:'INSERT', schema:'public', table:'portal_chat', filter: 'room=eq.'+room }, payload => {
            renderMsg(payload.new);
            chatBox.scrollTop = chatBox.scrollHeight;
          })
          .subscribe(status => {
            chatStatus.textContent = status === 'SUBSCRIBED' ? 'Live' : ('Status: ' + status);
          });
      }

      async function sendChat(){
        if (!ENABLE_CHAT) return;
        const txt = (chatInput.value || '').trim();
        if(!txt) return;
        const roomSel = chatRoomSel.value;
        const room = roomSel === 'dm' ? ('dm:' + currentUser.id) : 'global';
        chatInput.value = '';
        const { data:prof } = await sb.from('profiles').select('name,role').eq('id', currentUser.id).maybeSingle();
        const senderName = prof?.name || currentUser.email || 'User';
        const role = (prof?.role || '').toString().trim().toLowerCase() || 'student';
        const { error } = await sb.from('portal_chat').insert([{ room, sender_id: currentUser.id, sender_name: senderName, role, message: txt }]);
        if(error){
          chatSetupHint.style.display='block';
          alert('Send failed: ' + error.message);
        }
      }

      async function initChat(){
        if (!ENABLE_CHAT) { if (chatSection) chatSection.style.display='none'; return; }
        if(!currentUser){ chatSection.style.display='none'; return; }
        dmRoom = 'dm:' + currentUser.id;
        chatSection.style.display='block';
        const roomSel = chatRoomSel.value;
        const room = roomSel === 'dm' ? dmRoom : 'global';
        await loadChat(room);
        subscribeChat(room);

        chatRoomSel.onchange = async ()=>{
          const nextRoom = chatRoomSel.value === 'dm' ? dmRoom : 'global';
          await loadChat(nextRoom);
          subscribeChat(nextRoom);
        };
        chatSend.onclick = sendChat;
        chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });
      }

      function pad(n){ return String(n).padStart(2,'0'); }

      async function refreshUI() {
        try {
          const { data: { session} } = await sb.auth.getSession();
          if (!session?.user) {
            currentUser = null;
            currentRole = 'unknown';
            setNav(false);
            if (window.__loadHomeNotifications) window.__loadHomeNotifications(sb);
            return;
          }
          setNav(true);
          currentUser = session.user;
          const { data: profile, error: profErr } = await sb
            .from('profiles')
            .select('name, role, prn, batch, avatar_path, approved, active')
            .eq('id', currentUser.id)
            .maybeSingle();
          if (profErr) console.warn('Profile fetch error:', profErr);
          currentRole = (profile?.role || 'unknown').toString().trim().toLowerCase();

          const approved = !!profile?.approved;
          const active = !!profile?.active;
          const isAdmin = currentRole === 'admin';
          const isApprovedActive = (approved && active) || isAdmin;

          // Admin UI bits
          if (isAdmin) {
            if (adminPortalLink) adminPortalLink.style.display = 'inline';
            if (pcAdminBtn) pcAdminBtn.style.display = 'inline-flex';
          } else {
            if (adminPortalLink) adminPortalLink.style.display = 'none';
            if (pcAdminBtn) pcAdminBtn.style.display = 'none';
          }

          // Show profile card
          if (profileCard) profileCard.style.display = 'block';
          pcName.textContent = ('Welcome ' + (profile?.name ? profile.name : '')).trim() || 'Welcome';
          pcRole.textContent = isAdmin ? 'Admin' : (currentRole === 'student' ? 'Student' : 'Role: Unknown');

          // Student meta
          if (currentRole === 'student') {
            const showPRN = !!(profile?.prn && profile.prn.trim());
            const showBatch = !!(profile?.batch && profile.batch.trim());
            pcPRN.textContent = 'PRN: ' + (showPRN ? profile.prn : '—');
            pcBatch.textContent = 'Batch: ' + (showBatch ? profile.batch : '—');
            pcMeta.style.display = (showPRN || showBatch) ? 'flex' : 'none';
          } else {
            pcMeta.style.display = 'none';
          }

          // Message
          if (isAdmin) {
            pcMessage.textContent = 'You have admin access. Use the Admin Portal for releases, deadlines, notifications, and communication.';
          } else if (currentRole === 'student') {
            pcMessage.textContent = 'Access your assessments and track your progress. Ensure your profile is up to date.';
          } else {
            pcMessage.textContent = 'Set up your profile to get the best experience.';
          }

          // Gated nav + buttons
          if (assessmentTab) assessmentTab.style.display = isApprovedActive ? 'inline' : 'none';
          if (resultsTab) resultsTab.style.display = isApprovedActive ? 'inline' : 'none';
          if (pcStartAssessments) pcStartAssessments.style.display = isApprovedActive ? 'inline-flex' : 'none';
          if (pcViewResults) pcViewResults.style.display = isApprovedActive ? 'inline-flex' : 'none';

          // Friendly banners: deactivated > pending > incomplete profile
          if (!active && !isAdmin) {
            pcNote.style.display = 'block';
            pcNote.textContent = 'Your account is deactivated. Please contact an administrator.';
          } else if (!approved && !isAdmin) {
            pcNote.style.display = 'block';
            pcNote.textContent = 'Your account is awaiting admin approval.';
          } else {
            const baseComplete = !!(profile?.name && profile?.role);
            const studentComplete = baseComplete && !!(profile?.prn && profile?.batch);
            const adminComplete = baseComplete;
            const isComplete = isAdmin ? adminComplete : (currentRole === 'student' ? studentComplete : baseComplete);
            if (!isComplete) {
              pcNote.style.display = 'block';
              pcNote.textContent = currentRole === 'student'
                ? 'Your profile looks incomplete. Please add your PRN and Batch.'
                : 'Please complete your profile details for a better experience.';
            } else {
              pcNote.style.display = 'none';
            }
          }

          // Avatar
          const avatarPath = profile?.avatar_path || null;
          await setSignedAvatar(avatarPath);
          startAvatarAutoRefresh(avatarPath);

          // Chat
          await initChat();

          // Notifications
          if (window.__loadHomeNotifications) window.__loadHomeNotifications(sb);
        } catch (e) {
          console.error('refreshUI error:', e);
        }
      }

      refreshUI();
      if (window.__loadHomeNotifications) window.__loadHomeNotifications(sb);

      sb.auth.onAuthStateChange((_event, _session) => {
        refreshUI();
        if (window.__loadHomeNotifications) window.__loadHomeNotifications(sb);
      });
      window.addEventListener('focus', () => {
        refreshUI();
        if (window.__loadHomeNotifications) window.__loadHomeNotifications(sb);
      });

      function protectLink(el, requireAdmin=false){
        if(!el) return;
        el.addEventListener('click', async (e) => {
          const { data: { session } } = await sb.auth.getSession();
          if (!session?.user) {
            e.preventDefault();
            window.location.href = 'login_Version4.html';
            return;
          }
          if (requireAdmin) {
            const role = await getUserRole(session.user.id);
            if (role !== 'admin') {
              e.preventDefault();
              alert('Admin only.');
            }
          }
        });
      }

      // Keep admin-only protection for Admin Portal
      protectLink(adminPortalLink, true);
      protectLink(document.getElementById('pc-admin-portal'), true);

      // Gate Assessments/Results by approval/active
      protectLinkApproved(assessmentTab, ['student','admin']);
      protectLinkApproved(resultsTab, ['student','admin']);
      protectLinkApproved(pcStartAssessments, ['student','admin']);
      protectLinkApproved(pcViewResults, ['student','admin']);

      if (logoutBtn) {
        logoutBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          try { await sb.auth.signOut({ scope: 'global' }); } catch (err) { /* ignore */ }
          try { await sb.auth.signOut({ scope: 'local'  }); } catch (err) { /* ignore */ }
          try {
            for (const k of Object.keys(localStorage)) {
              const key = k.toLowerCase();
              if (key.includes('supabase') || key.startsWith('sb-')) localStorage.removeItem(k);
            }
            for (const k of Object.keys(sessionStorage)) {
              const key = k.toLowerCase();
              if (key.includes('supabase') || key.startsWith('sb-')) sessionStorage.removeItem(k);
            }
          } catch (e2) { /* ignore */ }
          try { indexedDB.deleteDatabase('supabase-auth'); } catch (e3) { /* ignore */ }
          window.location.replace('index.html');
        });
      }
    });
  </script>
</body>
</html>
