<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Results | Human Anatomy & Physiology Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; color: #222; background: #f6f9ff; }
    header { padding: 1rem; background: #e3f2fd; border-bottom: 1px solid #cfe0ff; }
    header .row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    header a { color:#1565c0; text-decoration:none; font-weight:600; }
    h1 { margin: 0; font-size: 1.4rem; color:#0d47a1; }
    main { max-width: 1100px; margin: 18px auto; padding: 0 12px 24px; }
    .panel { background: #fff; border: 1px solid #cfe0ff; border-radius: 10px; padding: 14px; margin-bottom: 14px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .muted { color:#375a9e; font-size: 0.95rem; }
    .badge { display:inline-block; font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid #cfe0ff; color:#375a9e; }
    .input, select { width:100%; padding:10px; border:1px solid #cfe0ff; border-radius:8px; background:#fff; }
    .btn { background:#1565c0; color:#fff; border:0; padding:9px 12px; border-radius:8px; cursor:pointer; }
    .btn.ghost { background:transparent; color:#1565c0; border:1px solid #cfe0ff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .stat { background:#f5faff; border:1px solid #cfe0ff; border-radius:8px; padding:10px; }
    .stat .label { font-size:12px; color:#375a9e; }
    .stat .value { font-size:20px; font-weight:700; color:#0d47a1; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px dashed #cfe0ff; padding: 8px 6px; text-align: left; border-right: 1px solid #cfe0ff;}
    th:last-child, td:last-child { border-right: none;}
    th { background: #f0f6ff; color:#1565c0; position: sticky; top: 0; z-index: 1; }
    tbody tr:hover { background: #f9fbff; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#e3f2fd; color:#0d47a1; font-weight:600; }
    .assignment-link { color: #0d47a1; text-decoration: underline; }
    .assignment-mark-btn { color: #fff; background: #43a047; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; }
    .assignment-edit-btn { color: #fff; background: #fbc02d; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; }
    .assignment-reupload-btn { color: #fff; background: #1976d2; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; }
    .assignment-reupload-btn:disabled { background: #bdbdbd; color: #888; cursor: not-allowed;}
    .feedback-correct { color: #388e3c; }
    .feedback-wrong { color: #d32f2f; }
    .feedback-explanation { color: #6a1b9a; font-size: 0.98em; }
    .details-btn { color: #fff; background: #1565c0; border:none; border-radius:5px; padding:6px 10px; cursor:pointer;}
    .details-btn:disabled { background: #bdbdbd; color: #888; cursor: not-allowed;}
    .modal-bg { display:none; position:fixed; top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);justify-content:center;align-items:center;z-index:99;}
    .modal-content { background: #fff; border-radius: 8px; padding: 24px; box-shadow: 0 2px 16px #cfe0ff; max-width: 700px; max-height: 90vh; overflow:auto;}
    .close-modal-btn { float:right; background:#cfe0ff; color:#1565c0; border:none; border-radius:5px; padding:4px 10px; cursor:pointer; margin-left:8px;}
    .options-list { margin-left: 1em; margin-bottom: 0.4em;}
    .option-correct { font-weight: bold; color: #388e3c; }
    .option-wrong { color: #d32f2f; }
    .option-normal { color: #222; }
    @media (max-width: 640px) { th:nth-child(3), td:nth-child(3), th:nth-child(6), td:nth-child(6) { display:none; } }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <a href="index.html">← Home</a>
      <h1>Results</h1>
      <span id="role-badge" class="badge">Loading…</span>
      <span id="status" class="muted" style="margin-left:auto">Initializing…</span>
    </div>
  </header>

  <main>
    <section id="student-summary" class="panel" style="display:none;">
      <div class="row" style="margin-bottom:8px;">
        <div class="muted">Your performance summary</div>
      </div>
      <div class="grid">
        <div class="stat"><div class="label">Total Attempts</div><div class="value" id="sum-attempts">0</div></div>
        <div class="stat"><div class="label">Average %</div><div class="value" id="sum-avg">0%</div></div>
        <div class="stat"><div class="label">Best %</div><div class="value" id="sum-best">0%</div></div>
        <div class="stat"><div class="label">Last Attempt</div><div class="value" id="sum-last">—</div></div>
      </div>
    </section>
    <section id="filters" class="panel" style="display:none;">
      <div class="row" style="margin-bottom:8px;">
        <div class="muted">Filters</div>
      </div>
      <div class="grid">
        <div>
          <label class="muted">Experiment</label>
          <select id="filter-experiment">
            <option value="">All experiments</option>
          </select>
        </div>
        <div id="admin-search-wrap" style="display:none;">
          <label class="muted">Search (name/email/PRN)</label>
          <input id="filter-search" class="input" type="text" placeholder="e.g., john, 2023-PRN-001, gmail.com" />
        </div>
        <div id="admin-batch-wrap" style="display:none;">
          <label class="muted">Batch</label>
          <input id="filter-batch" class="input" type="text" placeholder="e.g., B1, 2024" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="apply" class="btn">Apply</button>
        <button id="reset" class="btn ghost">Reset</button>
      </div>
    </section>
    <section class="panel">
      <div class="row" style="margin-bottom:8px;">
        <div class="muted">Results</div>
        <span id="count" class="pill" style="margin-left:8px;">0</span>
        <div style="margin-left:auto;" class="muted" id="who"></div>
      </div>
      <div style="overflow:auto; max-height: 65vh;">
        <table>
          <thead>
            <tr>
              <th>Student</th>
              <th>Assessment</th>
              <th>PRN</th>
              <th>Batch</th>
              <th>Score</th>
              <th>%</th>
              <th>Submitted</th>
              <th>Duration</th>
              <th>Assignment (PDF)</th>
              <th>Marks</th>
              <th>Details</th>
              <th>Reupload Assignment</th>
              <th>Edit</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="13" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </section>
    <section id="legend" class="panel">
      <div class="muted">Tip: Click “Details” for per-question breakdown, and “Reupload” to change assignment if allowed.</div>
    </section>
  </main>

  <!-- Details Modal -->
  <div id="detailsModalBg" class="modal-bg">
    <div class="modal-content" id="detailsModalContent">
      <button class="close-modal-btn" onclick="closeDetailsModal()">Close</button>
      <div id="detailsModalBody"></div>
    </div>
  </div>
  <!-- Edit Modal (stub for backend integration) -->
  <div id="editModalBg" class="modal-bg">
    <div class="modal-content" id="editModalContent">
      <button class="close-modal-btn" onclick="closeEditModal()">Close</button>
      <h3>Edit Assignment Editability</h3>
      <form id="editForm">
        <label>
          <input type="checkbox" id="editCheckbox"> Allow student to reupload assignment
        </label>
        <button type="submit" class="btn">Save</button>
      </form>
      <div class="muted" style="margin-top:10px;">(TODO: Save editability to backend)</div>
    </div>
  </div>
  <!-- Reupload Modal (student) -->
  <div id="reuploadModalBg" class="modal-bg">
    <div class="modal-content" id="reuploadModalContent">
      <button class="close-modal-btn" onclick="closeReuploadModal()">Close</button>
      <h3>Reupload Assignment</h3>
      <form id="reuploadForm">
        <input type="file" id="reuploadFile" accept="application/pdf" required>
        <button type="submit" class="btn">Upload</button>
      </form>
      <div id="reuploadStatus" class="muted" style="margin-top:10px;"></div>
      <div class="muted" style="margin-top:10px;">(TODO: Save new assignment PDF to backend)</div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script>
    // --- Assessment Questions & Options (for Details Modal) ---
    const assessmentQuestions = [
      { type: "mcq", text: "1. Which part of the compound microscope connects the base to the body tube?", options: ["Arm","Stage","Pillar","Draw tube"], answer: "Arm", explanation: "The arm connects the base to the body tube." },
      { type: "mcq", text: "2. The function of the diaphragm in a compound microscope is to:", options: ["Magnify the image","Adjust the amount of light passing through the specimen","Hold the slide in place","Focus the image"], answer: "Adjust the amount of light passing through the specimen", explanation: "Diaphragm adjusts the amount of light passing through the specimen." },
      { type: "mcq", text: "3. Which lens offers the highest magnification in a compound microscope?", options: ["Low power objective","High power objective","Oil immersion objective","Eyepiece lens"], answer: "Oil immersion objective", explanation: "Oil immersion objective lens gives highest magnification." },
      { type: "mcq", text: "4. Which adjustment knob is used for precise focusing?", options: ["Coarse adjustment","Fine adjustment","Stage adjustment","Condenser adjustment"], answer: "Fine adjustment", explanation: "Fine adjustment knob is used for precise focusing." },
      { type: "dropdown", text: "5. Name the lens through which you observe the specimen in a microscope.", options: ["Eyepiece lens","Objective lens","Mirror","Stage"], answer: "Eyepiece lens", explanation: "Eyepiece lens is used for observing specimen." },
      { type: "dropdown", text: "6. What is the recommended material for cleaning microscope lenses?", options: ["Lens paper","Tissue paper","Cloth","Hands"], answer: "Lens paper", explanation: "Lens paper is recommended for cleaning." },
      { type: "dropdown", text: "7. Which mirror is used when the light source is weak?", options: ["Concave mirror","Plane mirror","Convex mirror","No mirror"], answer: "Concave mirror", explanation: "Concave mirror is used for weak light sources." },
      { type: "dropdown", text: "8. What is the usual magnification power of a standard eyepiece lens?", options: ["10x","5x","40x","100x"], answer: "10x", explanation: "Standard eyepiece lens is usually 10x." },
      { type: "image-labels", text: "9. Identify the labelled parts of the microscope in the image below.", image: "../assets/images/experiment-1/Assessment/labelquestion.jpg",
        labels: [
          { name: "1", answer: "Eye Piece", options: ["Eye Piece","Objective Lens","Fine adjustment Screw","Condenser","Stage"], explanation: "Label 1 is Eye Piece." },
          { name: "2", answer: "Objective Lens", options: ["Objective Lens","Eye Piece","Mirror","Condenser","Base"], explanation: "Label 2 is Objective Lens." },
          { name: "3", answer: "Condenser", options: ["Condenser","Stage","Objective Lens","Base","Fine adjustment Screw"], explanation: "Label 3 is Condenser." },
          { name: "4", answer: "Fine adjustment Screw", options: ["Fine adjustment Screw","Coarse adjustment","Mirror","Arm","Condenser"], explanation: "Label 4 is Fine adjustment Screw." }
        ]
      },
      { type: "mcq", text: "10. Which of the following statements is NOT true?", options: [
        "When focusing the slide, care should be taken not to crack the glass slide",
        "The slide should be placed on the stage with the cover slip on the upper surface",
        "When setting up, adjust the eye pieces to the dimension of your eyes",
        "Always view your specimen using the highest magnification lens first"
      ], answer: "Always view your specimen using the highest magnification lens first", explanation: "Highest magnification lens should NOT be used first." }
    ];

    // Supabase setup
    const sb = window.sb || (window.supabase.createClient(
      'https://hunlistfklwvpivfjmbk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bmxpc3Rma2x3dnBpdmZqbWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzA1NDUsImV4cCI6MjA3MzQwNjU0NX0.e-o_qL1Uf5DpW4gX60ktXyuUXmw5YWhqaw6Cx8Xc8Qs'
    ));

    const $ = (s) => document.querySelector(s);
    const statusEl = $('#status');
    const roleBadge = $('#role-badge');
    const studentSummary = $('#student-summary');
    const sumAttempts = $('#sum-attempts');
    const sumAvg = $('#sum-avg');
    const sumBest = $('#sum-best');
    const sumLast = $('#sum-last');
    const filters = $('#filters');
    const filterExperiment = $('#filter-experiment');
    const adminSearchWrap = $('#admin-search-wrap');
    const adminBatchWrap = $('#admin-batch-wrap');
    const filterSearch = $('#filter-search');
    const filterBatch = $('#filter-batch');
    const btnApply = $('#apply');
    const btnReset = $('#reset');
    const who = $('#who');
    const tbody = $('#tbody');
    const count = $('#count');

    // Modals
    let detailsModalBg = $('#detailsModalBg');
    let detailsModalBody = $('#detailsModalBody');
    let editModalBg = $('#editModalBg');
    let editCheckbox = $('#editCheckbox');
    let editForm = $('#editForm');
    let reuploadModalBg = $('#reuploadModalBg');
    let reuploadStatus = $('#reuploadStatus');
    let reuploadForm = $('#reuploadForm');
    let reuploadFile = $('#reuploadFile');

    // State
    let currentUser = null;
    let isAdmin = false;
    let currentEditRow = null;
    let currentReuploadRow = null;

    function setStatus(msg){ statusEl.textContent = msg; }
    function fmtPct(n){ if (n == null) return '—'; const v = Math.round(n * 100) / 100; return v.toFixed(2) + '%'; }
    function fmtDate(s){ if (!s) return '—'; const d = new Date(s); return d.toLocaleString(); }
    function fmtDur(sec){ if (!sec && sec!==0) return '—'; const s = Number(sec)||0; const m = Math.floor(s/60), rem = s%60; return m + 'm ' + rem + 's'; }
    function has(v){ return typeof v === 'string' ? v.trim().length>0 : !!v; }

    async function requireLogin() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session?.user) {
        window.location.replace('login_Version4.html');
        return false;
      }
      currentUser = session.user;
      return true;
    }
    async function getRole(userId) {
      const { data, error } = await sb.from('profiles').select('role').eq('id', userId).maybeSingle();
      if (error) console.warn('role error', error);
      return (data?.role || 'unknown').toString().trim().toLowerCase();
    }
    async function loadExperiments() {
      try {
        const { data, error } = await sb.rpc('list_experiments_for_results');
        if (!error && Array.isArray(data)) {
          for (const row of data) {
            const opt = document.createElement('option');
            opt.value = row.experiment_id || '';
            opt.textContent = row.experiment_id || '(untitled)';
            filterExperiment.appendChild(opt);
          }
        }
      } catch (e) { console.warn('loadExperiments', e); }
    }
    async function fetchResults({ exp_id = '', search = '', batch = '' } = {}) {
      const args = {
        exp_id: has(exp_id) ? exp_id : null,
        search_text: has(search) ? search : null,
        batch_text: has(batch) ? batch : null
      };
      const { data, error } = await sb.rpc('get_assessment_results', args);
      if (error) throw error;
      return Array.isArray(data) ? data : [];
    }
    function renderSummaryForStudent(rows) {
      const attempts = rows.length;
      const percents = rows.map(r => Number(r.percent)).filter(n => !Number.isNaN(n));
      const avg = percents.length ? (percents.reduce((a,b)=>a+b,0)/percents.length) : 0;
      const best = percents.length ? Math.max(...percents) : 0;
      const last = rows.slice().sort((a,b) => new Date(b.submitted_at||0)-new Date(a.submitted_at||0))[0]?.submitted_at;

      sumAttempts.textContent = attempts;
      sumAvg.textContent = fmtPct(avg);
      sumBest.textContent = fmtPct(best);
      sumLast.textContent = fmtDate(last);
      studentSummary.style.display = 'block';
    }

    // --- Details Modal logic ---
    function openDetailsModal(row) {
      // Ensure breakdown is parsed from string to array if needed
      if (typeof row.breakdown === 'string') {
        try {
          row.breakdown = JSON.parse(row.breakdown);
        } catch(e) {
          console.error("Could not parse breakdown", e);
          row.breakdown = [];
        }
      }
      detailsModalBg.style.display = "flex";
      detailsModalBody.innerHTML = renderDetailsBreakdown(row);
    }
    function closeDetailsModal() {
      detailsModalBg.style.display = "none";
      detailsModalBody.innerHTML = "";
    }
    window.closeDetailsModal = closeDetailsModal;

    function getAssessmentQuestionDetails(qObj) {
      // For MCQ/dropdown, match by question text.
      for (let i = 0; i < assessmentQuestions.length; i++) {
        let aq = assessmentQuestions[i];
        if (aq.type === "image-labels") {
          if (qObj.type === "image-label") {
            let match = aq.labels.find(lab =>
              qObj.question && qObj.question.indexOf(`Label ${lab.name}`) !== -1
            );
            if (match) return { ...match, parentText: aq.text, type: "image-label" };
          }
        } else if (aq.text === qObj.question) {
          return aq;
        }
      }
      return null;
    }

    function renderDetailsBreakdown(row) {
      if (!row.breakdown || !Array.isArray(row.breakdown) || row.breakdown.length === 0) {
        return "<div>No breakdown data found.<br><span class='muted'>Please check if the backend returns a <b>breakdown</b> array for each result row.</span></div>";
      }
      let html = `<h3>Question Breakdown</h3>`;
      row.breakdown.forEach((q, idx) => {
        if (q.type === "meta") return;
        let aq = getAssessmentQuestionDetails(q);
        let feedbackClass = q.isCorrect ? "feedback-correct" : "feedback-wrong";
        let correct = q.correct || (aq && aq.answer) || "";
        let explanation = (aq && aq.explanation) ? `<div class="feedback-explanation">Explanation: ${aq.explanation}</div>` : "";
        let optionsHtml = "";
        if (aq && aq.options) {
          optionsHtml = `<div class="options-list">Options: `;
          optionsHtml += aq.options.map(opt => {
            if (opt === correct) return `<span class="option-correct">${opt}</span>`;
            if (opt === q.answer && !q.isCorrect) return `<span class="option-wrong">${opt}</span>`;
            return `<span class="option-normal">${opt}</span>`;
          }).join(", ");
          optionsHtml += `</div>`;
        }
        if (aq && aq.type === "image-label") {
          html += `<div style="border-bottom:1px solid #eee; margin-bottom:1em;">
            <b>Q${idx+1}:</b> ${aq.parentText} <span class="muted">(Label ${aq.name})</span><br>
            ${optionsHtml}
            <div style="margin-left:1em;">
              <span class="${feedbackClass}">Your answer: <i>${q.answer || "(blank)"}</i> – <b>${q.isCorrect ? "Correct" : "Wrong"}</b></span><br>
              ${!q.isCorrect ? `<span class="feedback-correct">Correct answer: <b>${correct}</b></span><br>${explanation}` : ""}
            </div>
          </div>`;
        } else {
          html += `<div style="border-bottom:1px solid #eee; margin-bottom:1em;">
            <b>Q${idx+1}:</b> ${q.question}<br>
            ${optionsHtml}
            <div style="margin-left:1em;">
              <span class="${feedbackClass}">Your answer: <i>${q.answer || "(blank)"}</i> – <b>${q.isCorrect ? "Correct" : "Wrong"}</b></span><br>
              ${!q.isCorrect ? `<span class="feedback-correct">Correct answer: <b>${correct}</b></span><br>${explanation}` : ""}
            </div>
          </div>`;
        }
      });
      return html;
    }

    // Edit Modal logic
    function openEditModal(row) {
      editModalBg.style.display = "flex";
      currentEditRow = row;
      editCheckbox.checked = row.assignment_editable ?? false;
    }
    function closeEditModal() {
      editModalBg.style.display = "none";
      currentEditRow = null;
    }
    window.closeEditModal = closeEditModal;
    editForm.onsubmit = (e) => {
      e.preventDefault();
      alert('Assignment editability set to: ' + editCheckbox.checked + '\n(TODO: Save to backend)');
      closeEditModal();
    };
    function openReuploadModal(row) {
      reuploadModalBg.style.display = "flex";
      currentReuploadRow = row;
      reuploadStatus.textContent = "";
      reuploadForm.reset();
    }
    function closeReuploadModal() {
      reuploadModalBg.style.display = "none";
      currentReuploadRow = null;
    }
    window.closeReuploadModal = closeReuploadModal;
    reuploadForm.onsubmit = async (e) => {
      e.preventDefault();
      let file = reuploadFile.files[0];
      if (!file) {
        reuploadStatus.textContent = "Please select a PDF file.";
        return;
      }
      if (file.type !== "application/pdf" && !/\.pdf$/i.test(file.name)) {
        reuploadStatus.textContent = "Only PDF files allowed.";
        return;
      }
      reuploadStatus.textContent = "PDF uploaded (stub; integrate backend).";
      setTimeout(closeReuploadModal, 1000);
    };

    function renderRows(rows) {
      count.textContent = rows.length;
      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="13" class="muted">No results.</td></tr>';
        return;
      }
      const parts = [];
      rows.forEach((r, rowIdx) => {
        const student = r.user_name || r.email || r.user_id;
        const prn = r.meta?.prn || r.prn || '—';
        const batch = r.meta?.batch || r.batch || '—';
        const scoreTxt = (r.score != null && r.total != null) ? `${r.score}/${r.total}` : (r.score ?? '—');
        const assignmentUrl = r.assignment_path ? sb.storage.from(r.assignment_bucket || "assignments").getPublicUrl(r.assignment_path).data?.publicUrl : null;
        const assignmentMarks = r.assignment_marks ?? '—';
        const assignmentEditable = r.assignment_editable ?? true;

        let canReupload = assignmentEditable && (!r.assignment_marks || r.assignment_marks === '—');
        let canEdit = isAdmin;

        parts.push(`
          <tr>
            <td>${student || '—'}<div class="muted" style="font-size:12px">${r.meta?.email || r.email || ''}</div></td>
            <td>${r.meta?.assessment_title || r.assessment_title || '—'}</td>
            <td>${prn}</td>
            <td>${batch}</td>
            <td>${scoreTxt}</td>
            <td>${fmtPct(r.percent)}</td>
            <td>${fmtDate(r.submitted_at)}</td>
            <td>${fmtDur(r.duration_sec)}</td>
            <td>
              ${assignmentUrl
                ? `<a href="${assignmentUrl}" target="_blank" class="assignment-link">Download</a>`
                : '<span class="muted">Not uploaded</span>'}
            </td>
            <td>${assignmentMarks}</td>
            <td>
              <button class="details-btn" onclick="window.openDetailsModalRow(${rowIdx})">Details</button>
            </td>
            <td>
              <button class="assignment-reupload-btn" onclick="window.openReuploadModalRow(${rowIdx})" ${canReupload ? "" : "disabled"}>Reupload</button>
            </td>
            <td>
              ${canEdit ? `<button class="assignment-edit-btn" onclick="window.openEditModalRow(${rowIdx})">Edit</button>` : ""}
            </td>
          </tr>
        `);
      });
      tbody.innerHTML = parts.join('');
      window.openDetailsModalRow = (rowIdx) => openDetailsModal(rows[rowIdx]);
      window.openEditModalRow = (rowIdx) => openEditModal(rows[rowIdx]);
      window.openReuploadModalRow = (rowIdx) => openReuploadModal(rows[rowIdx]);
    }

    async function applyFilters() {
      try {
        setStatus('Loading…');
        const exp_id = filterExperiment.value || '';
        const search = filterSearch?.value || '';
        const batch = filterBatch?.value || '';
        const rows = await fetchResults({ exp_id, search, batch });
        renderRows(rows);
        if (!isAdmin) renderSummaryForStudent(rows);
        setStatus('Ready.');
      } catch (e) {
        console.error('applyFilters error', e);
        tbody.innerHTML = '<tr><td colspan="13" class="muted">Failed to load results.</td></tr>';
        setStatus('Failed.');
        alert('Error loading results: ' + (e?.message || e));
      }
    }

    async function init() {
      if (!(await requireLogin())) return;
      const role = await getRole(currentUser.id);
      isAdmin = (role === 'admin');
      roleBadge.textContent = isAdmin ? 'Admin' : 'Student';
      roleBadge.style.borderColor = isAdmin ? '#2ea043' : '#cfe0ff';
      roleBadge.style.color = isAdmin ? '#0a5' : '#375a9e';

      filters.style.display = 'block';
      if (isAdmin) {
        adminSearchWrap.style.display = 'block';
        adminBatchWrap.style.display = 'block';
        who.textContent = 'Viewing: all students (filtered)';
      } else {
        who.textContent = 'Viewing: your attempts';
        studentSummary.style.display = 'block';
      }
      await loadExperiments();

      const urlExp = new URLSearchParams(location.search).get('exp');
      if (urlExp) filterExperiment.value = urlExp;

      btnApply.addEventListener('click', () => applyFilters());
      btnReset.addEventListener('click', () => {
        filterExperiment.value = '';
        if (filterSearch) filterSearch.value = '';
        if (filterBatch) filterBatch.value = '';
        applyFilters();
      });
      await applyFilters();
      setStatus('Ready.');
    }

    init();
  </script>
</body>
</html>
