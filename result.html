function renderRows(rows) {
  currentRows = rows;
  count.textContent = rows.length;
  if (!rows.length) {
    tbody.innerHTML = '<tr><td colspan="12" class="muted">No results.</td></tr>';
    return;
  }
  const parts = [];
  rows.forEach((r, rowIdx) => {
    const email = r.meta?.email || r.email || '';
    const prn = r.meta?.prn || r.prn || '—';
    const batch = r.meta?.batch || r.batch || '—';
    const assessmentTitle = r.meta?.assessment_title || r.assessment_title || '—';
    const percentVal = r.percent ?? r.percentage;
    const scoreNum = Number(r.score);
    const totalNum = Number(r.total);
    const scoreTxt = (scoreNum != null && totalNum != null && !isNaN(scoreNum) && !isNaN(totalNum))
      ? `${scoreNum}/${totalNum}`
      : (r.score ?? '—');
    const marksVal = r.assignment_marks != null ? Number(r.assignment_marks) : null;

    let marksCell = '';
    if (isAdmin) {
      marksCell = `<div class="marks-cell">
        <input class="marks-input" id="marks-input-${r.id}" type="number" min="0" max="50" value="${marksVal != null ? marksVal : ''}" placeholder="-" />
        <button class="btn small" id="marks-save-${r.id}" onclick="saveAssignmentMarks(${rowIdx})">Save</button>
        <span id="marks-status-${r.id}" class="marks-status">${marksVal != null ? 'Saved' : '<span class="marks-pending">Pending</span>'}</span>
      </div>`;
    } else {
      marksCell = `<span class="marks-label">${marksVal != null ? marksVal : '<span class="marks-pending">Pending</span>'}</span>`;
    }
    const totalMarks = (scoreNum || 0) + (marksVal || 0);
    const totalMarksTxt = `<span class="total-marks">${totalMarks}/${isNaN(totalNum) ? '?' : totalNum + (isNaN(marksVal)?0:marksVal)}</span>`;
    
    // Assignment column: show correct button for PDF/image
    let assignmentBtn = `<span class="muted" style="font-size:13px;">—</span>`;
    const canViewAssignment = isAdmin || (currentUser && r.user_id === currentUser.id);
    if (r.assignment_path && canViewAssignment) {
      let btnLabel = "View File";
      if (r.assignment_type === "application/pdf") btnLabel = "View PDF";
      else if (r.assignment_type && r.assignment_type.startsWith("image/")) btnLabel = "View Image";
      assignmentBtn = `<button class="assignment-btn" onclick="viewAssignment(${rowIdx})">${btnLabel}</button>`;
    } else if (r.assignment_path) {
      assignmentBtn = `<span class="muted" style="font-size:13px;">Restricted</span>`;
    }

    // Resubmit column logic
    let resubmitCell = '<div class="resubmission-status-box">';
    if (isAdmin) {
      if (r.assignment_marks == null) {
        resubmitCell += `<span class="resubmission-status-message enabled">
          Student can resubmit until marks are given.
        </span>`;
      } else {
        resubmitCell += `
          <button class="btn ghost resubmission-toggle-btn" id="resubmission-toggle-${r.id}" onclick="toggleResubmission(${rowIdx})">
            ${r.resubmission_allowed ? 'Disable Resubmission' : 'Allow Resubmission'}
          </button>
          <span class="resubmission-status-message ${r.resubmission_allowed ? 'enabled' : 'disabled'}">
            ${r.resubmission_allowed ? 'Resubmission Enabled' : 'Resubmission Disabled'}
          </span>
        `;
      }
    }
    // Student can resubmit if marks are not allotted or admin has allowed resubmission
    if (!isAdmin && currentUser && r.user_id === currentUser.id &&
        (r.assignment_marks == null || r.resubmission_allowed)) {
      resubmitCell += `
        <button class="edit-assignment-btn" onclick="openEditAssignmentModal(${rowIdx})">Resubmit Assignment</button>
      `;
    }
    resubmitCell += `<div class="debug-log">Row ID: ${r.id}, resubmission_allowed: ${r.resubmission_allowed}</div>`;
    // --- ADD DETAILS TAB HERE ---
    resubmitCell += `
      <details>
        <summary>Details</summary>
        <pre style="text-align:left;overflow:auto;max-width:350px;max-height:200px;">${escapeHTML(JSON.stringify(r, null, 2))}</pre>
      </details>
    `;
    // --- END DETAILS TAB ADDITION ---
    resubmitCell += '</div>';

    parts.push(`
      <tr>
        <td>${escapeHTML(r.user_name || email || r.user_id || '—')}
          <div class="muted" style="font-size:11px">${escapeHTML(email)}</div>
        </td>
        <td>${escapeHTML(assessmentTitle)}</td>
        <td>${escapeHTML(prn)}</td>
        <td>${escapeHTML(batch)}</td>
        <td>${scoreTxt}</td>
        <td>${marksCell}</td>
        <td>${totalMarksTxt}</td>
        <td>${fmtPct(percentVal)}</td>
        <td>${fmtDate(r.submitted_at)}</td>
        <td>${fmtDur(r.duration_sec)}</td>
        <td>${assignmentBtn}</td>
        <td>${resubmitCell}</td>
      </tr>
    `);
  });
  tbody.innerHTML = parts.join('');
}
