<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Results | Human Anatomy & Physiology Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family:'Segoe UI',Arial,sans-serif; margin:0; color:#222; background:#f6f9ff; }
    header { padding:1rem; background:#e3f2fd; border-bottom:1px solid #cfe0ff; }
    header .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    header a { color:#1565c0; text-decoration:none; font-weight:600; }
    h1 { margin:0; font-size:1.4rem; color:#0d47a1; }
    main { max-width:1100px; margin:18px auto; padding:0 12px 24px; }
    .panel { background:#fff; border:1px solid #cfe0ff; border-radius:10px; padding:14px; margin-bottom:14px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .muted { color:#375a9e; font-size:.95rem; }
    .badge { display:inline-block; font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid #cfe0ff; color:#375a9e; }
    .input, select { width:100%; padding:10px; border:1px solid #cfe0ff; border-radius:8px; background:#fff; }
    .btn { background:#1565c0; color:#fff; border:0; padding:9px 12px; border-radius:8px; cursor:pointer; font-size:14px; }
    .btn.small { padding:6px 10px; font-size:12px; }
    .btn.ghost { background:transparent; color:#1565c0; border:1px solid #cfe0ff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border-bottom:1px dashed #cfe0ff; padding:8px 6px; text-align:left; vertical-align:top; }
    th { background:#f0f6ff; color:#1565c0; position:sticky; top:0; z-index:1; }
    tbody tr:hover { background:#f9fbff; }
    .assignment-btn { background:#1976d2; color:#fff; border:none; padding:6px 10px; border-radius:5px; cursor:pointer; font-size:13px; }
    .assignment-btn:disabled { background:#bdbdbd; color:#888; cursor:not-allowed; }
    .edit-assignment-btn { background:#43a047; color:#fff; border:none; padding:6px 10px; border-radius:5px; cursor:pointer; font-size:13px; }
    .edit-assignment-btn:disabled { background:#bdbdbd; color:#888; cursor:not-allowed; }
    .details-toggle-btn { background:#6d4caf; color:#fff; border:none; padding:4px 8px; margin-top:4px; border-radius:4px; font-size:12px; cursor:pointer; }
    .details-toggle-btn.open { background:#4527a0; }
    .marks-input { width:55px; padding:4px 6px; font-size:14px; border:1px solid #cfe0ff; border-radius:6px; margin-right:4px; }
    .marks-cell { display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .marks-label { font-size:13px; color:#0d47a1; }
    .marks-status { font-size:12px; color:#388e3c; }
    .marks-pending { color:#fbc02d; }
    .total-marks { font-weight:700; color:#1565c0; }
    .resubmission-status-box { display:flex; flex-direction:column; align-items:flex-start; text-align:left; gap:4px; }
    .resubmission-status-message { font-size:13px; font-weight:600; margin-top:4px; }
    .resubmission-status-message.enabled { color:#1976d2; }
    .resubmission-status-message.disabled { color:#888; }
    .resubmission-toggle-btn { margin-bottom:4px; }
    .debug-log { font-size:11px; color:#666; line-height:1.3; }
    /* Modal */
    #edit-assignment-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:1000; align-items:center; justify-content:center; }
    #edit-assignment-modal > div { background:#fff; border-radius:10px; max-width:420px; width:92%; margin:auto; padding:20px; box-shadow:0 4px 18px rgba(0,0,0,0.25); }
    #modal-debug { max-height:80px; overflow:auto; width:100%; background:#f7f9fe; border:1px solid #d4e4ff; padding:4px 6px; border-radius:4px; font-size:11px; }
    /* Details row */
    tr.details-row td { background:#f5f9ff; border-bottom:1px solid #cfe0ff; }
    .details-wrapper { width:100%; }
    .details-header { font-weight:600; color:#0d47a1; margin:4px 0 10px; display:flex; flex-wrap:wrap; gap:14px; font-size:13px; }
    .details-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:10px; }
    .q-card { background:#fff; border:1px solid #d0e4ff; border-radius:8px; padding:10px 12px; box-shadow:0 2px 4px rgba(0,0,0,0.04); display:flex; flex-direction:column; gap:6px; }
    .q-text { font-weight:600; color:#0d47a1; font-size:13px; }
    .ans-line { font-size:13px; }
    .ans-your { font-weight:500; }
    .ans-correct { color:#1b5e20; font-weight:600; }
    .ans-wrong { color:#c62828; font-weight:600; }
    .correct-answer-inline { color:#2e7d32; font-size:12px; font-weight:600; }
    .question-type-badge { background:#e3f2fd; padding:2px 6px; border-radius:999px; font-size:10px; color:#0d47a1; font-weight:600; }
    .no-breakdown { font-size:13px; color:#c62828; font-style:italic; }
    .export-bar { display:flex; flex-wrap:wrap; gap:8px; margin-left:auto; }
    @media (max-width:640px){
      th:nth-child(3), td:nth-child(3),
      th:nth-child(6), td:nth-child(6) { display:none; }
      .details-grid { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <a href="index.html">← Home</a>
      <h1>Results</h1>
      <span id="role-badge" class="badge">Loading…</span>
      <span id="status" class="muted" style="margin-left:auto">Initializing…</span>
    </div>
  </header>
  <main>
    <section id="student-summary" class="panel" style="display:none;">
      <div class="row" style="margin-bottom:8px;">
        <div class="muted">Your performance summary</div>
      </div>
      <div class="grid">
        <div class="stat"><div class="label">Total Attempts</div><div class="value" id="sum-attempts">0</div></div>
        <div class="stat"><div class="label">Average %</div><div class="value" id="sum-avg">0%</div></div>
        <div class="stat"><div class="label">Best %</div><div class="value" id="sum-best">0%</div></div>
        <div class="stat"><div class="label">Last Attempt</div><div class="value" id="sum-last">—</div></div>
      </div>
    </section>

    <section id="filters" class="panel">
      <div class="row" style="margin-bottom:8px;">
        <div class="muted">Filters</div>
      </div>
      <div class="grid">
        <div>
          <label for="filter-experiment" class="muted">Experiment</label>
          <select id="filter-experiment" aria-label="Experiment">
            <option value="">All experiments</option>
          </select>
        </div>
        <div id="admin-search-wrap" style="display:none;">
          <label for="filter-search" class="muted">Search (name/email/PRN)</label>
          <input id="filter-search" class="input" type="text" placeholder="e.g., john, 2023-PRN-001, gmail.com" />
        </div>
        <div id="admin-batch-wrap" style="display:none;">
          <label for="filter-batch" class="muted">Batch</label>
          <input id="filter-batch" class="input" type="text" placeholder="e.g., B1, 2024" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="apply" class="btn">Apply</button>
        <button id="reset" class="btn ghost">Reset</button>
        <div class="export-bar">
          <button id="export-summary" class="btn ghost" title="Export summary sheet (no question details)">Export (Summary)</button>
          <button id="export-details" class="btn ghost" title="Export results + question breakdown">Export (With Details)</button>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="row" style="margin-bottom:8px;">
        <div class="muted">Results</div>
        <span id="count" class="pill" style="margin-left:8px;">0</span>
        <div style="margin-left:auto;" class="muted" id="who"></div>
      </div>
      <div style="overflow:auto; max-height:65vh;">
        <table>
          <thead>
            <tr>
              <th>Student</th>
              <th>Assessment</th>
              <th>PRN</th>
              <th>Batch</th>
              <th>Score</th>
              <th>Assignment Marks</th>
              <th>Total Marks</th>
              <th>%</th>
              <th>Submitted (IST)</th>
              <th>Duration</th>
              <th>Assignment</th>
              <th>Resubmit</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="12" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section id="legend" class="panel">
      <div class="muted">
        Admins can edit assignment marks and toggle resubmission. Students may resubmit while marks are pending; afterward only if admin re-enables resubmission.<br>
        <span style="color:#388e3c;font-weight:600;">
          Detail button reveals per‑question correctness. Wrong answers show the correct answer.
        </span>
      </div>
    </section>

    <div id="edit-assignment-modal">
      <div>
        <h2 style="margin-top:0; color:#1976d2;">Resubmit Assignment</h2>
        <form id="edit-assignment-form">
          <div style="margin-bottom:12px;">
            <label for="assignmentFile" style="display:block; margin-bottom:4px;">Select PDF or Image Assignment:</label>
            <input type="file" id="assignmentFile" name="assignmentFile" accept="application/pdf,image/*" required />
          </div>
          <div class="row" style="justify-content:flex-end;">
            <button type="submit" class="btn">Submit</button>
            <button type="button" class="btn ghost" id="close-edit-modal">Cancel</button>
          </div>
        </form>
        <div id="modal-debug" class="debug-log"></div>
      </div>
    </div>
  </main>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    console.log('Result script loaded (uses submitted_at_utc, displays IST)');

    /***************** Utilities & Globals *****************/
    function debug(msg){
      console.log('[DEBUG]', msg);
      const box = document.getElementById('modal-debug');
      if(box) box.textContent = msg;
    }

    const sb = window.supabase.createClient(
      'https://hunlistfklwvpivfjmbk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bmxpc3Rma2x3dnBpdmZqbWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzA1NDUsImV4cCI6MjA3MzQwNjU0NX0.e-o_qL1Uf5DpW4gX60ktXyuUXmw5YWhqaw6Cx8Xc8Qs'
    );

    const $ = s => document.querySelector(s);
    const statusEl = $('#status');
    const roleBadge = $('#role-badge');
    const studentSummary = $('#student-summary');
    const sumAttempts = $('#sum-attempts');
    const sumAvg = $('#sum-avg');
    const sumBest = $('#sum-best');
    const sumLast = $('#sum-last');
    const filterExperiment = $('#filter-experiment');
    const filterSearch = $('#filter-search');
    const filterBatch = $('#filter-batch');
    const adminSearchWrap = $('#admin-search-wrap');
    const adminBatchWrap = $('#admin-batch-wrap');
    const who = $('#who');
    const tbody = $('#tbody');
    const countEl = $('#count');
    const btnApply = $('#apply');
    const btnReset = $('#reset');
    const btnExportSummary = $('#export-summary');
    const btnExportDetails = $('#export-details');

    let currentUser = null;
    let isAdmin = false;
    let currentRows = [];
    let editingRowIdx = null;

    function setStatus(msg){ statusEl.textContent = msg; }
    function fmtPct(n){
      if(n == null) return '—';
      const num = Number(n);
      if(Number.isNaN(num)) return '—';
      return (Math.round(num * 100) / 100).toFixed(2) + '%';
    }

    // Prefer the new UTC column; fallback to legacy submitted_at
    function getSubmittedAt(row){
      return row.submitted_at_utc || row.submitted_at;
    }

    // Force display in IST; robust parse for Postgres timestamps
    function fmtDate(s){
      if(!s) return '—';
      try {
        let iso = s;
        if (typeof s === 'string' && s.includes(' ') && !s.includes('T')) {
          // Safari-safe: convert "YYYY-MM-DD HH:MM:SS+00" to "YYYY-MM-DDTHH:MM:SS+00"
          iso = s.replace(' ', 'T');
        }
        return new Date(iso).toLocaleString('en-IN', {
          timeZone: 'Asia/Kolkata',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
      } catch(e){
        // Fallback manual shift +05:30
        const d = new Date(s);
        const utcMs = d.getTime() + d.getTimezoneOffset()*60000;
        const ist = new Date(utcMs + 5.5*3600000);
        const pad = n => String(n).padStart(2,'0');
        return `${pad(ist.getDate())}/${pad(ist.getMonth()+1)}/${ist.getFullYear()}, ${pad(ist.getHours())}:${pad(ist.getMinutes())}:${pad(ist.getSeconds())}`;
      }
    }

    function fmtDur(sec){
      if(sec==null) return '—';
      const s = Number(sec) || 0;
      const m = Math.floor(s/60);
      return m+'m '+(s%60)+'s';
    }
    function has(v){ return typeof v==='string' ? v.trim().length>0 : !!v; }
    function escapeHTML(str){
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    // EFFECTIVE RESUBMISSION RULE (frontend-only):
    // - If admin explicitly disabled (resubmission_allowed === false): block resubmission (even if marks pending).
    // - If marks are pending and admin did not disable: allow.
    // - After marks are given: allow only if resubmission_allowed === true.
    function effectiveResubAllowed(row){
      // Admin toggle is authoritative
      if (row.resubmission_allowed === false) return false;
      // While marks are pending, allow unless admin explicitly disabled
      if (row.assignment_marks == null) return true;
      // After marks are given, allow only if enabled
      return row.resubmission_allowed === true;
    }

    /***************** Auth & Role *****************/
    async function requireLogin(){
      const { data:{ session } } = await sb.auth.getSession();
      if(!session?.user){
        window.location.replace('login_Version4.html');
        return false;
      }
      currentUser = session.user;
      return true;
    }
    async function getRole(userId){
      const { data, error } = await sb.from('profiles').select('role').eq('id', userId).maybeSingle();
      if(error) console.warn('role error', error);
      return (data?.role || 'unknown').toLowerCase();
    }

    /***************** Data Fetch *****************/
    async function loadExperiments(){
      try{
        const { data, error } = await sb.rpc('list_experiments_for_results');
        if(error) { console.warn('list_experiments_for_results', error); return; }
        if(Array.isArray(data)){
          for(const row of data){
            const opt = document.createElement('option');
            opt.value = row.experiment_id || '';
            opt.textContent = row.experiment_id || '(untitled)';
            filterExperiment.appendChild(opt);
          }
        }
      } catch(e){ console.warn('loadExperiments', e); }
    }

    async function fetchResults({ exp_id='', search='', batch='' } = {}){
      const args = {
        exp_id: has(exp_id) ? exp_id : null,
        search_text: has(search) ? search : null,
        batch_text: has(batch) ? batch : null
      };
      const fn = isAdmin ? 'get_assessment_results_admin_v2' : 'get_results_student_test';
      const { data, error } = await sb.rpc(fn, args);
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }

    /***************** Summary *****************/
    function renderSummaryForStudent(rows){
      const attempts = rows.length;
      const percents = rows.map(r => Number(r.percent ?? r.percentage)).filter(n => !Number.isNaN(n));
      const avg = percents.length ? percents.reduce((a,b)=>a+b,0) / percents.length : 0;
      const best = percents.length ? Math.max(...percents) : 0;
      const lastRow = rows.slice().sort(
        (a,b)=> new Date(getSubmittedAt(b)||0) - new Date(getSubmittedAt(a)||0)
      )[0];
      const last = lastRow ? getSubmittedAt(lastRow) : null;

      sumAttempts.textContent = attempts;
      sumAvg.textContent = fmtPct(avg);
      sumBest.textContent = fmtPct(best);
      sumLast.textContent = fmtDate(last);
      studentSummary.style.display = 'block';
    }

    /***************** Assignment Viewing *****************/
    async function getAssignmentSignedUrl(row){
      if(!row.assignment_path) return null;
      const bucket = row.assignment_bucket || 'assignments';
      try{
        const { data, error } = await sb.storage.from(bucket).createSignedUrl(row.assignment_path, 60);
        if(error) return null;
        return data?.signedUrl || null;
      } catch(e){
        console.error('Signed URL error', e);
        return null;
      }
    }

    window.viewAssignment = async function(rowIdx){
      const row = currentRows[rowIdx];
      const canView = isAdmin || (currentUser && row.user_id === currentUser.id);
      if(!canView){ alert('You do not have access to this assignment.'); return; }
      let url = await getAssignmentSignedUrl(row);
      if(url){
        url += (url.includes('?')? '&':'?') + 'cb=' + Date.now();
        window.open(url, '_blank');
      } else {
        alert('Unable to generate assignment link (file missing or access denied).');
      }
    };

    /***************** Admin: Marks & Resubmission Toggle *****************/
    window.saveAssignmentMarks = async function(rowIdx){
      const row = currentRows[rowIdx];
      const input = document.getElementById('marks-input-'+row.id);
      if(!input) return;
      const raw = input.value.trim();
      if(raw==='' || isNaN(raw)){ alert('Enter valid marks.'); return; }
      const marks = Number(raw);
      if(marks < 0 || marks > 50){ alert('Marks must be between 0 and 50.'); return; }

      input.disabled = true;
      const btn = document.getElementById('marks-save-'+row.id);
      if(btn) btn.disabled = true;
      setStatus('Saving marks…');

      const { error } = await sb.from('assessment_results')
        .update({ assignment_marks: marks, resubmission_allowed: false })
        .eq('id', row.id);

      if(error){
        alert('Save failed: ' + error.message);
        input.disabled = false;
        if(btn) btn.disabled = false;
        setStatus('Save failed.');
        return;
      }
      setStatus('Marks saved.');
      await reloadRows();
    };

    window.toggleResubmission = async function(rowIdx){
      const row = currentRows[rowIdx];
      // Toggle: If currently allowed, set to false; if currently not allowed, set to true
      const next = !effectiveResubAllowed(row);
      const btn = document.getElementById('resubmission-toggle-'+row.id);
      if(btn) btn.disabled = true;
      setStatus('Updating…');
      const { error } = await sb.from('assessment_results')
        .update({ resubmission_allowed: next })
        .eq('id', row.id);
      if(error){
        alert('Update failed: ' + error.message);
        if(btn) btn.disabled=false;
        setStatus('Update failed.');
        return;
      }
      setStatus('Resubmission updated.');
      await reloadRows();
    };

    /***************** Student Resubmission *****************/
    window.openEditAssignmentModal = function(rowIdx){
      const row = currentRows[rowIdx];
      if (!effectiveResubAllowed(row)) {
        alert('Resubmission is currently disabled by the administrator.');
        return;
      }
      editingRowIdx = rowIdx;
      document.getElementById('edit-assignment-modal').style.display='flex';
      document.getElementById('assignmentFile').value='';
      debug('Modal opened for row '+currentRows[rowIdx].id);
    };
    document.getElementById('close-edit-modal').onclick = function(){
      document.getElementById('edit-assignment-modal').style.display='none';
      editingRowIdx = null;
    };

    document.getElementById('edit-assignment-form').onsubmit = async function(e){
      e.preventDefault();
      if(editingRowIdx == null) return;
      const row = currentRows[editingRowIdx];
      debug('Re-validating row for resubmission…');

      // Re-fetch minimal fields to avoid stale state before upload
      const { data:fresh, error:freshErr } = await sb.from('assessment_results')
        .select('id,user_id,experiment_id,assignment_marks,resubmission_allowed,assignment_bucket,assignment_path')
        .eq('id', row.id)
        .maybeSingle();

      if(freshErr || !fresh){
        alert('Could not re-validate row. Refresh the page.');
        debug('Re-validate error: '+(freshErr?.message || 'missing'));
        return;
      }
      if(!effectiveResubAllowed(fresh)){
        alert('Resubmission is currently disabled by the administrator.');
        debug('Effective permission false after re-validate.');
        return;
      }

      const fileInput = document.getElementById('assignmentFile');
      if(!fileInput.files.length){ alert('Please select a file.'); return; }
      const file = fileInput.files[0];
      if(file.type !== 'application/pdf' && !file.type.startsWith('image/')){
        alert('Only PDF or image files allowed.');
        return;
      }

      setStatus('Uploading assignment…');
      debug('Uploading file…');

      const bucket = fresh.assignment_bucket || 'assignments';
      const ext = file.type === 'application/pdf' ? 'pdf' : file.type.split('/')[1];
      const newPath = `${fresh.user_id}/${fresh.experiment_id}/assignment_${Date.now()}.${ext}`;

      const { error:uploadErr } = await sb.storage.from(bucket).upload(newPath, file, { upsert:true });
      if(uploadErr){
        alert('Upload failed: ' + uploadErr.message);
        debug('Upload error: ' + uploadErr.message);
        setStatus('Upload failed.');
        return;
      }

      debug('File uploaded. Updating DB row…');
      const { data:updateRows, error:updateErr } = await sb.from('assessment_results')
        .update({ assignment_path:newPath, assignment_type:file.type })
        .eq('id', fresh.id)
        .select('id, assignment_path, assignment_type');

      if(updateErr){
        alert('Database update failed: ' + updateErr.message);
        debug('DB update error: ' + updateErr.message);
        setStatus('Update failed.');
        return;
      }

      debug('DB update success: '+JSON.stringify(updateRows));
      setStatus('Assignment updated!');
      document.getElementById('edit-assignment-modal').style.display='none';
      editingRowIdx = null;
      await reloadRows();
    };

    /***************** Details (Per-Question) *****************/
    window.toggleDetails = function(rowIdx){
      const baseRow = document.getElementById('row-'+currentRows[rowIdx].id);
      if(!baseRow) return;
      const existing = document.getElementById('details-for-'+currentRows[rowIdx].id);
      const toggleBtn = document.getElementById('details-btn-'+currentRows[rowIdx].id);

      if(existing){
        existing.remove();
        if(toggleBtn){ toggleBtn.classList.remove('open'); toggleBtn.textContent='Details'; }
        return;
      }
      const detailsTr = document.createElement('tr');
      detailsTr.className = 'details-row';
      detailsTr.id = 'details-for-'+currentRows[rowIdx].id;
      const td = document.createElement('td');
      td.colSpan = 12;
      td.innerHTML = buildDetailsHTML(currentRows[rowIdx]);
      detailsTr.appendChild(td);
      baseRow.parentNode.insertBefore(detailsTr, baseRow.nextSibling);
      if(toggleBtn){ toggleBtn.classList.add('open'); toggleBtn.textContent='Hide Details'; }
    };

    function buildDetailsHTML(row){
      const breakdown = Array.isArray(row.breakdown) ? row.breakdown
                       : (row.breakdown && typeof row.breakdown === 'object'
                          ? (row.breakdown.questions || row.breakdown) : []);
      if(!breakdown || !breakdown.length){
        return `<div class="details-wrapper">
          <div class="details-header">Question Details</div>
          <div class="no-breakdown">No question-level data available.</div>
        </div>`;
      }
      let correctCount = 0;
      let totalCount = 0;
      const cards = [];
      breakdown.forEach((q, idx)=>{
        if(!q || q.type === 'meta') return;
        totalCount++;
        const isCorrect = q.isCorrect === true;
        if(isCorrect) correctCount++;
        const question = escapeHTML(q.question || ('Question '+(idx+1)));
        const yourAns = escapeHTML(q.answer ?? '—');
        const correctAns = escapeHTML(q.correct ?? '—');
        const typeBadge = `<span class="question-type-badge">${escapeHTML(q.type || 'q')}</span>`;
        const correctness = isCorrect
          ? `<span class="ans-correct">Correct</span>`
          : `<span class="ans-wrong">Wrong</span> <span class="correct-answer-inline">Correct: ${correctAns}</span>`;
        cards.push(`<div class="q-card">
          <div class="q-text">${typeBadge} ${question}</div>
          <div class="ans-line"><span class="ans-your">Your answer:</span> ${yourAns}</div>
          <div class="ans-line">${correctness}</div>
        </div>`);
      });

      return `<div class="details-wrapper">
        <div class="details-header">
          <span>Question Details</span>
          <span>Total Questions: ${totalCount}</span>
          <span>Correct: ${correctCount}</span>
          <span>Accuracy: ${totalCount? fmtPct((correctCount/totalCount)*100) : '—'}</span>
        </div>
        <div class="details-grid">
          ${cards.join('')}
        </div>
      </div>`;
    }

    /***************** Rendering *****************/
    async function reloadRows(){
      const exp_id = filterExperiment.value || '';
      const search = filterSearch?.value || '';
      const batch = filterBatch?.value || '';
      const rows = await fetchResults({ exp_id, search, batch });
      renderRows(rows);
      if(!isAdmin) renderSummaryForStudent(rows);
      setStatus('Ready.');
    }

    function renderRows(rows){
      currentRows = rows;
      countEl.textContent = rows.length;
      if(!rows.length){
        tbody.innerHTML = '<tr><td colspan="12" class="muted">No results.</td></tr>';
        return;
      }
      const out = [];
      rows.forEach((r, rowIdx)=>{
        const email = r.meta?.email || r.email || '';
        const prn = r.meta?.prn || r.prn || '—';
        const batch = r.meta?.batch || r.batch || '—';
        const assessmentTitle = r.meta?.assessment_title || r.assessment_title || '—';
        const percentVal = r.percent ?? r.percentage;
        const scoreNum = Number(r.score);
        const totalNum = Number(r.total);
        const scoreTxt = (!isNaN(scoreNum) && !isNaN(totalNum)) ? `${scoreNum}/${totalNum}` : (r.score ?? '—');
        const marksVal = r.assignment_marks != null ? Number(r.assignment_marks) : null;
        const totalMarks = (scoreNum||0) + (marksVal||0);
        const totalMarksTxt = `<span class="total-marks">${totalMarks}/${isNaN(totalNum)?'?': totalNum + (isNaN(marksVal)?0:marksVal)}</span>`;

        // Marks cell
        let marksCell = '';
        if(isAdmin){
          marksCell = `<div class="marks-cell">
            <input class="marks-input" id="marks-input-${r.id}" type="number" min="0" max="50" value="${marksVal!=null?marksVal:''}" placeholder="-" />
            <button class="btn small" id="marks-save-${r.id}" onclick="saveAssignmentMarks(${rowIdx})">Save</button>
            <span id="marks-status-${r.id}" class="marks-status">${marksVal!=null ? 'Saved' : '<span class="marks-pending">Pending</span>'}</span>
          </div>`;
        } else {
          marksCell = `<span class="marks-label">${marksVal!=null?marksVal:'<span class="marks-pending">Pending</span>'}</span>`;
        }

        // Assignment button
        let assignmentBtn = `<span class="muted" style="font-size:13px;">—</span>`;
        const canView = isAdmin || (currentUser && r.user_id===currentUser.id);
        if(r.assignment_path && canView){
          let label = 'View File';
          if(r.assignment_type === 'application/pdf') label='View PDF';
          else if(r.assignment_type && r.assignment_type.startsWith('image/')) label='View Image';
          assignmentBtn = `<button class="assignment-btn" onclick="viewAssignment(${rowIdx})">${label}</button>`;
        } else if(r.assignment_path){
          assignmentBtn = `<span class="muted" style="font-size:13px;">Restricted</span>`;
        }

        // Resubmission cell (Admin always has a toggle; student sees button only if effective is true)
        const effective = effectiveResubAllowed(r);
        let resubmitCell = '<div class="resubmission-status-box">';
        if(isAdmin){
          resubmitCell += `
            <button class="btn ghost resubmission-toggle-btn" id="resubmission-toggle-${r.id}" onclick="toggleResubmission(${rowIdx})">
              ${effective ? 'Disable Resubmission' : 'Allow Resubmission'}
            </button>
            <span class="resubmission-status-message ${effective?'enabled':'disabled'}">
              ${effective ? 'Resubmission Enabled' : 'Resubmission Disabled'}
            </span>
            ${r.assignment_marks == null ? '<span class="muted" style="font-size:12px;">(Marks pending)</span>' : ''}
          `;
        }
        if(!isAdmin && currentUser && r.user_id === currentUser.id){
          if(effective){
            resubmitCell += `<button class="edit-assignment-btn" onclick="openEditAssignmentModal(${rowIdx})">Resubmit Assignment</button>`;
          } else {
            resubmitCell += `<span class="resubmission-status-message disabled">Resubmission Closed</span>`;
          }
        }
        resubmitCell += `
          <div class="debug-log">
            Row: ${r.id}<br>
            assignment_marks: ${r.assignment_marks==null?'null':r.assignment_marks}<br>
            stored_resubmission_allowed: ${r.resubmission_allowed}<br>
            effective_resubmission_allowed: ${effective}
          </div>`;
        resubmitCell += '</div>';

        const detailsBtn = `<button id="details-btn-${r.id}" class="details-toggle-btn" onclick="toggleDetails(${rowIdx})" aria-expanded="false">Details</button>`;

        out.push(`
          <tr id="row-${r.id}">
            <td>
              ${escapeHTML(r.user_name || email || r.user_id || '—')}
              <div class="muted" style="font-size:11px">${escapeHTML(email)}</div>
              ${detailsBtn}
            </td>
            <td>${escapeHTML(assessmentTitle)}</td>
            <td>${escapeHTML(prn)}</td>
            <td>${escapeHTML(batch)}</td>
            <td>${scoreTxt}</td>
            <td>${marksCell}</td>
            <td>${totalMarksTxt}</td>
            <td>${fmtPct(percentVal)}</td>
            <td>${fmtDate(getSubmittedAt(r))}</td>
            <td>${fmtDur(r.duration_sec)}</td>
            <td>${assignmentBtn}</td>
            <td>${resubmitCell}</td>
          </tr>
        `);
      });
      tbody.innerHTML = out.join('');
    }

    /***************** Export (Excel) *****************/
    function buildSummaryData(){
      return currentRows.map(r=>{
        const email = r.meta?.email || r.email || '';
        const prn = r.meta?.prn || r.prn || '';
        const batch = r.meta?.batch || r.batch || '';
        const assessmentTitle = r.meta?.assessment_title || r.assessment_title || '';
        const scoreNum = Number(r.score);
        const totalNum = Number(r.total);
        const marksVal = r.assignment_marks != null ? Number(r.assignment_marks) : null;
        const totalMarks = (scoreNum||0)+(marksVal||0);
        return {
          RowID: r.id,
          StudentName: r.user_name || email || r.user_id || '',
          Email: email,
          Assessment: assessmentTitle,
          PRN: prn,
          Batch: batch,
          Score: !isNaN(scoreNum)&&!isNaN(totalNum)? `${scoreNum}/${totalNum}`: r.score,
          AssignmentMarks: marksVal,
          TotalMarks: totalMarks,
          Percentage: r.percent ?? r.percentage,
          SubmittedAt: r.submitted_at,                         // legacy column (raw)
          SubmittedAtUTC: r.submitted_at_utc || '',            // new UTC column
          SubmittedAtISTDisplay: fmtDate(getSubmittedAt(r)),   // human display in IST
          DurationSec: r.duration_sec,
          ResubmissionAllowedStored: r.resubmission_allowed,
          EffectiveResubmission: effectiveResubAllowed(r)
        };
      });
    }

    function buildDetailsData(){
      const rows = [];
      currentRows.forEach(r=>{
        const email = r.meta?.email || r.email || '';
        const assessmentTitle = r.meta?.assessment_title || r.assessment_title || '';
        const breakdown = Array.isArray(r.breakdown) ? r.breakdown
          : (r.breakdown && typeof r.breakdown === 'object' ? (r.breakdown.questions || r.breakdown) : []);
        if(!breakdown) return;
        let qIndex = 0;
        breakdown.forEach(q=>{
          if(!q || q.type === 'meta') return;
          qIndex++;
          rows.push({
            RowID: r.id,
            Student: r.user_name || email || r.user_id || '',
            Email: email,
            Assessment: assessmentTitle,
            QuestionIndex: qIndex,
            Question: q.question || '',
            Type: q.type || '',
            SelectedAnswer: q.answer ?? '',
            CorrectAnswer: q.correct ?? '',
            IsCorrect: q.isCorrect === true
          });
        });
      });
      return rows;
    }

    function exportSummary(){
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(buildSummaryData());
      XLSX.utils.book_append_sheet(wb, ws, 'Results');
      XLSX.writeFile(wb, 'results_summary.xlsx');
    }

    function exportWithDetails(){
      const wb = XLSX.utils.book_new();
      const ws1 = XLSX.utils.json_to_sheet(buildSummaryData());
      const ws2 = XLSX.utils.json_to_sheet(buildDetailsData());
      XLSX.utils.book_append_sheet(wb, ws1, 'Results');
      XLSX.utils.book_append_sheet(wb, ws2, 'Details');
      XLSX.writeFile(wb, 'results_with_details.xlsx');
    }

    /***************** Filters & Init *****************/
    async function applyFilters(){
      try{
        setStatus('Loading…');
        await reloadRows();
      } catch(e){
        tbody.innerHTML = '<tr><td colspan="12" class="muted">Failed to load results.</td></tr>';
        setStatus('Failed.');
        alert('Error: '+(e?.message||e));
      }
    }

    async function init(){
      if(!(await requireLogin())) return;
      const role = await getRole(currentUser.id);
      isAdmin = (role === 'admin');
      roleBadge.textContent = isAdmin ? 'Admin' : 'Student';
      roleBadge.style.borderColor = isAdmin ? '#2ea043' : '#cfe0ff';
      roleBadge.style.color = isAdmin ? '#0a5' : '#375a9e';

      if(isAdmin){
        adminSearchWrap.style.display='block';
        adminBatchWrap.style.display='block';
        who.textContent = 'Viewing: all students (filtered)';
      } else {
        who.textContent = 'Viewing: your attempts';
        studentSummary.style.display='block';
      }

      await loadExperiments();
      const urlExp = new URLSearchParams(location.search).get('exp');
      if(urlExp) filterExperiment.value = urlExp;

      btnApply.addEventListener('click', applyFilters);
      btnReset.addEventListener('click', ()=>{
        filterExperiment.value='';
        if(filterSearch) filterSearch.value='';
        if(filterBatch) filterBatch.value='';
        applyFilters();
      });
      btnExportSummary.addEventListener('click', ()=> {
        if(!currentRows.length){ alert('No data to export.'); return; }
        exportSummary();
      });
      btnExportDetails.addEventListener('click', ()=> {
        if(!currentRows.length){ alert('No data to export.'); return; }
        exportWithDetails();
      });

      await applyFilters();
      setStatus('Ready.');
    }
    init();
  </script>
</body>
</html>
