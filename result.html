<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Results | Human Anatomy & Physiology Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <link rel="preconnect" href="https://hunlistfklwvpivfjmbk.supabase.co" />
  <style>
    :root {
      --c-bg: #f6f9ff;
      --c-panel: #fff;
      --c-border: #cfe0ff;
      --c-accent: #1565c0;
      --c-accent-dark: #0d47a1;
      --c-muted: #375a9e;
      --c-good: #1b5e20;
      --c-bad: #c62828;
      --c-warn: #f9a825;
      --radius: 10px;
      --transition: 0.15s ease;
      font-size: 16px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, 'Segoe UI', Arial, sans-serif;
      background: var(--c-bg);
      color: #222;
    }
    header {
      padding: 0.75rem 1rem;
      background: #e3f2fd;
      border-bottom: 1px solid var(--c-border);
    }
    main {
      max-width: 1150px;
      margin: 18px auto 40px;
      padding: 0 14px 24px;
    }
    .panel {
      background: var(--c-panel);
      border: 1px solid var(--c-border);
      border-radius: var(--radius);
      padding: 14px 16px 18px;
      margin-bottom: 16px;
      position: relative;
    }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); }
    h1 { margin:0; font-size:1.35rem; color:var(--c-accent-dark); }
    a { color: var(--c-accent); text-decoration:none; }
    a:hover, button:hover { filter:brightness(1.05); }
    .muted { color: var(--c-muted); font-size: 0.92rem; }
    .badge {
      display:inline-block; font-size:12px; padding:4px 10px;
      border:1px solid var(--c-border); border-radius:999px;
      background:#f0f6ff; font-weight:600;
    }
    label { font-size: 0.75rem; letter-spacing: 0.5px; text-transform: uppercase; color: var(--c-muted); font-weight:600; }
    select, input[type="text"], input[type="number"], input[type="file"] {
      width:100%; padding:10px; border:1px solid var(--c-border);
      border-radius:8px; font-size:14px; background:#fff;
      transition: var(--transition);
    }
    select:focus, input:focus { outline:2px solid #90caf9; }
    .btn {
      background: var(--c-accent);
      color:#fff;
      border:0;
      padding:8px 14px;
      border-radius:8px;
      font-size:14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition: var(--transition);
    }
    .btn.ghost { background:transparent; color:var(--c-accent); border:1px solid var(--c-border); }
    .btn.small { padding:5px 10px; font-size:12px; }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .stat {
      background:#f5faff;
      border:1px solid var(--c-border);
      border-radius:8px;
      padding:10px 12px;
    }
    .stat .label { font-size:11px; color:var(--c-muted); text-transform:uppercase; letter-spacing:.5px; }
    .stat .value { font-size:22px; font-weight:700; color:var(--c-accent-dark); }
    .results-wrap { overflow:auto; max-height: 65vh; }
    table { width:100%; border-collapse: collapse; font-size: 13.5px; line-height:1.35; }
    caption { text-align:left; font-weight:600; color:var(--c-accent-dark); padding:4px 0 10px; font-size:14px; }
    th, td {
      padding:8px 6px;
      border-bottom:1px dashed var(--c-border);
      text-align:left;
      vertical-align: top;
    }
    th {
      background:#f0f6ff;
      color:var(--c-accent);
      font-weight:600;
      position:sticky;
      top:0;
      z-index:2;
      font-size:12px;
      letter-spacing:.5px;
      text-transform:uppercase;
    }
    tbody tr:hover { background:#f9fbff; }
    tbody tr.skeleton td {
      background: linear-gradient(90deg,#f0f6ff 25%, #e3edf9 50%, #f0f6ff 75%);
      background-size: 300% 100%;
      animation: shimmer 1.4s infinite;
      color:transparent;
    }
    @keyframes shimmer { 0% { background-position:0 0; } 100% { background-position: -300% 0; } }
    details {
      background:#f9fbff;
      border:1px solid var(--c-border);
      border-radius:8px;
      padding:8px 10px;
      margin-top:6px;
    }
    details summary { cursor:pointer; font-weight:600; color:var(--c-accent-dark); outline:none; }
    details[open] { background:#f0f6ff; }
    .details-q-block { margin-bottom:18px; border-bottom:1px solid #e3ecfa; padding-bottom:8px; }
    .details-q-block:last-child { border-bottom:none; }
    .details-q-title { font-weight:600; margin-bottom:4px; color:var(--c-accent-dark); }
    .details-q-options { margin-left:14px; margin-bottom:4px; }
    .details-q-option { display:block; margin-bottom:2px; }
    .details-q-option.correct { color: var(--c-good); font-weight:600; }
    .details-q-option.incorrect { color: var(--c-bad); font-weight:600; }
    .details-q-ans-correct { color: var(--c-good); font-weight:600; }
    .details-q-ans-wrong { color: var(--c-bad); font-weight:600; }
    .details-q-correct-answer { color:#2e7d32; margin-left:12px; }
    .marks-input { width: 58px; padding:4px 6px; font-size:13px; }
    .marks-cell { display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .marks-status { font-size:11px; color: var(--c-good); }
    .marks-pending { color: var(--c-warn); }
    .total-marks { font-weight:700; color: var(--c-accent); }
    .resubmission-status-box { display:flex; flex-direction:column; align-items:flex-start; gap:4px; font-size:12px; }
    .resubmission-status-message { font-weight:600; }
    .resubmission-status-message.enabled { color:#1976d2; }
    .resubmission-status-message.disabled { color:#666; }
    .debug-log { font-size:10px; color:#888; }
    .modal-backdrop {
      position:fixed; inset:0; background:rgba(0,0,0,.25);
      display:none; align-items:center; justify-content:center;
      z-index:1000; animation: fadeIn .2s ease;
    }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .modal {
      background:#fff;
      border-radius:12px;
      width: min(420px,92%);
      padding:20px 22px 24px;
      box-shadow:0 6px 28px -6px rgba(40,60,90,.35);
      position:relative;
      animation: popIn .25s ease;
    }
    @keyframes popIn { from{transform:scale(.94); opacity:0} to{transform:scale(1); opacity:1} }
    .modal h2 { margin-top:0; font-size:1.05rem; color:#1976d2; letter-spacing:.5px; }
    .modal-close {
      position:absolute; top:8px; right:10px;
      background:transparent; border:0; font-size:20px;
      line-height:1; cursor:pointer; color:#1976d2;
    }
    @media (max-width: 780px) {
      th:nth-child(3), td:nth-child(3),
      th:nth-child(4), td:nth-child(4),
      th:nth-child(10), td:nth-child(10) { display:none; }
      .grid { grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); }
    }
  </style>
</head>
<body>
  <header>
    <div class="row" role="navigation" aria-label="Main">
      <a href="index.html" aria-label="Back to home">← Home</a>
      <h1>Results</h1>
      <span id="role-badge" class="badge" aria-live="polite">Loading…</span>
      <span id="status" class="muted" style="margin-left:auto" aria-live="polite">Initializing…</span>
    </div>
  </header>

  <main>
    <section id="student-summary" class="panel" style="display:none;">
      <div class="muted" style="margin-bottom:10px;">Your Performance Summary</div>
      <div class="grid" aria-label="Performance statistics">
        <div class="stat"><div class="label">Total Attempts</div><div class="value" id="sum-attempts">0</div></div>
        <div class="stat"><div class="label">Average %</div><div class="value" id="sum-avg">0%</div></div>
        <div class="stat"><div class="label">Best %</div><div class="value" id="sum-best">0%</div></div>
        <div class="stat"><div class="label">Last Attempt</div><div class="value" id="sum-last">—</div></div>
      </div>
    </section>

    <section id="filters" class="panel">
      <div class="row" style="margin-bottom:6px;">
        <div class="muted">Filters</div>
        <div style="margin-left:auto; display:flex; gap:6px;">
          <button id="export-csv" class="btn ghost small" aria-label="Export results as CSV">Export CSV</button>
        </div>
      </div>
      <div class="grid">
        <div>
          <label for="filter-experiment">Experiment</label>
          <select id="filter-experiment" aria-label="Experiment filter">
            <option value="">All experiments</option>
          </select>
        </div>
        <div id="admin-search-wrap" style="display:none;">
          <label for="filter-search">Search (name/email/PRN)</label>
            <input id="filter-search" type="text" placeholder="john, 2023-PRN-001, gmail.com" />
        </div>
        <div id="admin-batch-wrap" style="display:none;">
          <label for="filter-batch">Batch</label>
          <input id="filter-batch" type="text" placeholder="e.g., B1, 2024" />
        </div>
      </div>
      <div class="row" style="margin-top:12px;">
        <button id="apply" class="btn">Apply</button>
        <button id="reset" class="btn ghost">Reset</button>
      </div>
    </section>

    <section class="panel" aria-label="Results section">
      <div class="row" style="margin-bottom:8px;">
        <div class="muted">Results</div>
        <span id="count" class="badge" style="background:#f0f6ff;">0</span>
        <div id="who" class="muted" style="margin-left:auto;"></div>
      </div>
      <div class="results-wrap">
        <table aria-describedby="legend-text">
          <caption>Assessment Attempts</caption>
          <thead>
            <tr>
              <th scope="col">Student</th>
              <th scope="col">Assessment</th>
              <th scope="col">PRN</th>
              <th scope="col">Batch</th>
              <th scope="col">Score</th>
              <th scope="col">Assign. Marks</th>
              <th scope="col">Total</th>
              <th scope="col">%</th>
              <th scope="col">Submitted</th>
              <th scope="col">Duration</th>
              <th scope="col">Assignment</th>
              <th scope="col">Resubmit</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr class="skeleton"><td colspan="12">Loading</td></tr>
            <tr class="skeleton"><td colspan="12">Loading</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section id="legend" class="panel">
      <div id="legend-text" class="muted">
        Tip: Admins can edit assignment marks directly in the table. Admins can allow or disallow assignment resubmission. Students may only resubmit when enabled.<br>
        <span style="color:var(--c-good); font-weight:600;">
          Optional rule: When an admin allots marks, resubmission auto-disables. Admins can re-enable anytime.
        </span>
      </div>
    </section>
  </main>

  <div id="edit-assignment-modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal">
      <button class="modal-close" id="close-edit-modal" aria-label="Close dialog">×</button>
      <h2 id="modal-title">Resubmit Assignment</h2>
      <form id="edit-assignment-form">
        <div style="margin-bottom:14px;">
          <label for="assignmentFile" style="display:block; margin-bottom:6px;">Select PDF or Image:</label>
          <input type="file" id="assignmentFile" accept="application/pdf,image/*" required />
        </div>
        <div class="row" style="justify-content:flex-end;">
          <button type="submit" class="btn">Submit</button>
          <button type="button" class="btn ghost" id="cancel-upload">Cancel</button>
        </div>
      </form>
      <div id="modal-debug" class="debug-log" aria-live="polite"></div>
    </div>
  </div>

  <!-- Option A: No integrity attribute -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = 'https://hunlistfklwvpivfjmbk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bmxpc3Rma2x3dnBpdmZqbWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzA1NDUsImV4cCI6MjA3MzQwNjU0NX0.e-o_qL1Uf5DpW4gX60ktXyuUXmw5YWhqaw6Cx8Xc8Qs';

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $  = (sel, parent=document) => parent.querySelector(sel);
    const statusEl    = $('#status');
    const roleBadge   = $('#role-badge');
    const tbody       = $('#tbody');
    const countEl     = $('#count');
    const whoEl       = $('#who');
    const studentSummary = $('#student-summary');
    const sumAttempts = $('#sum-attempts');
    const sumAvg      = $('#sum-avg');
    const sumBest     = $('#sum-best');
    const sumLast     = $('#sum-last');
    const filterExperiment = $('#filter-experiment');
    const filterSearch     = $('#filter-search');
    const filterBatch      = $('#filter-batch');
    const adminSearchWrap  = $('#admin-search-wrap');
    const adminBatchWrap   = $('#admin-batch-wrap');

    const editModalBackdrop = $('#edit-assignment-modal');
    const assignmentFileInput = $('#assignmentFile');

    let currentUser = null;
    let isAdmin = false;
    let currentRows = [];
    let editingRowIdx = null;
    const ASSIGNMENT_MAX = 50;

    const setStatus = msg => { statusEl.textContent = msg; };
    const fmtPct = n => {
      if (n == null || isNaN(Number(n))) return '—';
      const val = Number(n);
      return (Math.round(val * 100) / 100).toFixed(2) + '%';
    };
    const fmtDate = iso => {
      if (!iso) return '—';
      const d = new Date(iso);
      if (isNaN(d.getTime())) return '—';
      return d.toLocaleString();
    };
    const fmtDur = sec => {
      if (sec == null || isNaN(Number(sec))) return '—';
      const s = Number(sec);
      const m = Math.floor(s/60);
      const r = s % 60;
      return m + 'm ' + r + 's';
    };
    const escapeHTML = str => String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
    const has = v => typeof v === 'string' ? v.trim().length>0 : !!v;

    async function requireLogin(){
      const { data: { session } } = await sb.auth.getSession();
      if (!session?.user) {
        window.location.replace('login_Version4.html');
        return false;
      }
      currentUser = session.user;
      return true;
    }
    async function getRole(userId){
      const { data, error } = await sb.from('profiles')
        .select('role')
        .eq('id', userId)
        .maybeSingle();
      if (error) {
        console.warn('Role error', error);
        return 'unknown';
      }
      return (data?.role || 'unknown').toLowerCase();
    }
    async function loadExperiments(){
      try {
        const { data, error } = await sb.rpc('list_experiments_for_results');
        if (error) throw error;
        if (Array.isArray(data)) {
          data.forEach(row => {
            const opt = document.createElement('option');
            opt.value = row.experiment_id || '';
            opt.textContent = row.experiment_id || '(untitled)';
            filterExperiment.appendChild(opt);
          });
        }
      } catch (e){
        console.warn('loadExperiments', e);
      }
    }
    async function fetchResults({ exp_id='', search='', batch='' } = {}){
      const args = {
        exp_id: has(exp_id) ? exp_id : null,
        search_text: has(search) ? search : null,
        batch_text: has(batch) ? batch : null
      };
      const fn = isAdmin
        ? 'get_assessment_results_admin_v2'
        : 'get_results_student_test';
      const { data, error } = await sb.rpc(fn, args);
      if (error) throw error;
      return Array.isArray(data) ? data : [];
    }
    function renderSummaryForStudent(rows){
      const attempts = rows.length;
      const percents = rows
        .map(r => Number(r.percent ?? r.percentage))
        .filter(v => !isNaN(v));
      const avg = percents.length
        ? (percents.reduce((a,b)=>a+b,0)/percents.length)
        : 0;
      const best = percents.length ? Math.max(...percents) : 0;
      const lastAttempt = rows
        .slice()
        .sort((a,b)=> new Date(b.submitted_at||0) - new Date(a.submitted_at||0))[0]?.submitted_at;

      sumAttempts.textContent = attempts;
      sumAvg.textContent = fmtPct(avg);
      sumBest.textContent = fmtPct(best);
      sumLast.textContent = fmtDate(lastAttempt);
      studentSummary.style.display = 'block';
    }
    async function getAssignmentSignedUrl(row){
      if (!row.assignment_path) return null;
      const bucket = row.assignment_bucket || 'assignments';
      try {
        const { data, error } = await sb
          .storage
          .from(bucket)
          .createSignedUrl(row.assignment_path, 60);
        if (error) return null;
        return data?.signedUrl || null;
      } catch {
        return null;
      }
    }
    window.viewAssignment = async function(rowIdx){
      const row = currentRows[rowIdx];
      const canView = isAdmin || (currentUser && row.user_id === currentUser.id);
      if (!canView) {
        alert('You do not have access to this assignment.');
        return;
      }
      let url = await getAssignmentSignedUrl(row);
      if (url) {
        url += (url.includes('?') ? '&' : '?') + 'cb=' + Date.now();
        window.open(url, '_blank', 'noopener');
      } else {
        alert('Unable to generate assignment link.');
      }
    };
    window.saveAssignmentMarks = async function(rowIdx){
      const row = currentRows[rowIdx];
      const input = document.getElementById('marks-input-' + row.id);
      if (!input) return;
      const val = input.value.trim();
      if (val === '' || isNaN(val)) {
        alert('Please enter a valid number.');
        return;
      }
      const marks = Number(val);
      if (marks < 0 || marks > ASSIGNMENT_MAX) {
        alert(`Marks must be between 0 and ${ASSIGNMENT_MAX}.`);
        return;
      }
      input.disabled = true;
      const btn = document.getElementById('marks-save-' + row.id);
      if (btn) btn.disabled = true;
      setStatus('Saving assignment marks...');
      const { error } = await sb.from('assessment_results')
        .update({ assignment_marks: marks, resubmission_allowed: false })
        .eq('id', row.id);
      if (error) {
        alert('Save failed: ' + error.message);
        setStatus('Save failed.');
        input.disabled = false;
        if (btn) btn.disabled = false;
        return;
      }
      await reloadData();
      setStatus('Marks saved.');
    };
    window.toggleResubmission = async function(rowIdx){
      const row = currentRows[rowIdx];
      const newStatus = !row.resubmission_allowed;
      const btn = document.getElementById('resubmission-toggle-' + row.id);
      if (btn) btn.disabled = true;
      setStatus('Updating resubmission status...');
      const { error } = await sb.from('assessment_results')
        .update({ resubmission_allowed: newStatus })
        .eq('id', row.id);
      if (error) {
        alert('Update failed: ' + error.message);
        if (btn) btn.disabled = false;
        setStatus('Failed.');
        return;
      }
      await reloadData();
      setStatus('Updated.');
    };
    window.openEditAssignmentModal = function(rowIdx){
      editingRowIdx = rowIdx;
      assignmentFileInput.value = '';
      editModalBackdrop.style.display = 'flex';
    };
    const closeModal = () => {
      editModalBackdrop.style.display = 'none';
      editingRowIdx = null;
    };
    $('#close-edit-modal').addEventListener('click', closeModal);
    $('#cancel-upload').addEventListener('click', closeModal);
    $('#edit-assignment-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (editingRowIdx == null) return;
      const row = currentRows[editingRowIdx];
      const file = assignmentFileInput.files[0];
      if (!file) { alert('Please select a file.'); return; }
      if (file.type !== 'application/pdf' && !file.type.startsWith('image/')) {
        alert('Only PDF or image files allowed.');
        return;
      }
      setStatus('Uploading assignment...');
      const bucket = row.assignment_bucket || 'assignments';
      const ext = file.type === 'application/pdf' ? 'pdf' : file.type.split('/')[1];
      const path = `${row.user_id}/${row.experiment_id}/assignment_${Date.now()}.${ext}`;
      const { error: uploadErr } = await sb.storage
        .from(bucket)
        .upload(path, file, { upsert: true });
      if (uploadErr) {
        alert('Upload failed: ' + uploadErr.message);
        setStatus('Upload failed.');
        return;
      }
      const { error: updErr } = await sb.from('assessment_results')
        .update({ assignment_path: path, assignment_type: file.type })
        .eq('id', row.id);
      if (updErr) {
        alert('Could not update record: ' + updErr.message);
        setStatus('Update failed.');
        return;
      }
      setStatus('Assignment updated.');
      closeModal();
      await reloadData();
    });
    function renderRows(rows){
      currentRows = rows;
      countEl.textContent = rows.length;
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="12" class="muted">No results.</td></tr>`;
        return;
      }
      const out = [];
      rows.forEach((r, rowIdx) => {
        const email     = r.meta?.email || r.email || '';
        const prn       = r.meta?.prn || r.prn || '—';
        const batch     = r.meta?.batch || r.batch || '—';
        const assessmentTitle = r.meta?.assessment_title || r.assessment_title || '—';
        const scoreNum = Number(r.score);
        const totalNum = Number(r.total);
        const scoreTxt = (!isNaN(scoreNum) && !isNaN(totalNum))
          ? `${scoreNum}/${totalNum}`
          : (r.score ?? '—');
        const assignmentMarks = r.assignment_marks != null ? Number(r.assignment_marks) : null;
        const combinedObtained = (isNaN(scoreNum) ? 0 : scoreNum) + (assignmentMarks || 0);
        const combinedTxt = `${combinedObtained}/${(isNaN(totalNum)?'?': totalNum + ASSIGNMENT_MAX)}`;
        const percentVal = r.percent ?? r.percentage;
        let marksCell = '';
        if (isAdmin) {
          marksCell = `
            <div class="marks-cell">
              <input id="marks-input-${r.id}" class="marks-input" type="number" min="0" max="${ASSIGNMENT_MAX}" value="${assignmentMarks != null ? assignmentMarks : ''}" placeholder="-" aria-label="Assignment marks for ${escapeHTML(email)}" />
              <button class="btn small" id="marks-save-${r.id}" onclick="saveAssignmentMarks(${rowIdx})">Save</button>
              <span class="marks-status">
                ${assignmentMarks != null ? 'Saved' : '<span class="marks-pending">Pending</span>'}
              </span>
            </div>`;
        } else {
          marksCell = `<span>${assignmentMarks != null ? assignmentMarks : '<span class="marks-pending">Pending</span>'}</span>`;
        }
        const canView = isAdmin || (currentUser && r.user_id === currentUser.id);
        let assignmentBtn = '<span class="muted" style="font-size:12px;">—</span>';
        if (r.assignment_path && canView) {
          let label = 'View File';
          if (r.assignment_type === 'application/pdf') label = 'View PDF';
          else if (r.assignment_type?.startsWith('image/')) label = 'View Image';
          assignmentBtn = `<button class="btn small ghost" onclick="viewAssignment(${rowIdx})" aria-label="View assignment for ${escapeHTML(email)}">${label}</button>`;
        } else if (r.assignment_path) {
          assignmentBtn = '<span class="muted" style="font-size:12px;">Restricted</span>';
        }
        let resubmitCell = '<div class="resubmission-status-box">';
        if (isAdmin) {
          if (r.assignment_marks == null) {
            resubmitCell += `<span class="resubmission-status-message enabled">Awaiting marking (resubmission open).</span>`;
          } else {
            resubmitCell += `
              <button class="btn ghost small" id="resubmission-toggle-${r.id}" onclick="toggleResubmission(${rowIdx})">
                ${r.resubmission_allowed ? 'Disable' : 'Allow'}
              </button>
              <span class="resubmission-status-message ${r.resubmission_allowed ? 'enabled':'disabled'}">
                ${r.resubmission_allowed ? 'Enabled' : 'Disabled'}
              </span>
            `;
          }
        }
        if (!isAdmin && currentUser && r.user_id === currentUser.id &&
           (r.assignment_marks == null || r.resubmission_allowed)) {
          resubmitCell += `<button class="btn small ghost" onclick="openEditAssignmentModal(${rowIdx})" aria-label="Resubmit assignment">Resubmit</button>`;
        }
        resubmitCell += `<div class="debug-log">ID:${r.id} resub:${r.resubmission_allowed}</div>`;
        resubmitCell += '</div>';
        out.push(`
          <tr>
            <td>
              ${escapeHTML(r.user_name || email || r.user_id || '—')}
              <div class="muted" style="font-size:11px;">${escapeHTML(email)}</div>
            </td>
            <td>${escapeHTML(assessmentTitle)}</td>
            <td>${escapeHTML(prn)}</td>
            <td>${escapeHTML(batch)}</td>
            <td>${scoreTxt}</td>
            <td>${marksCell}</td>
            <td><span class="total-marks">${combinedTxt}</span></td>
            <td>${fmtPct(percentVal)}</td>
            <td>${fmtDate(r.submitted_at)}</td>
            <td>${fmtDur(r.duration_sec)}</td>
            <td>${assignmentBtn}</td>
            <td>${resubmitCell}</td>
          </tr>
        `);
        let detailsContent = '';
        if (Array.isArray(r.breakdown)) {
          detailsContent = r.breakdown.map(q=>{
            const optionsHtml = Array.isArray(q.options)
              ? q.options.map(opt=>{
                  let cls = 'details-q-option';
                  if (q.student_answer === opt && q.answer === opt) cls += ' correct';
                  else if (q.student_answer === opt && q.answer !== opt) cls += ' incorrect';
                  else if (q.answer === opt) cls += ' correct';
                  return `<span class="${cls}">${escapeHTML(opt)}</span>`;
                }).join('')
              : '';
            const ansFeedback = q.student_answer === q.answer
              ? `<div class="details-q-ans-correct">Correct</div>`
              : `<div class="details-q-ans-wrong">Incorrect</div>
                 <div class="details-q-correct-answer">Correct: <b>${escapeHTML(q.answer||'—')}</b></div>`;
            return `
              <div class="details-q-block">
                <div class="details-q-title">${escapeHTML(q.question||'')}</div>
                <div class="details-q-options">${optionsHtml}</div>
                <div>Your answer: <b>${escapeHTML(q.student_answer ?? '—')}</b></div>
                ${ansFeedback}
              </div>
            `;
          }).join('');
        } else {
          detailsContent = `<div class="debug-log"><pre>${escapeHTML(JSON.stringify(r.breakdown,null,2))}</pre></div>`;
        }
        out.push(`
          <tr>
            <td colspan="12">
              <details>
                <summary>Details</summary>
                <div style="padding:8px 0 4px;">${detailsContent}</div>
              </details>
            </td>
          </tr>
        `);
      });
      tbody.innerHTML = out.join('');
    }
    function exportCSV(){
      if (!currentRows.length) { alert('No data to export.'); return; }
      const headers = [
        'student_name','email','prn','batch','assessment_title',
        'score','total','assignment_marks','combined_total','percent','submitted_at','duration_sec','resubmission_allowed'
      ];
      const lines = [headers.join(',')];
      currentRows.forEach(r=>{
        const email = r.meta?.email || r.email || '';
        const prn   = r.meta?.prn   || r.prn   || '';
        const batch = r.meta?.batch || r.batch || '';
        const assessmentTitle = r.meta?.assessment_title || r.assessment_title || '';
        const scoreNum = Number(r.score);
        const totalNum = Number(r.total);
        const assignMarks = r.assignment_marks != null ? Number(r.assignment_marks) : '';
        const combinedObtained = (isNaN(scoreNum)?0:scoreNum) + (assignMarks||0);
        const combinedMax = (isNaN(totalNum)?0:totalNum) + 50;
        const percent = r.percent ?? r.percentage ?? '';
        const rowArr = [
          JSON.stringify(r.user_name || email || r.user_id || ''),
          JSON.stringify(email),
          JSON.stringify(prn),
          JSON.stringify(batch),
          JSON.stringify(assessmentTitle),
          scoreNum,
          totalNum,
          assignMarks,
          `${combinedObtained}/${combinedMax}`,
          percent,
          r.submitted_at || '',
          r.duration_sec || '',
          r.resubmission_allowed
        ];
        lines.push(rowArr.join(','));
      });
      const blob = new Blob([lines.join('\n')], { type:'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'results_export.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }
    async function applyFilters(){
      try {
        setStatus('Loading…');
        tbody.innerHTML = '<tr class="skeleton"><td colspan="12">Loading</td></tr>';
        const exp_id = filterExperiment.value || '';
        const search = filterSearch?.value || '';
        const batch  = filterBatch?.value || '';
        const rows = await fetchResults({ exp_id, search, batch });
        renderRows(rows);
        if (!isAdmin) renderSummaryForStudent(rows);
        setStatus('Ready.');
      } catch (e){
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="12" class="muted">Failed to load results.</td></tr>';
        setStatus('Failed.');
      }
    }
    async function reloadData(){
      const exp_id = filterExperiment.value || '';
      const search = filterSearch?.value || '';
      const batch  = filterBatch?.value || '';
      const rows = await fetchResults({ exp_id, search, batch });
      renderRows(rows);
      if (!isAdmin) renderSummaryForStudent(rows);
    }
    async function init(){
      if (!(await requireLogin())) return;
      const role = await getRole(currentUser.id);
      isAdmin = (role === 'admin');
      roleBadge.textContent = isAdmin ? 'Admin' : 'Student';
      roleBadge.style.borderColor = isAdmin ? '#2ea043' : 'var(--c-border)';
      roleBadge.style.color = isAdmin ? '#0a5d37' : 'var(--c-muted)';
      if (isAdmin) {
        whoEl.textContent = 'Viewing: all students (filtered)';
        adminSearchWrap.style.display = 'block';
        adminBatchWrap.style.display = 'block';
      } else {
        whoEl.textContent = 'Viewing: your attempts';
        studentSummary.style.display = 'block';
      }
      await loadExperiments();
      const urlExp = new URLSearchParams(location.search).get('exp');
      if (urlExp) filterExperiment.value = urlExp;
      $('#apply').addEventListener('click', ()=> applyFilters());
      $('#reset').addEventListener('click', ()=>{
        filterExperiment.value = '';
        if (filterSearch) filterSearch.value = '';
        if (filterBatch) filterBatch.value = '';
        applyFilters();
      });
      $('#export-csv').addEventListener('click', exportCSV);
      await applyFilters();
      setStatus('Ready.');
    }
    init();
  </script>
</body>
</html>
