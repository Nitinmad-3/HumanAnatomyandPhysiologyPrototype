<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Profile | Human Anatomy & Physiology Portal</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f4c3; margin: 0; }
    header { text-align: center; padding: 2rem 1rem 1rem 1rem; }
    h1 { color: #33691e; }
    nav { display: flex; justify-content: center; gap: 2rem; margin-bottom: 2rem; flex-wrap: wrap; }
    nav a, nav button { color: #558b2f; font-weight: bold; text-decoration: none; background: #c5e1a5; padding: 0.6em 1.2em; border-radius: 4px; border: none; cursor: pointer; }
    nav a:hover, nav button:hover { background: #aed581; }

    .container { max-width: 820px; margin: 2rem auto; background: #fff; border-radius: 16px; padding: 1.5rem; box-shadow: 0 2px 12px #c5e1a5; }
    .section-title { color: #33691e; margin: 0 0 1rem 0; }
    .notice { margin-bottom: 1rem; padding: 0.8rem 1rem; border-radius: 8px; font-weight: 600; }
    .notice.info { color: #1b5e20; background: #e8f5e9; border: 1px solid #c8e6c9; }
    .notice.warn { color: #b28704; background: #fff8e1; border: 1px solid #ffe082; }
    .notice.error { color: #b71c1c; background: #ffebee; border: 1px solid #ffcdd2; }

    .chips { display:flex; gap:8px; flex-wrap:wrap; margin: 0 0 12px 0; }
    .chip {
      display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:.85rem; font-weight:700;
      border:1px solid #d7e9c2; background:#eef7e6; color:#33691e;
    }
    .chip.role { background:#eef7e6; border-color:#d7e9c2; color:#33691e; }
    .chip.approved { background:#e8f5e9; border-color:#c8e6c9; color:#1b5e20; }
    .chip.pending { background:#fff8e1; border-color:#ffe082; color:#e65100; }
    .chip.deactivated { background:#ffebee; border-color:#ffcdd2; color:#b71c1c; }

    .grid { display: grid; grid-template-columns: 240px 1fr; gap: 1.25rem; }
    .avatar-card { background: #f9fff2; border: 1px dashed #c5e1a5; border-radius: 12px; padding: 1rem; text-align: center; }
    .avatar-wrap { width: 180px; height: 180px; border-radius: 50%; overflow: hidden; margin: 0 auto 0.75rem; background: #f1f8e9; display: flex; align-items: center; justify-content: center; }
    .avatar-wrap img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-placeholder { color: #8fb36a; font-weight: 600; }
    .avatar-actions { display: flex; flex-direction: column; gap: 0.5rem; }
    .btn { padding: 0.65em 1.1em; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; }
    .btn.primary { background: #558b2f; color: #fff; }
    .btn.primary:hover { background: #33691e; }
    .btn.secondary { background: #c5e1a5; color: #2e7d32; }
    .btn.danger { background: #e57373; color: #fff; }
    .btn.muted { background: #e0e0e0; color: #555; font-weight: 600; }

    .form-card { background: #fff; border-radius: 12px; padding: 1rem; }
    .row { display: grid; grid-template-columns: 1fr 2fr; gap: 0.75rem 1rem; align-items: center; margin-bottom: 0.9rem; }
    label { color: #558b2f; font-weight: 600; }
    input, select { width: 100%; padding: 0.6em; border: 1px solid #aed581; border-radius: 6px; background: #f1f8e9; font-size: 1rem; }
    input:focus, select:focus { outline: none; border-color: #33691e; }
    input[readonly] { background: #f5f5f5; color: #555; border-color: #ddd; }

    .actions { display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap; }
    .footer-links { margin-top: 1rem; display: flex; gap: 0.75rem; flex-wrap: wrap; }

    .progress { background: #f1f8e9; border: 1px solid #c8e6c9; border-radius: 6px; height: 10px; width: 100%; overflow: hidden; }
    .progress > div { height: 100%; background: #66bb6a; width: 0%; transition: width 0.3s ease; border-radius: 6px; }

    .hint { font-size: 0.9rem; color: #6b8f47; margin-top: 0.25rem; }
    .hidden { display: none; }
    .loading { opacity: 0.6; pointer-events: none; }

    @media (max-width: 860px) {
      .grid { grid-template-columns: 1fr; }
      nav { flex-direction: column; gap: 1rem; }
      .row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Your Profile</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="experiments.html">Experiments</a>
      <a id="assessment-tab" href="assessments.html">Assessments</a>
      <a href="references.html">References</a>
      <a id="login-btn" href="login_Version4.html" style="display:inline;">Login</a>
      <button id="logout-btn" style="display:none;">Logout</button>
    </nav>
  </header>

  <div class="container" id="profile-card">
    <div class="chips" id="status-chips" aria-live="polite">
      <span id="chip-role" class="chip role">Role: —</span>
      <span id="chip-approval" class="chip pending">Status: Checking…</span>
    </div>

    <div id="status-info" class="notice info hidden"></div>
    <div id="status-warn" class="notice warn hidden"></div>
    <div id="status-error" class="notice error hidden"></div>

    <h2 class="section-title">Profile Details</h2>

    <div class="progress" aria-label="Profile completeness">
      <div id="progress-bar"></div>
    </div>
    <div class="hint" id="progress-hint"></div>

    <div class="grid">
      <!-- Avatar column -->
      <aside class="avatar-card">
        <div class="avatar-wrap" id="avatar-wrap" aria-live="polite">
          <img id="avatar-img" alt="Profile avatar" class="hidden" />
          <div id="avatar-placeholder" class="avatar-placeholder">No Image</div>
        </div>
        <div class="avatar-actions">
          <input id="avatar-input" type="file" accept="image/*" capture="environment" class="hidden" />
          <button type="button" class="btn secondary" id="pick-avatar-btn">Choose Image</button>
          <button type="button" class="btn muted" id="clear-avatar-btn">Remove Selected</button>
          <button type="button" class="btn danger hidden" id="delete-avatar-btn">Delete Saved Avatar</button>
          <div class="hint">JPG/PNG/WEBP, up to 5 MB. Private: only you and admins can view.</div>
        </div>
      </aside>

      <!-- Form column -->
      <section class="form-card">
        <form id="profile-form" novalidate>
          <div class="row">
            <label for="name">Full Name</label>
            <input id="name" name="name" type="text" placeholder="Your full name" required maxlength="100" autocomplete="name" />
          </div>

          <div class="row">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" placeholder="you@example.com" readonly autocomplete="email" />
          </div>

          <div class="row">
            <label for="role">Role</label>
            <input id="role" name="role" type="text" readonly />
          </div>

          <!-- Admin-only: Department -->
          <div class="row" id="department-row" style="display:none;">
            <label for="department">Department</label>
            <select id="department" name="department">
              <option value="">Select department</option>
              <option value="Phamacology">Phamacology</option>
              <option value="Pharmaceutics">Pharmaceutics</option>
              <option value="Pharmaceutical chemistry">Pharmaceutical chemistry</option>
            </select>
          </div>

          <!-- Student-only: School Name, PRN and Batch -->
          <div class="row" id="school-row">
            <label for="school_name">School Name</label>
            <input id="school_name" name="school_name" type="text" placeholder="Your school/institution" maxlength="120" />
          </div>

          <div class="row" id="prn-row">
            <label for="prn">PRN</label>
            <input id="prn" name="prn" type="text" placeholder="Your PRN" maxlength="32" pattern="[A-Za-z0-9\\-/ ]{3,32}" />
          </div>

          <div class="row" id="batch-row">
            <label for="batch">Batch</label>
            <input id="batch" name="batch" type="text" placeholder="e.g., B1, 2024, etc." maxlength="32" pattern="[A-Za-z0-9\\-/ ]{1,32}" />
          </div>

          <div class="actions">
            <button type="submit" class="btn primary" id="save-btn">Save</button>
            <button type="button" class="btn secondary" id="save-continue-btn" title="Save and go to Assessments">Save & Go</button>
            <button type="button" class="btn muted" id="reload-btn">Reload</button>
          </div>
        </form>

        <div class="footer-links">
          <a id="go-assessments-link" href="assessments.html">Go to Assessments</a>
          <a href="experiments.html">Go to Experiments</a>
          <a href="index.html">Back to Home</a>
        </div>
      </section>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const AVATAR_BUCKET = 'Avatar';

      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const assessTab = document.getElementById('assessment-tab');
      const goAssessLink = document.getElementById('go-assessments-link');

      const statusChips = document.getElementById('status-chips');
      const chipRole = document.getElementById('chip-role');
      const chipApproval = document.getElementById('chip-approval');

      const statusInfo = document.getElementById('status-info');
      const statusWarn = document.getElementById('status-warn');
      const statusError = document.getElementById('status-error');

      const form = document.getElementById('profile-form');
      const saveBtn = document.getElementById('save-btn');
      const saveContinueBtn = document.getElementById('save-continue-btn');
      const reloadBtn = document.getElementById('reload-btn');

      const nameEl = document.getElementById('name');
      const emailEl = document.getElementById('email');
      const roleEl = document.getElementById('role');

      const departmentRow = document.getElementById('department-row');
      const departmentEl = document.getElementById('department');

      const schoolRow = document.getElementById('school-row');
      const schoolEl = document.getElementById('school_name');

      const prnRow = document.getElementById('prn-row');
      const batchRow = document.getElementById('batch-row');
      const prnEl = document.getElementById('prn');
      const batchEl = document.getElementById('batch');

      const avatarImg = document.getElementById('avatar-img');
      const avatarPlaceholder = document.getElementById('avatar-placeholder');
      const avatarInput = document.getElementById('avatar-input');
      const pickAvatarBtn = document.getElementById('pick-avatar-btn');
      const clearAvatarBtn = document.getElementById('clear-avatar-btn');
      const deleteAvatarBtn = document.getElementById('delete-avatar-btn');

      const progressBar = document.getElementById('progress-bar');
      const progressHint = document.getElementById('progress-hint');

      let selectedFile = null;
      let previousAvatarPath = null;
      let currentUserId = null;
      let profileSub = null;

      function setLoading(isLoading) {
        const card = document.getElementById('profile-card');
        if (card) card.classList.toggle('loading', !!isLoading);
        [saveBtn, saveContinueBtn, reloadBtn, pickAvatarBtn, clearAvatarBtn, deleteAvatarBtn].forEach(b => {
          if (b) b.disabled = !!isLoading;
        });
      }

      // Signed URL refresh
      let avatarRefreshTimerId = null;
      function stopAvatarAutoRefresh() { if (avatarRefreshTimerId) { clearInterval(avatarRefreshTimerId); avatarRefreshTimerId = null; } }
      function startAvatarAutoRefresh(sb, path) {
        stopAvatarAutoRefresh();
        if (!path) return;
        avatarRefreshTimerId = setInterval(() => setSignedAvatar(sb, path), 50 * 1000);
      }

      function show(el, msg) { if (!el) return; if (typeof msg === 'string') el.textContent = msg; el.classList.remove('hidden'); }
      function hide(el) { if (el) el.classList.add('hidden'); }
      function clearStatuses() { hide(statusInfo); hide(statusWarn); hide(statusError); }

      function setNav(loggedIn) {
        if (loggedIn) { if (loginBtn) loginBtn.style.display = 'none'; if (logoutBtn) logoutBtn.style.display = 'inline'; }
        else { if (logoutBtn) logoutBtn.style.display = 'none'; if (loginBtn) { loginBtn.style.display = 'inline'; loginBtn.href = 'login_Version4.html'; } }
      }

      function toggleFieldsForRole(role) {
        const isAdmin = (role || '').toLowerCase() === 'admin';
        if (departmentRow) departmentRow.style.display = isAdmin ? '' : 'none';
        if (schoolRow) schoolRow.style.display = isAdmin ? 'none' : '';
        if (prnRow) prnRow.style.display = isAdmin ? 'none' : '';
        if (batchRow) batchRow.style.display = isAdmin ? 'none' : '';
        if (prnEl) prnEl.required = !isAdmin;
        if (batchEl) batchEl.required = !isAdmin;
        if (schoolEl) schoolEl.required = !isAdmin;
        if (departmentEl) departmentEl.required = false;
      }

      function applyEditLock(locked, role) {
        const isStudent = (role || '').toLowerCase() === 'student';
        const shouldLock = !!locked && isStudent;

        const disableSelectors = [
          '#profile-form input',
          '#profile-form select',
          '#profile-form button',
          '#avatar-input',
          '#pick-avatar-btn',
          '#clear-avatar-btn',
          '#delete-avatar-btn'
        ].join(',');

        document.querySelectorAll(disableSelectors).forEach(el => {
          if (el.id === 'reload-btn') return;
          el.disabled = shouldLock;
        });

        if (shouldLock) {
          show(statusWarn, 'Profile editing is locked by admin.');
        } else {
          if (statusWarn.textContent === 'Profile editing is locked by admin.') hide(statusWarn);
        }
      }

      function computeCompleteness(p) {
        const isAdmin = (p?.role || '').toLowerCase() === 'admin';
        const fields = isAdmin ? ['name', 'email', 'role']
                               : ['name', 'email', 'role', 'school_name', 'prn', 'batch'];
        const done = fields.reduce((acc, f) => acc + (p && p[f] ? 1 : 0), 0);
        return Math.round((done / fields.length) * 100);
      }
      function updateProgress(p) {
        const pct = computeCompleteness(p);
        progressBar.style.width = pct + '%';
        progressHint.textContent = 'Profile completeness: ' + pct + '%';
      }

      function setAvatarPreviewUrl(url) {
        if (url) { avatarImg.src = url; avatarImg.classList.remove('hidden'); hide(avatarPlaceholder); }
        else { avatarImg.src = ''; avatarImg.classList.add('hidden'); show(avatarPlaceholder); }
      }

      function validateFile(file) {
        if (!file) return 'No file selected.';
        const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
        const maxBytes = 5 * 1024 * 1024;
        if (!validTypes.includes(file.type)) return 'Please select a JPG, PNG, or WEBP image.';
        if (file.size > maxBytes) return 'Image is too large. Max 5 MB.';
        return '';
      }

      async function initSupabase() {
        if (!window.supabase) {
          show(statusError, 'Failed to load authentication library. Please refresh.');
          throw new Error('Supabase SDK missing');
        }
        const existing = window.sb && window.sb.auth ? window.sb : null;
        const sb = existing || window.supabase.createClient(
          'https://hunlistfklwvpivfjmbk.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bmxpc3Rma2x3dnBpdmZqbWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzA1NDUsImV4cCI6MjA3MzQwNjU0NX0.e-o_qL1Uf5DpW4gX60ktXyuUXmw5YWhqaw6Cx8Xc8Qs'
        );
        window.sb = sb;
        return sb;
      }

      function renderChips({ role, approved, active }) {
        const r = (role || '').toLowerCase() || 'student';
        chipRole.textContent = 'Role: ' + (r.charAt(0).toUpperCase() + r.slice(1));

        chipApproval.classList.remove('approved', 'pending', 'deactivated');
        if (active === false) {
          chipApproval.classList.add('deactivated');
          chipApproval.textContent = 'Status: Deactivated';
        } else if (approved === true || r === 'admin') {
          chipApproval.classList.add('approved');
          chipApproval.textContent = 'Status: Approved';
        } else {
          chipApproval.classList.add('pending');
          chipApproval.textContent = 'Status: Pending Approval';
        }
      }

      function subscribeToProfile(sb, uid) {
        if (profileSub) { try { sb.removeChannel(profileSub); } catch {} }
        profileSub = sb
          .channel('profiles_live_' + uid)
          .on(
            'postgres_changes',
            { event: 'UPDATE', schema: 'public', table: 'profiles', filter: 'id=eq.' + uid },
            async (payload) => {
              const p = payload.new || {};
              roleEl.value = p.role || '';
              if (!nameEl.value) nameEl.value = p.name || '';
              if (departmentEl) departmentEl.value = p.department || '';
              if (schoolEl && !schoolEl.value) schoolEl.value = p.school_name || '';
              if (prnEl && !prnEl.value) prnEl.value = p.prn || '';
              if (batchEl && !batchEl.value) batchEl.value = p.batch || '';

              toggleFieldsForRole(p.role);
              applyEditLock(p.profile_edit_locked === true, p.role);

              if (p.avatar_path !== previousAvatarPath) {
                previousAvatarPath = p.avatar_path || null;
                await setSignedAvatar(sb, previousAvatarPath);
                startAvatarAutoRefresh(sb, previousAvatarPath);
                deleteAvatarBtn.classList.toggle('hidden', !previousAvatarPath);
              }
              renderChips({ role: p.role, approved: p.approved, active: p.active });
              updateProgress(p);
              show(statusInfo, 'Profile updated by server.');
              setTimeout(() => hide(statusInfo), 2000);
            }
          )
          .subscribe();
      }

      async function setSignedAvatar(sb, path) {
        if (!path) { setAvatarPreviewUrl(''); return; }
        try {
          const { data, error } = await sb.storage.from(AVATAR_BUCKET).createSignedUrl(path, 60);
          if (error) throw error;
          setAvatarPreviewUrl(data.signedUrl);
        } catch (e) {
          console.error('createSignedUrl error:', e);
          setAvatarPreviewUrl('');
        }
      }

      async function ensureProfile(sb, uid, authEmail) {
        const { data: profile, error } = await sb
          .from('profiles')
          .select('id, name, email, role, prn, batch, department, avatar_path, school_name, profile_edit_locked, approved, active')
          .eq('id', uid)
          .maybeSingle();
        if (error) throw error;

        let p = profile;
        if (!p) {
          const { data: inserted, error: insErr } = await sb
            .from('profiles')
            .insert({ id: uid, email: authEmail })
            .select()
            .maybeSingle();
          if (insErr) throw insErr;
          p = inserted;
        }

        if (authEmail && p.email !== authEmail) {
          const { error: upEmailErr } = await sb.from('profiles').update({ email: authEmail }).eq('id', uid);
          if (!upEmailErr) p.email = authEmail;
        }
        return p;
      }

      async function loadProfile(sb) {
        setLoading(true);
        clearStatuses();

        const { data: { session }, error: sessErr } = await sb.auth.getSession();
        if (sessErr) console.warn('getSession error:', sessErr);
        if (!session || !session.user) {
          setNav(false);
          show(statusWarn, 'You must be logged in to edit your profile.');
          window.location.href = 'login_Version4.html';
          setLoading(false);
          return null;
        }

        setNav(true);
        currentUserId = session.user.id;
        const authEmail = session.user.email || '';

        let p;
        try {
          p = await ensureProfile(sb, currentUserId, authEmail);
        } catch (e) {
          console.error('Profile load error:', e);
          show(statusError, 'Failed to load profile: ' + (e?.message || 'Please refresh.'));
          setLoading(false);
          return null;
        }

        // Populate UI (email from auth)
        nameEl.value = p.name || '';
        emailEl.value = authEmail;
        roleEl.value = p.role || '';
        schoolEl.value = p.school_name || '';
        prnEl.value = p.prn || '';
        batchEl.value = p.batch || '';
        if (departmentEl) departmentEl.value = p.department || '';
        previousAvatarPath = p.avatar_path || null;

        toggleFieldsForRole(p.role);

        // Friendly status banners
        const isAdmin = (p.role || '').toLowerCase() === 'admin';
        hide(statusInfo); hide(statusWarn); hide(statusError);
        if (p.active === false) {
          show(statusError, 'Your account is deactivated. Please contact an administrator.');
        } else if (!isAdmin && p.approved === false) {
          show(statusInfo, 'Your account is awaiting admin approval. You can still complete your profile.');
        }

        await setSignedAvatar(sb, previousAvatarPath);
        startAvatarAutoRefresh(sb, previousAvatarPath);
        deleteAvatarBtn.classList.toggle('hidden', !previousAvatarPath);

        applyEditLock(p.profile_edit_locked === true, p.role);
        renderChips({ role: p.role, approved: p.approved, active: p.active });
        updateProgress(p);
        subscribeToProfile(sb, currentUserId);

        setLoading(false);
        return p;
      }

      async function uploadAvatar(sb, uid, file) {
        if (!file) return { path: null };
        const errText = validateFile(file);
        if (errText) { show(statusWarn, errText); throw new Error(errText); }
        const cleanName = file.name.replace(/[^A-Za-z0-9._-]/g, '_');
        const path = `${uid}/${Date.now()}_${cleanName}`;
        const { error: upErr } = await sb.storage.from(AVATAR_BUCKET).upload(path, file, {
          upsert: true,
          contentType: file.type || 'image/*'
        });
        if (upErr) throw upErr;
        return { path };
      }

      async function deleteAvatar(sb, path) {
        if (!path) return;
        try { await sb.storage.from(AVATAR_BUCKET).remove([path]); }
        catch (e) { console.warn('Avatar delete warning:', e); }
      }

      async function getApprovalStatus(sb) {
        const { data: { session } } = await sb.auth.getSession();
        if(!session?.user) return { loggedIn: false };
        const { data: p } = await sb
          .from('profiles')
          .select('role, approved, active')
          .eq('id', session.user.id)
          .maybeSingle();
        const role = (p?.role || '').toLowerCase();
        const isAdmin = role === 'admin';
        return {
          loggedIn: true,
          role,
          isAdmin,
          approved: !!p?.approved,
          active: !!p?.active,
          isApprovedActive: isAdmin || (!!p?.approved && !!p?.active)
        };
      }

      async function saveProfile(sb, goNext = false) {
        clearStatuses();
        setLoading(true);

        const { data: { session } } = await sb.auth.getSession();
        if (!session || !session.user) {
          setNav(false);
          show(statusWarn, 'You must be logged in to save your profile.');
          setLoading(false);
          return;
        }
        const uid = session.user.id;

        // Upload new avatar if selected
        let newAvatarPath = null;
        try {
          if (selectedFile) {
            const res = await uploadAvatar(sb, uid, selectedFile);
            newAvatarPath = res.path;
          }
        } catch (e) {
          show(statusError, 'Avatar upload failed: ' + (e?.message || 'Please try again.'));
          setLoading(false);
          return;
        }

        const isAdmin = (roleEl.value || '').toLowerCase() === 'admin';
        const payload = {
          id: uid,
          name: nameEl.value.trim(),
          email: (session.user.email || '').trim()
        };

        if (isAdmin) {
          payload.department = departmentEl ? (departmentEl.value || null) : null;
          payload.school_name = null;
          if (!payload.name) {
            show(statusWarn, 'Please fill in Name.');
            setLoading(false);
            return;
          }
        } else {
          payload.school_name = schoolEl.value.trim();
          payload.prn = prnEl.value.trim();
          payload.batch = batchEl.value.trim();
          payload.department = null;
          if (!payload.name || !payload.school_name || !payload.prn || !payload.batch) {
            show(statusWarn, 'Please fill in Name, School Name, PRN, and Batch.');
            setLoading(false);
            return;
          }
        }

        if (newAvatarPath) {
          payload.avatar_path = newAvatarPath;
          payload.avatar_url = null;
        }

        const { data, error } = await sb
          .from('profiles')
          .upsert(payload, { onConflict: 'id' })
          .select('id, name, email, role, prn, batch, school_name, department, avatar_path, approved, active')
          .maybeSingle();

        if (error) {
          console.error('Profile save error:', error);
          show(statusError, 'Could not save profile: ' + (error.message || 'Please try again.'));
          setLoading(false);
          return;
        }

        if (newAvatarPath && previousAvatarPath && previousAvatarPath !== newAvatarPath) {
          await deleteAvatar(sb, previousAvatarPath);
          previousAvatarPath = newAvatarPath;
        }

        if (newAvatarPath) {
          await setSignedAvatar(sb, newAvatarPath);
          startAvatarAutoRefresh(sb, newAvatarPath);
          selectedFile = null;
          deleteAvatarBtn.classList.remove('hidden');
        }

        show(statusInfo, 'Profile saved successfully.');
        renderChips({ role: data.role, approved: data.approved, active: data.active });
        updateProgress(data);

        // Only navigate to Assessments when approved & active (admins bypass)
        if (goNext) {
          const st = await getApprovalStatus(sb);
          if (st.isApprovedActive) {
            setTimeout(() => { window.location.href = 'assessments.html'; }, 600);
          } else {
            show(statusWarn, st.active === false
              ? 'Saved. Your account is deactivated; Assessments will be available once reactivated.'
              : 'Saved. Your account is pending approval; Assessments will be available once approved.');
          }
        }

        setLoading(false);
      }

      // UI bindings
      pickAvatarBtn.addEventListener('click', () => avatarInput.click());
      avatarInput.addEventListener('change', () => {
        const file = avatarInput.files && avatarInput.files[0];
        if (!file) return;
        const errText = validateFile(file);
        if (errText) { show(statusWarn, errText); avatarInput.value = ''; return; }
        selectedFile = file;
        const objUrl = URL.createObjectURL(file);
        setAvatarPreviewUrl(objUrl);
      });
      clearAvatarBtn.addEventListener('click', () => {
        selectedFile = null;
        avatarInput.value = '';
        if (previousAvatarPath) {
          const sb = window.sb;
          if (sb) setSignedAvatar(sb, previousAvatarPath);
        } else {
          setAvatarPreviewUrl('');
        }
        show(statusInfo, 'Cleared new image selection.');
        setTimeout(() => hide(statusInfo), 1200);
      });
      deleteAvatarBtn.addEventListener('click', async () => {
        const sb = window.sb;
        if (!sb || !previousAvatarPath) return;
        setLoading(true);
        try {
          await deleteAvatar(sb, previousAvatarPath);
          previousAvatarPath = null;
          stopAvatarAutoRefresh();
          await sb.from('profiles').update({ avatar_path: null, avatar_url: null }).eq('id', currentUserId);
          setAvatarPreviewUrl('');
          deleteAvatarBtn.classList.add('hidden');
          show(statusInfo, 'Saved avatar deleted.');
        } catch (e) {
          show(statusError, 'Could not delete avatar. Please try again.');
        } finally {
          setLoading(false);
        }
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const sb = window.sb;
        await saveProfile(sb, false);
      });
      saveContinueBtn.addEventListener('click', async () => {
        const sb = window.sb;
        await saveProfile(sb, true);
      });
      reloadBtn.addEventListener('click', async () => {
        const sb = window.sb;
        await loadProfile(sb);
      });

      // Gate Assessments links by approval/active (UX only; RLS already enforces)
      async function guardAssessNav(e) {
        const sb = window.sb;
        if (!sb) return;
        const st = await getApprovalStatus(sb);
        if (!st.loggedIn) {
          e.preventDefault();
          window.location.href = 'login_Version4.html';
          return;
        }
        if (!st.isApprovedActive) {
          e.preventDefault();
          alert(st.active === false ? 'Your account is deactivated.' : 'Your account is awaiting admin approval.');
        }
      }
      if (assessTab) assessTab.addEventListener('click', guardAssessNav);
      if (goAssessLink) goAssessLink.addEventListener('click', guardAssessNav);

      // Initialize
      (async () => {
        try {
          const sb = await initSupabase();

          // Auth UI
          const { data: { session } } = await sb.auth.getSession();
          setNav(!!(session && session.user));
          sb.auth.onAuthStateChange((_event, newSession) => setNav(!!(newSession && newSession.user)));

          const p = await loadProfile(sb);

          if (p && p.avatar_path) {
            deleteAvatarBtn.classList.remove('hidden');
          } else {
            deleteAvatarBtn.classList.add('hidden');
          }
        } catch (err) {
          console.error('Profile init error:', err);
          show(statusError, 'Unexpected error initializing profile page: ' + (err?.message || ''));
        }
      })();

      // Unsaved changes warning
      let pristineSnapshot = '';
      function snapshot() {
        return [
          nameEl.value, emailEl.value, roleEl.value, schoolEl.value, prnEl.value, batchEl.value, (departmentEl ? departmentEl.value : ''),
          selectedFile ? selectedFile.name : ''
        ].join('|');
      }
      const track = () => { pristineSnapshot = snapshot(); };
      window.addEventListener('load', track);
      form.addEventListener('input', () => {
        window.onbeforeunload = (snapshot() !== pristineSnapshot) ? () => true : null;
      });
      form.addEventListener('submit', () => { window.onbeforeunload = null; });

      // Logout handler
      const logoutBtnEl = document.getElementById('logout-btn');
      if (logoutBtnEl) {
        logoutBtnEl.addEventListener('click', async (e) => {
          e.preventDefault();
          try { await window.sb?.auth.signOut(); } catch (err) { console.warn('signOut error:', err); }
          window.location.href = 'index.html';
        });
      }
    });
  </script>
</body>
</html>
