<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Assessment: Determination of Blood Group</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #e3f2fd; margin: 0;}
    header { text-align: center; padding: 2rem 1rem 1rem 1rem;}
    h1 { color: #1565c0; }
    nav a { margin:0 .5rem; text-decoration:none; color:#1565c0; font-weight:600; }
    .container { max-width: 800px; margin: 2rem auto; background: #fff; border-radius: 16px; padding: 2rem; box-shadow: 0 2px 8px #90caf9;}
    .question { margin-bottom: 1.5em;}
    .student-info label { display: block; margin: 0.5em 0 0.2em;}
    .student-info input, .student-info select { width: 100%; padding: 0.5em; margin-bottom: 1em;}
    .assignment-upload { background:#e1f5fe; padding:1em; border-radius:10px; margin:1em 0 2em; }
    .assignment-status { font-size:.9em; margin-top:.4em; color:#388e3c; }
    .note { font-size:.75em; color:#1565c0; margin-top:.2em; }
    .declaration { margin: 2em 0 1em 0; }
    .submit-btn { padding: 0.8em 2em; font-size: 1.1em; border: none; background: #1565c0; color: #fff; border-radius: 5px;}
    .submit-btn:disabled { background: #90caf9; }
    .result { font-size: 1.3em; color: #388e3c; margin-top: 2em;}
    .error { color: #d32f2f; margin-bottom: 1em;}
    img.question-img { max-width: 400px; display: block; margin-bottom: 1em; }
    label.dropdown-label { display: inline-block; min-width: 80px; }
    .block-access-msg {
      border-radius:10px;
      background:#ffebee;
      color:#b71c1c;
      border:1px solid #c62828;
      font-size:1.05em;
      margin:2em auto;
      padding:1.25em 1.5em;
      text-align:center;
      max-width:800px;
      font-weight:600;
    }
    .block-access-msg a { color:#b71c1c; text-decoration:underline; }
    .admin-banner {
      margin:0 auto 14px;
      max-width:800px;
      background:#fff8e1;
      color:#8d6e63;
      border:1px solid #ffe0b2;
      border-radius:10px;
      padding:10px 12px;
      font-size:.95em;
    }
    @media (max-width: 600px) { .container { padding: 1rem; } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
</head>
<body>
  <header>
    <h1>Assessment: Determination of Blood Group</h1>
    <nav>
      <a href="../index.html">Home</a>
      <a href="../experiments.html">Experiments</a>
      <a href="../assessments.html">Assessments</a>
      <a href="../references.html">References</a>
    </nav>
  </header>
  <div id="adminBannerMount"></div>
  <div class="container" id="mainContainer" style="display:none;">
    <form id="assessmentForm" autocomplete="off">
      <div class="student-info">
        <h2>Student Information</h2>
        <label for="studentName">Student Name*</label>
        <input type="text" id="studentName" name="studentName" required>
        <label for="schoolName">School Name*</label>
        <input type="text" id="schoolName" name="schoolName" required>
        <label for="prnNumber">PRN Number*</label>
        <input type="text" id="prnNumber" name="prnNumber" required>
        <label for="batchNumber">Batch Number*</label>
        <select id="batchNumber" name="batchNumber" required>
          <option value="">Select Batch</option>
          <option value="A">A</option>
          <option value="B">B</option>
        </select>
        <label for="emailId">Email ID (add your institutional email id)*</label>
        <input type="email" id="emailId" name="emailId" required>
        <div class="note" id="profileNote"></div>
      </div>
      <!-- Assignment Upload -->
      <div class="assignment-upload">
        <label for="assignmentFile"><b>Upload Assignment (PDF only)*</b></label>
        <input type="file" id="assignmentFile" name="assignmentFile" accept="application/pdf" required>
        <div id="assignmentStatus" class="assignment-status"></div>
        <div class="note">Must finish uploading before submitting the assessment.</div>
      </div>
      <hr>
      <div id="questionsSection"></div>
      <div class="declaration">
        <input type="checkbox" id="declaration" required>
        <label for="declaration">
          I hereby declare that this assessment is for my own progress and benefit. All answers submitted are my own and not generated by AI or provided by friends.
        </label>
      </div>
      <button type="submit" class="submit-btn" id="submitBtn">Submit</button>
      <div class="error" id="errorMsg"></div>
      <div class="result" id="resultMsg"></div>
    </form>
  </div>
  <div id="blockMsg" style="display:none;"></div>
  <script>
    // ---- Supabase Constants & Init ----
    const DEFAULT_ASSESSMENT_ID = 6;
    const EXPERIMENT_ID = 'assessment-6-blood-group';
    const ASSESSMENT_TITLE = 'Experiment No. 6 (Determination of Blood Group)';
    const ASSIGNMENT_BUCKET = 'assignments';
    const pageStartTime = Date.now();
    const urlParams = new URLSearchParams(location.search);
    const ASSESSMENT_ID = Number(urlParams.get('id')) || DEFAULT_ASSESSMENT_ID;
    let sb = null;
    let isAdmin = false;
    try {
      sb = window.supabase.createClient(
        'https://hunlistfklwvpivfjmbk.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bmxpc3Rma2x3dnBpdmZqbWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzA1NDUsImV4cCI6MjA3MzQwNjU0NX0.e-o_qL1Uf5DpW4gX60ktXyuUXmw5YWhqaw6Cx8Xc8Qs'
      );
    } catch (e) { console.warn('Supabase init failed:', e); }
    function showBlock(messageHtml){
      const blockMsg = document.getElementById('blockMsg');
      const main = document.getElementById('mainContainer');
      if (main) main.style.display = 'none';
      blockMsg.style.display = '';
      blockMsg.innerHTML = `<div class="block-access-msg">${messageHtml}</div>`;
    }
    function showMain(){
      const main = document.getElementById('mainContainer');
      const blockMsg = document.getElementById('blockMsg');
      if (blockMsg) blockMsg.style.display = 'none';
      if (main) main.style.display = '';
    }
    function showAdminBanner(text){
      const mount = document.getElementById('adminBannerMount');
      if (!mount) return;
      mount.innerHTML = `<div class="admin-banner"><b>Admin preview:</b> ${text}</div>`;
    }
    async function checkProfileAccess() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session?.user) {
        showBlock(`Please <a href="../login_Version4.html">sign in</a> to access this experiment.`);
        return { ok:false, uid:null, isAdmin:false };
      }
      const uid = session.user.id;
      const { data: prof, error } = await sb
        .from('profiles')
        .select('role, approved, active')
        .eq('id', uid)
        .maybeSingle();
      if (error) {
        console.warn('profile lookup failed:', error);
        showBlock('Unable to load your profile. Please try again.');
        return { ok:false, uid:null, isAdmin:false };
      }
      const role = String(prof?.role || '').toLowerCase();
      isAdmin = role === 'admin';
      if (isAdmin) return { ok:true, uid, isAdmin:true };
      if (!prof) {
        showBlock('Profile not found. Please contact administrator.');
        return { ok:false, uid:null, isAdmin:false };
      }
      if (prof.approved === false) {
        showBlock('Your account is not approved yet by the admin.');
        return { ok:false, uid:null, isAdmin:false };
      }
      if (prof.active === false) {
        showBlock('Your account has been deactivated by the admin.');
        return { ok:false, uid:null, isAdmin:false };
      }
      return { ok:true, uid, isAdmin:false };
    }
    async function getAssessmentRowById(id) {
      try {
        const { data, error } = await sb
          .from('assessments')
          .select('id, title, locked, window_start, window_end')
          .eq('id', id)
          .maybeSingle();
        if (error) {
          console.warn('assessments(id) lookup error:', error);
          return null;
        }
        return data || null;
      } catch { return null; }
    }
    async function gate() {
      if (!sb) {
        showBlock('Unable to initialize backend. Please refresh the page.');
        return;
      }
      const prof = await checkProfileAccess();
      if (!prof.ok) return;
      const row = await getAssessmentRowById(ASSESSMENT_ID);
      if (prof.isAdmin) {
        const flags = [];
        if (!row) flags.push('not configured');
        else {
          const now = new Date();
          const start = row.window_start ? new Date(row.window_start) : null;
          const end   = row.window_end ? new Date(row.window_end) : null;
          if (row.locked) flags.push('locked');
          if (start && now < start) flags.push('not yet open');
          if (end && now > end) flags.push('closed');
        }
        if (flags.length) showAdminBanner(`This assessment is ${flags.join(' & ')} for students.`);
        showMain();
        renderQuestions();
        autofillFromProfile();
        return;
      }
      if (!row) {
        showBlock('Assessment not available right now. Please try again later.');
        return;
      }
      const now = new Date();
      const start = row.window_start ? new Date(row.window_start) : null;
      const end   = row.window_end ? new Date(row.window_end) : null;
      if (row.locked === true) {
        showBlock('This experiment is currently locked by the admin.');
        return;
      }
      if (start && now < start) {
        showBlock('This experiment is not yet open. Please check back later.');
        return;
      }
      if (end && now > end) {
        showBlock('This experiment is closed.');
        return;
      }
      showMain();
      renderQuestions();
      autofillFromProfile();
    }
    async function autofillFromProfile() {
      try {
        const { data: { session } } = await sb.auth.getSession();
        if (!session?.user) return;
        const uid = session.user.id;
        const { data: profile, error } = await sb
          .from('profiles')
          .select('name, email, prn, batch, school_name')
          .eq('id', uid)
          .maybeSingle();
        if (error || !profile) return;
        const studentNameEl = document.getElementById('studentName');
        const schoolNameEl = document.getElementById('schoolName');
        const prnEl = document.getElementById('prnNumber');
        const batchEl = document.getElementById('batchNumber');
        const emailEl = document.getElementById('emailId');
        if (studentNameEl && !studentNameEl.value) studentNameEl.value = profile.name || '';
        if (schoolNameEl && !schoolNameEl.value) schoolNameEl.value = profile.school_name || '';
        if (prnEl && !prnEl.value) prnEl.value = profile.prn || '';
        if (batchEl && !batchEl.value && profile.batch) {
          const match = Array.from(batchEl.options).find(o => (o.value || '').toLowerCase() === String(profile.batch).toLowerCase());
          if (!match && profile.batch) {
            const opt = document.createElement('option');
            opt.value = profile.batch;
            opt.textContent = profile.batch;
            batchEl.appendChild(opt);
          }
          batchEl.value = profile.batch;
        }
        if (emailEl && !emailEl.value) emailEl.value = profile.email || session.user.email || '';
        // LOCK FIELDS if not admin
        if (!isAdmin) {
          studentNameEl && (studentNameEl.readOnly = true);
          schoolNameEl && (schoolNameEl.readOnly = true);
          prnEl && (prnEl.readOnly = true);
          emailEl && (emailEl.readOnly = true);
          batchEl && (batchEl.disabled = true);
        } else {
          studentNameEl && (studentNameEl.readOnly = false);
          schoolNameEl && (schoolNameEl.readOnly = false);
          prnEl && (prnEl.readOnly = false);
          emailEl && (emailEl.readOnly = false);
          batchEl && (batchEl.disabled = false);
        }
      } catch (e) {}
    }
    function shuffleArray(arr){
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    const questions = [
      {
        type: "mcq",
        text: "1. Which antigen is present on the surface of red blood cells in a person with blood group AB negative?",
        options: [
          "Only A antigen",
          "Only B antigen",
          "Both A and B antigens",
          "A, B, and D antigens"
        ],
        answer: "Both A and B antigens"
      },
      {
        type: "mcq",
        text: "2. What will happen if a person with blood group A receives blood from a group B donor?",
        options: [
          "No reaction will occur",
          "The recipient’s anti-B antibodies will cause agglutination",
          "The recipient’s anti-A antibodies will cause agglutination",
          "A and B antigens will neutralize each other"
        ],
        answer: "The recipient’s anti-B antibodies will cause agglutination"
      },
      {
        type: "mcq",
        text: "3. Which antibody is found in the plasma of a person with blood group O?",
        options: [
          "Only anti-A",
          "Only anti-B",
          "Both anti-A and anti-B",
          "No antibodies"
        ],
        answer: "Both anti-A and anti-B"
      },
      {
        type: "mcq",
        text: "4. Why is blood group O negative considered a universal donor for red blood cell transfusions?",
        options: [
          "It has no antigens on red cells",
          "It has both anti-A and anti-B antibodies",
          "It has D antigen present",
          "It has only A antigen"
        ],
        answer: "It has no antigens on red cells"
      },
      {
        type: "mcq",
        text: "5. Which of the following statements about the Rh factor is correct?",
        options: [
          "It is an antibody found in plasma",
          "It is only present in blood group AB",
          "It is an antigen that, if present, makes the blood type positive",
          "It is only important during the first pregnancy"
        ],
        answer: "It is an antigen that, if present, makes the blood type positive"
      },
      {
        type: "mcq",
        text: "6. During blood typing, clumping is observed with Anti-A and Anti-D sera but not with Anti-B. What is the blood group?",
        options: [
          "A positive",
          "A negative",
          "B positive",
          "O positive"
        ],
        answer: "A positive"
      },
      {
        type: "mcq",
        text: "7. A person with blood group AB positive can receive blood from which of the following donors?",
        options: [
          "Only AB positive",
          "Any blood group",
          "A positive and B positive only",
          "O negative only"
        ],
        answer: "Any blood group"
      },
      {
        type: "mcq",
        text: "8. Hemolytic disease of the newborn is most likely to occur in which scenario?",
        options: [
          "Mother is Rh negative, father is Rh positive, baby is Rh positive",
          "Mother and baby are both Rh positive",
          "Mother is blood group A, baby is blood group O",
          "Father is blood group O, baby is blood group B"
        ],
        answer: "Mother is Rh negative, father is Rh positive, baby is Rh positive"
      },
      {
        type: "image-labels",
        text: "9. Identify the blood group shown in each labelled field of the diagram below:",
        image: "../assets/images/experiment-6/assessment/Blood Group.png",
        labels: [
          {
            name: "1",
            answer: "O negative",
            options: [
              "O negative",
              "A Positive",
              "B positive",
              "AB Positive"
            ]
          },
          {
            name: "2",
            answer: "A Positive",
            options: [
              "O negative",
              "A Positive",
              "B positive",
              "AB Positive"
            ]
          },
          {
            name: "3",
            answer: "B positive",
            options: [
              "O negative",
              "A Positive",
              "B positive",
              "AB Positive"
            ]
          },
          {
            name: "4",
            answer: "AB Positive",
            options: [
              "O negative",
              "A Positive",
              "B positive",
              "AB Positive"
            ]
          }
        ]
      }
    ];
    questions.forEach(q => {
      if(q.options) shuffleArray(q.options);
      if(q.labels) q.labels.forEach(lab => shuffleArray(lab.options));
    });
    function renderQuestions(){
      const qs = document.getElementById('questionsSection');
      if(!qs){
        console.error('questionsSection not found in DOM.');
        return;
      }
      qs.innerHTML = '<h2>Assessment Questions</h2>';
      questions.forEach((q, idx) => {
        let html = `<div class="question"><label><b>${q.text}</b></label><br>`;
        if(q.type === "mcq"){
          q.options.forEach(opt => {
            html += `<label><input type="radio" name="q${idx}" value="${opt}" required> ${opt}</label><br>`;
          });
        } else if(q.type === "dropdown"){
          html += `<select name="q${idx}" required><option value="">Select...</option>`;
          q.options.forEach(opt => { html += `<option value="${opt}">${opt}</option>`; });
          html += '</select>';
        } else if(q.type === "image-labels"){
          html += `<img src="${q.image}" alt="Labelled diagram" class="question-img"><br>`;
          q.labels.forEach((label, lid) => {
            html += `<label class="dropdown-label">${label.name}:</label> <select name="q${idx}_label${lid}" required>`;
            html += `<option value="">Select...</option>`;
            label.options.forEach(opt => { html += `<option value="${opt}">${opt}</option>`; });
            html += `</select><br>`;
          });
        }
        html += '</div>';
        qs.innerHTML += html;
      });
    }
    let uploadedAssignmentPath = null;
    let uploadedAssignmentUrl  = null;
    let uploadingAssignment    = false;
    document.getElementById('assignmentFile').addEventListener('change', async (e) => {
      const statusEl = document.getElementById('assignmentStatus');
      const file = e.target.files[0];
      statusEl.textContent = '';
      uploadedAssignmentPath = null;
      uploadedAssignmentUrl  = null;
      if(!file) return;
      if(file.type !== 'application/pdf'){
        statusEl.textContent = 'Only PDF files allowed.';
        e.target.value = '';
        return;
      }
      uploadingAssignment = true;
      statusEl.textContent = 'Uploading PDF...';
      const { data:{ session } } = await sb.auth.getSession();
      if(!session?.user){
        statusEl.textContent = 'Login required before upload.';
        uploadingAssignment = false;
        e.target.value = '';
        return;
      }
      const uid = session.user.id;
      const filePath = `${uid}/${EXPERIMENT_ID}/${Date.now()}.pdf`;
      const { error: upErr } = await sb.storage.from(ASSIGNMENT_BUCKET).upload(
        filePath, file, { upsert:true, contentType:'application/pdf' }
      );
      if(upErr){
        statusEl.textContent = 'Upload failed: ' + upErr.message;
        uploadingAssignment = false;
        return;
      }
      const { data: urlData } = sb.storage.from(ASSIGNMENT_BUCKET).getPublicUrl(filePath);
      uploadedAssignmentPath = filePath;
      uploadedAssignmentUrl  = urlData?.publicUrl || null;
      uploadingAssignment = false;
      statusEl.textContent = 'PDF uploaded successfully.';
    });
    document.getElementById('assessmentForm').onsubmit = async function(e){
      e.preventDefault();
      const errEl = document.getElementById('errorMsg');
      const resEl = document.getElementById('resultMsg');
      const submitBtn = document.getElementById('submitBtn');
      errEl.textContent = '';
      resEl.textContent = '';
      if(!uploadedAssignmentPath){
        errEl.textContent = uploadingAssignment
          ? 'Please wait: assignment is still uploading...'
          : 'Please upload the assignment PDF before submitting.';
        return;
      }
      const form = e.target;
      let allAnswered = true;
      const answers = [];
      for(let i=0; i<questions.length; i++){
        const q = questions[i];
        if(['mcq','dropdown'].includes(q.type)){
          const v = form[`q${i}`]?.value?.trim() || '';
          if(!v) allAnswered = false;
          answers.push(v);
        } else if(q.type === 'image-labels'){
          const labelVals = [];
          for(let lid=0; lid<q.labels.length; lid
