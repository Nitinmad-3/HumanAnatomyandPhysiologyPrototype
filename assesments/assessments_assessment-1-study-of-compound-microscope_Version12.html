<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Assessment: Study of Compound Microscope</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background:#f3e5f5; margin:0; }
    header { text-align:center; padding:2rem 1rem 1rem; }
    h1 { color:#6a1b9a; margin:0 0 .5rem; }
    nav a { margin:0 .5rem; text-decoration:none; color:#6a1b9a; font-weight:600; }
    .container { max-width:800px; margin:2rem auto; background:#fff; border-radius:16px; padding:2rem; box-shadow:0 2px 8px #ce93d8;}
    .student-info label { display:block; margin:.5em 0 .2em; }
    .student-info input, .student-info select { width:100%; padding:.55em; margin-bottom:.8em; }
    .assignment-upload { background:#ede7f6; padding:1em; border-radius:10px; margin:1em 0 2em; }
    .assignment-status { font-size:.9em; margin-top:.4em; color:#388e3c; }
    .note { font-size:.75em; color:#6a1b9a; margin-top:.2em; }
    .question { margin-bottom:1.4em; }
    img.question-img { max-width:400px; display:block; margin:.4em 0 1em; }
    label.dropdown-label { display:inline-block; min-width:70px; }
    .declaration { margin:2em 0 1em; }
    .submit-btn { padding:.85em 2em; font-size:1.05em; border:none; background:#6a1b9a; color:#fff; border-radius:6px; cursor:pointer; }
    .submit-btn:disabled { background:#b39ddb; cursor:not-allowed; }
    .error { color:#d32f2f; margin-top:1em; font-weight:500; }
    .result { margin-top:1.2em; color:#283593; font-size:1em; font-weight:500; min-height:1.2em; }

    /* Block message */
    .block-access-msg {
      border-radius:10px;
      background:#ffebee;
      color:#b71c1c;
      border:1px solid #c62828;
      font-size:1.05em;
      margin:2em auto;
      padding:1.25em 1.5em;
      text-align:center;
      max-width:800px;
      font-weight:600;
    }
    .block-access-msg a { color:#b71c1c; text-decoration:underline; }

    @media (max-width:600px){ .container { padding:1.2rem; } img.question-img { max-width:100%; } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
</head>
<body>
  <header>
    <h1>Assessment: Study of Compound Microscope</h1>
    <nav>
      <a href="../index.html">Home</a>
      <a href="../experiments.html">Experiments</a>
      <a href="../references.html">References</a>
    </nav>
  </header>

  <!-- Form container (hidden until access is verified) -->
  <div class="container" id="mainContainer" style="display:none;">
    <form id="assessmentForm" autocomplete="off">
      <div class="student-info">
        <h2 style="margin-top:0;">Student Information</h2>
        <label for="studentName">Student Name*</label>
        <input type="text" id="studentName" name="studentName" required>

        <label for="schoolName">School Name*</label>
        <input type="text" id="schoolName" name="schoolName" required>

        <label for="prnNumber">PRN Number*</label>
        <input type="text" id="prnNumber" name="prnNumber" required>

        <label for="batchNumber">Batch Number*</label>
        <select id="batchNumber" name="batchNumber" required>
          <option value="">Select Batch</option>
          <option value="A">A</option>
          <option value="B">B</option>
        </select>

        <label for="emailId">Email ID (institutional)*</label>
        <input type="email" id="emailId" name="emailId" required>

        <div class="note" id="profileNote"></div>
      </div>

      <!-- Assignment Upload -->
      <div class="assignment-upload">
        <label for="assignmentFile"><b>Upload Assignment (PDF only)*</b></label>
        <input type="file" id="assignmentFile" name="assignmentFile" accept="application/pdf" required>
        <div id="assignmentStatus" class="assignment-status"></div>
        <div class="note">Must finish uploading before submitting the assessment.</div>
      </div>

      <hr>
      <!-- Questions container -->
      <div id="questionsSection"></div>

      <div class="declaration">
        <input type="checkbox" id="declaration" required>
        <label for="declaration">
          I declare this assessment is my own work and not generated by AI or other students.
        </label>
      </div>

      <button type="submit" id="submitBtn" class="submit-btn">Submit</button>
      <div id="errorMsg" class="error"></div>
      <div id="resultMsg" class="result"></div>
    </form>
  </div>

  <!-- Block message container -->
  <div id="blockMsg" style="display:none;"></div>

  <script>
    // ---- Supabase Constants & Init ----
    const EXPERIMENT_ID = 'assessment-1-study-of-compound-microscope';
    const ASSESSMENT_TITLE = 'Experiment No. 1 (Study of Compound Microscope)';
    const ASSIGNMENT_BUCKET = 'assignments';
    const pageStartTime = Date.now();

    let supabaseAvailable = !!(window.supabase && typeof window.supabase.createClient === 'function');
    let sb = null;
    if (supabaseAvailable) {
      try {
        sb = window.supabase.createClient(
          'https://hunlistfklwvpivfjmbk.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bmxpc3Rma2x3dnBpdmZqbWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzA1NDUsImV4cCI6MjA3MzQwNjU0NX0.e-o_qL1Uf5DpW4gX60ktXyuUXmw5YWhqaw6Cx8Xc8Qs'
        );
      } catch (e) {
        console.warn('Supabase init failed:', e);
        supabaseAvailable = false;
      }
    }

    // ---- Access control helpers ----
    function showBlock(messageHtml){
      const blockMsg = document.getElementById('blockMsg');
      const main = document.getElementById('mainContainer');
      if (main) main.style.display = 'none';
      blockMsg.style.display = '';
      blockMsg.innerHTML = `<div class="block-access-msg">${messageHtml}</div>`;
    }
    function showMain(){
      const main = document.getElementById('mainContainer');
      const blockMsg = document.getElementById('blockMsg');
      if (blockMsg) blockMsg.style.display = 'none';
      if (main) main.style.display = '';
    }

    // Try multiple possible assessment identifiers so we don't rely on one column existing
    async function getAssessmentRow() {
      const attempts = [
        { col: 'slug',          val: EXPERIMENT_ID },
        { col: 'experiment_id', val: EXPERIMENT_ID },
        { col: 'code',          val: EXPERIMENT_ID },
        { col: 'title',         val: ASSESSMENT_TITLE }
      ];
      for (const a of attempts) {
        try {
          const { data, error } = await sb
            .from('assessments')
            .select('id, title, locked, window_start, window_end')
            .eq(a.col, a.val)
            .maybeSingle();
          if (error) {
            // Column might not exist -> skip to next
            if (String(error.code) === '42703' || /column .* does not exist/i.test(error.message || '')) continue;
            console.warn('assessments lookup error ('+a.col+'):', error.message || error);
            continue;
          }
          if (data) return data;
        } catch (e) { /* ignore and try next */ }
      }
      return null;
    }

    async function checkProfileAccess() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session?.user) {
        showBlock(`Please <a href="../login_Version4.html">sign in</a> to access this experiment.`);
        return { ok:false, uid:null };
      }
      const uid = session.user.id;
      const { data: prof, error } = await sb.from('profiles').select('approved, active').eq('id', uid).maybeSingle();
      if (error) {
        console.warn('profile lookup failed:', error);
        showBlock('Unable to load your profile. Please try again.');
        return { ok:false, uid:null };
      }
      if (!prof) {
        showBlock('Profile not found. Please contact administrator.');
        return { ok:false, uid:null };
      }
      if (prof.approved === false) {
        showBlock('Your account is not approved yet by the admin.');
        return { ok:false, uid:null };
      }
      if (prof.active === false) {
        showBlock('Your account has been deactivated by the admin.');
        return { ok:false, uid:null };
      }
      return { ok:true, uid };
    }

    async function gate() {
      if (!supabaseAvailable || !sb) {
        showBlock('Unable to initialize backend. Please refresh the page.');
        return;
      }
      // 1) Require approved + active profile
      const prof = await checkProfileAccess();
      if (!prof.ok) return;

      // 2) Assessment must be open (not locked and within window)
      const row = await getAssessmentRow();
      if (!row) {
        showBlock('Assessment not available right now. Please try again later.');
        return;
      }
      const now = new Date();
      const start = row.window_start ? new Date(row.window_start) : null;
      const end   = row.window_end ? new Date(row.window_end) : null;

      if (row.locked === true) {
        showBlock('This experiment is currently locked by the admin.');
        return;
      }
      if (start && now < start) {
        showBlock('This experiment is not yet open. Please check back later.');
        return;
      }
      if (end && now > end) {
        showBlock('This experiment is closed.');
        return;
      }

      // Allowed -> reveal and continue
      showMain();
      renderQuestions();
      autofillFromProfile();
    }

    // ---- Autofill from Profile ----
    async function autofillFromProfile() {
      if (!supabaseAvailable || !sb) return;
      try {
        const { data: { session }, error: sessErr } = await sb.auth.getSession();
        if (sessErr) console.warn('getSession error:', sessErr);
        if (!session?.user) return;

        const uid = session.user.id;
        const { data: profile, error } = await sb
          .from('profiles')
          .select('name, email, prn, batch, school_name')
          .eq('id', uid)
          .maybeSingle();

        if (error || !profile) return;

        const studentNameEl = document.getElementById('studentName');
        const schoolNameEl = document.getElementById('schoolName');
        const prnEl = document.getElementById('prnNumber');
        const batchEl = document.getElementById('batchNumber');
        const emailEl = document.getElementById('emailId');

        if (studentNameEl && !studentNameEl.value) studentNameEl.value = profile.name || '';
        if (schoolNameEl && !schoolNameEl.value) schoolNameEl.value = profile.school_name || '';
        if (prnEl && !prnEl.value) prnEl.value = profile.prn || '';
        if (batchEl && !batchEl.value && profile.batch) {
          const match = Array.from(batchEl.options).find(o => (o.value || '').toLowerCase() === String(profile.batch).toLowerCase());
          if (!match && profile.batch) {
            const opt = document.createElement('option');
            opt.value = profile.batch;
            opt.textContent = profile.batch;
            batchEl.appendChild(opt);
          }
          batchEl.value = profile.batch;
        }
        if (emailEl && !emailEl.value) emailEl.value = profile.email || session.user.email || '';
      } catch (e) {}
    }

    // ---- Utility ----
    function shuffleArray(arr){
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // ---- Questions ----
    const questions = [
      { type: "mcq", text: "1. Which part of the compound microscope connects the base to the body tube?", options: ["Arm","Stage","Pillar","Draw tube"], answer: "Arm" },
      { type: "mcq", text: "2. The function of the diaphragm in a compound microscope is to:", options: ["Magnify the image","Adjust the amount of light passing through the specimen","Hold the slide in place","Focus the image"], answer: "Adjust the amount of light passing through the specimen" },
      { type: "mcq", text: "3. Which lens offers the highest magnification in a compound microscope?", options: ["Low power objective","High power objective","Oil immersion objective","Eyepiece lens"], answer: "Oil immersion objective" },
      { type: "mcq", text: "4. Which adjustment knob is used for precise focusing?", options: ["Coarse adjustment","Fine adjustment","Stage adjustment","Condenser adjustment"], answer: "Fine adjustment" },
      { type: "dropdown", text: "5. Name the lens through which you observe the specimen in a microscope.", options: ["Eyepiece lens","Objective lens","Mirror","Stage"], answer: "Eyepiece lens" },
      { type: "dropdown", text: "6. What is the recommended material for cleaning microscope lenses?", options: ["Lens paper","Tissue paper","Cloth","Hands"], answer: "Lens paper" },
      { type: "dropdown", text: "7. Which mirror is used when the light source is weak?", options: ["Concave mirror","Plane mirror","Convex mirror","No mirror"], answer: "Concave mirror" },
      { type: "dropdown", text: "8. What is the usual magnification power of a standard eyepiece lens?", options: ["10x","5x","40x","100x"], answer: "10x" },
      { 
        type: "image-labels", 
        text: "9. Identify the labelled parts of the microscope in the image below.", 
        image: "../assets/images/experiment-1/Assessment/labelquestion.jpg",
        labels: [
          { name: "1", answer: "Eye Piece", options: ["Eye Piece","Objective Lens","Fine adjustment Screw","Condenser","Stage"] },
          { name: "2", answer: "Objective Lens", options: ["Objective Lens","Eye Piece","Mirror","Condenser","Base"] },
          { name: "3", answer: "Condenser", options: ["Condenser","Stage","Objective Lens","Base","Fine adjustment Screw"] },
          { name: "4", answer: "Fine adjustment Screw", options: ["Fine adjustment Screw","Coarse adjustment","Mirror","Arm","Condenser"] }
        ]
      },
      { type: "mcq", text: "10. Which of the following statements is NOT true?", options: [
        "When focusing the slide, care should be taken not to crack the glass slide",
        "The slide should be placed on the stage with the cover slip on the upper surface",
        "When setting up, adjust the eye pieces to the dimension of your eyes",
        "Always view your specimen using the highest magnification lens first"
      ], answer: "Always view your specimen using the highest magnification lens first" }
    ];

    questions.forEach(q => {
      if(q.options) shuffleArray(q.options);
      if(q.labels) q.labels.forEach(lab => shuffleArray(lab.options));
    });

    // ---- Render Questions ----
    function renderQuestions(){
      const qs = document.getElementById('questionsSection');
      if(!qs) return;
      qs.innerHTML = '<h2>Assessment Questions</h2>';
      questions.forEach((q, idx) => {
        let html = `<div class="question"><label><b>${q.text}</b></label><br>`;
        if(q.type === "mcq"){
          q.options.forEach(opt => {
            html += `<label><input type="radio" name="q${idx}" value="${opt}" required> ${opt}</label><br>`;
          });
        } else if(q.type === "dropdown"){
          html += `<select name="q${idx}" required><option value="">Select...</option>`;
          q.options.forEach(opt => { html += `<option value="${opt}">${opt}</option>`; });
          html += '</select>';
        } else if(q.type === "image-labels"){
          html += `<img src="${q.image}" alt="Labelled microscope diagram" class="question-img"><br>`;
          q.labels.forEach((label, lid) => {
            html += `<label class="dropdown-label">${label.name}:</label> <select name="q${idx}_label${lid}" required>`;
            html += `<option value="">Select...</option>`;
            label.options.forEach(opt => { html += `<option value="${opt}">${opt}</option>`; });
            html += `</select><br>`;
          });
        }
        html += `</div>`;
        qs.innerHTML += html;
      });
    }

    // ---- Assignment Upload ----
    let uploadedAssignmentPath = null;
    let uploadedAssignmentUrl  = null;
    let uploadingAssignment    = false;

    document.getElementById('assignmentFile').addEventListener('change', async (e) => {
      const statusEl = document.getElementById('assignmentStatus');
      const file = e.target.files[0];
      statusEl.textContent = '';
      uploadedAssignmentPath = null;
      uploadedAssignmentUrl  = null;

      if(!file) return;
      if(file.type !== 'application/pdf'){
        statusEl.textContent = 'Only PDF files allowed.';
        e.target.value = '';
        return;
      }

      uploadingAssignment = true;
      statusEl.textContent = 'Uploading PDF...';

      const { data:{ session } } = await sb.auth.getSession();
      if(!session?.user){
        statusEl.textContent = 'Login required before upload.';
        uploadingAssignment = false;
        e.target.value = '';
        return;
      }

      const uid = session.user.id;
      const filePath = `${uid}/${EXPERIMENT_ID}/${Date.now()}.pdf`;

      const { error: upErr } = await sb.storage.from(ASSIGNMENT_BUCKET).upload(
        filePath, file, { upsert:true, contentType:'application/pdf' }
      );
      if(upErr){
        statusEl.textContent = 'Upload failed: ' + upErr.message;
        uploadingAssignment = false;
        return;
      }

      const { data: urlData } = sb.storage.from(ASSIGNMENT_BUCKET).getPublicUrl(filePath);
      uploadedAssignmentPath = filePath;
      uploadedAssignmentUrl  = urlData?.publicUrl || null;
      uploadingAssignment = false;
      statusEl.textContent = 'PDF uploaded successfully.';
    });

    // ---- Submission ----
    document.getElementById('assessmentForm').onsubmit = async function(e){
      e.preventDefault();
      const errEl = document.getElementById('errorMsg');
      const submitBtn = document.getElementById('submitBtn');
      errEl.textContent = '';

      if(!uploadedAssignmentPath){
        errEl.textContent = uploadingAssignment
          ? 'Please wait: assignment is still uploading...'
          : 'Please upload the assignment PDF before submitting.';
        return;
      }

      const form = e.target;

      let allAnswered = true;
      const answers = [];
      for(let i=0; i<questions.length; i++){
        const q = questions[i];
        if(['mcq','dropdown'].includes(q.type)){
          const v = form[`q${i}`]?.value?.trim() || '';
          if(!v) allAnswered = false;
          answers.push(v);
        } else if(q.type === "image-labels"){
          const labelVals = [];
          for(let lid=0; lid<q.labels.length; lid++){
            const v = form[`q${i}_label${lid}`]?.value?.trim() || '';
            if(!v) allAnswered = false;
            labelVals.push(v);
          }
          answers.push(labelVals.join('; '));
        }
      }

      if(!allAnswered){
        errEl.textContent = 'Please answer all questions.';
        return;
      }
      if(!form.declaration.checked){
        errEl.textContent = 'You must agree to the declaration.';
        return;
      }

      // Scoring
      let marks = 0;
      let maxMarks = 0;
      for(let i=0; i<questions.length; i++){
        const q = questions[i];
        if(['mcq','dropdown'].includes(q.type)){
          maxMarks += 1;
          if(answers[i] === q.answer) marks++;
        } else if(q.type === "image-labels"){
          maxMarks += q.labels.length;
          const parts = answers[i].split(';').map(s => s.trim());
          q.labels.forEach((label, lid) => {
            if(parts[lid] && parts[lid] === label.answer) marks++;
          });
        }
      }

      submitBtn.disabled = true;

      const { data:{ session } } = await sb.auth.getSession();
      if(!session?.user){
        alert('Please log in so your result is stored.');
        window.location.href = '../login_Version4.html';
        return;
      }
      const uid = session.user.id;

      // Breakdown for result page
      const breakdown = [];
      for(let i=0; i<questions.length; i++){
        const q = questions[i];
        if(['mcq','dropdown'].includes(q.type)){
          breakdown.push({
            question: q.text,
            type: q.type,
            answer: answers[i],
            correct: q.answer,
            isCorrect: answers[i] === q.answer
          });
        } else if(q.type === "image-labels"){
          const parts = answers[i].split(';').map(s=>s.trim());
          q.labels.forEach((label, lid) => {
            breakdown.push({
              question: `${q.text} (Label ${label.name})`,
              type: 'image-label',
              answer: parts[lid],
              correct: label.answer,
              isCorrect: parts[lid] === label.answer
            });
          });
        }
      }
      breakdown.push({
        type: 'meta',
        assignment: {
          bucket: ASSIGNMENT_BUCKET,
          path: uploadedAssignmentPath,
          publicUrl: uploadedAssignmentUrl || null
        }
      });

      const durationSec = Math.round((Date.now() - pageStartTime)/1000);

      const row = {
        user_id: uid,
        user_name: form.studentName.value.trim(),
        experiment_id: EXPERIMENT_ID,
        score: marks,
        total: maxMarks,
        submitted_at: new Date().toISOString(),
        duration_sec: durationSec,
        breakdown,
        meta: {
          email: form.emailId.value.trim(),
          prn: form.prnNumber.value.trim(),
          batch: form.batchNumber.value.trim(),
          school_name: form.schoolName.value.trim(),
          assessment_title: ASSESSMENT_TITLE
        },
        assignment_bucket: ASSIGNMENT_BUCKET,
        assignment_path: uploadedAssignmentPath
      };

      const { error } = await sb.from('assessment_results').insert(row);
      if(error){
        console.error('Supabase insert error:', error);
        errEl.textContent = 'Could not save result. Please retry.';
        submitBtn.disabled = false;
        return;
      }

      window.location.href = `../result.html?exp=${encodeURIComponent(EXPERIMENT_ID)}`;
    };

    // Run gate on load
    window.addEventListener('DOMContentLoaded', gate);
  </script>
</body>
</html>
