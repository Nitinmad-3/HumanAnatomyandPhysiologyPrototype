<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Assessment: Clotting Time by Capillary Glass Tube Method</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #e3f2fd; margin: 0;}
    header { text-align: center; padding: 2rem 1rem 1rem 1rem;}
    h1 { color: #1565c0; margin:0 0 .5rem; }
    nav a { margin:0 .5rem; text-decoration:none; color:#1565c0; font-weight:600; }
    .container { max-width: 800px; margin: 2rem auto; background: #fff; border-radius: 16px; padding: 2rem; box-shadow: 0 2px 8px #90caf9;}
    .question { margin-bottom: 1.5em;}
    .student-info label { display: block; margin: 0.5em 0 0.2em;}
    .student-info input, .student-info select { width: 100%; padding: 0.5em; margin-bottom: 1em;}
    .assignment-upload { background:#e1f5fe; padding:1em; border-radius:10px; margin:1em 0 2em; }
    .assignment-status { font-size:.9em; margin-top:.4em; color:#388e3c; }
    .note { font-size:.75em; color:#1565c0; margin-top:.2em; }
    .declaration { margin: 2em 0 1em 0; }
    .submit-btn { padding: 0.8em 2em; font-size: 1.1em; border: none; background: #1565c0; color: #fff; border-radius: 5px; cursor:pointer;}
    .submit-btn:disabled { background: #90caf9; cursor:not-allowed; }
    .result { font-size: 1.3em; color: #388e3c; margin-top: 2em;}
    .error { color: #d32f2f; margin-bottom: 1em;}
    img.question-img { max-width: 400px; display: block; margin-bottom: 1em; }
    label.dropdown-label { display: inline-block; min-width: 120px; }
    /* Block message */
    .block-access-msg {
      border-radius:10px;
      background:#ffebee;
      color:#b71c1c;
      border:1px solid #c62828;
      font-size:1.05em;
      margin:2em auto;
      padding:1.25em 1.5em;
      text-align:center;
      max-width:800px;
      font-weight:600;
    }
    .block-access-msg a { color:#b71c1c; text-decoration:underline; }
    /* Admin banner */
    .admin-banner {
      margin:0 auto 14px;
      max-width:800px;
      background:#fff8e1;
      color:#8d6e63;
      border:1px solid #ffe0b2;
      border-radius:10px;
      padding:10px 12px;
      font-size:.95em;
    }
    @media (max-width: 600px) { .container { padding: 1rem; } img.question-img { max-width:100%; } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
</head>
<body>
  <header>
    <h1>Assessment: Clotting Time by Capillary Glass Tube Method</h1>
    <nav>
      <a href="../index.html">Home</a>
      <a href="../experiments.html">Experiments</a>
      <a href="../assessments.html">Assessments</a>
      <a href="../references.html">References</a>
    </nav>
  </header>

  <!-- Admin preview banner (injected when needed) -->
  <div id="adminBannerMount"></div>

  <!-- Form container (hidden until access is verified) -->
  <div class="container" id="mainContainer" style="display:none;">
    <form id="assessmentForm" autocomplete="off">
      <div class="student-info">
        <h2 style="margin-top:0;">Student Information</h2>
        <label for="studentName">Student Name*</label>
        <input type="text" id="studentName" name="studentName" required>
        <label for="schoolName">School Name*</label>
        <input type="text" id="schoolName" name="schoolName" required>
        <label for="prnNumber">PRN Number*</label>
        <input type="text" id="prnNumber" name="prnNumber" required>
        <label for="batchNumber">Batch Number*</label>
        <select id="batchNumber" name="batchNumber" required>
          <option value="">Select Batch</option>
          <option value="A">A</option>
          <option value="B">B</option>
        </select>
        <label for="emailId">Email ID (add your institutional email id)*</label>
        <input type="email" id="emailId" name="emailId" required>
        <div class="note" id="profileNote"></div>
      </div>

      <!-- Assignment Upload -->
      <div class="assignment-upload">
        <label for="assignmentFile"><b>Upload Assignment (PDF only)*</b></label>
        <input type="file" id="assignmentFile" name="assignmentFile" accept="application/pdf" required>
        <div id="assignmentStatus" class="assignment-status"></div>
        <div class="note">Must finish uploading before submitting the assessment.</div>
      </div>

      <hr>
      <div id="questionsSection"></div>

      <div class="declaration">
        <input type="checkbox" id="declaration" required>
        <label for="declaration">
          I hereby declare that this assessment is for my own progress and benefit. All answers submitted are my own and not generated by AI or provided by friends.
        </label>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">Submit</button>
      <div class="error" id="errorMsg"></div>
      <div class="result" id="resultMsg"></div>
    </form>
  </div>

  <!-- Block message container -->
  <div id="blockMsg" style="display:none;"></div>

  <script>
    // ---- Supabase Constants & Init ----
    const DEFAULT_ASSESSMENT_ID = 8; // matches your admin table row for this experiment
    const EXPERIMENT_ID = 'assessment-8-clotting-time';
    const ASSESSMENT_TITLE = 'Experiment No. 8 (Clotting Time by Capillary Glass Tube Method)';
    const ASSIGNMENT_BUCKET = 'assignments';
    const pageStartTime = Date.now();

    const urlParams = new URLSearchParams(location.search);
    const ASSESSMENT_ID = Number(urlParams.get('id')) || DEFAULT_ASSESSMENT_ID;

    let sb = null;
    try {
      sb = window.supabase.createClient(
        'https://hunlistfklwvpivfjmbk.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1bmxpc3Rma2x3dnBpdmZqbWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MzA1NDUsImV4cCI6MjA3MzQwNjU0NX0.e-o_qL1Uf5DpW4gX60ktXyuUXmw5YWhqaw6Cx8Xc8Qs'
      );
    } catch (e) {
      console.warn('Supabase init failed:', e);
    }

    // ---- Access control helpers ----
    function showBlock(messageHtml){
      const blockMsg = document.getElementById('blockMsg');
      const main = document.getElementById('mainContainer');
      if (main) main.style.display = 'none';
      blockMsg.style.display = '';
      blockMsg.innerHTML = `<div class="block-access-msg">${messageHtml}</div>`;
    }
    function showMain(){
      const main = document.getElementById('mainContainer');
      const blockMsg = document.getElementById('blockMsg');
      if (blockMsg) blockMsg.style.display = 'none';
      if (main) main.style.display = '';
    }
    function showAdminBanner(text){
      const mount = document.getElementById('adminBannerMount');
      if (!mount) return;
      mount.innerHTML = `<div class="admin-banner"><b>Admin preview:</b> ${text}</div>`;
    }

    async function checkProfileAccess() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session?.user) {
        showBlock(`Please <a href="../login_Version4.html">sign in</a> to access this experiment.`);
        return { ok:false, uid:null, isAdmin:false };
      }
      const uid = session.user.id;
      const { data: prof, error } = await sb
        .from('profiles')
        .select('role, approved, active')
        .eq('id', uid)
        .maybeSingle();

      if (error) {
        console.warn('profile lookup failed:', error);
        showBlock('Unable to load your profile. Please try again.');
        return { ok:false, uid:null, isAdmin:false };
      }

      const role = String(prof?.role || '').toLowerCase();
      const isAdmin = role === 'admin';

      if (isAdmin) {
        // Admin bypass â€” login is enough
        return { ok:true, uid, isAdmin:true };
      }

      if (!prof) {
        showBlock('Profile not found. Please contact administrator.');
        return { ok:false, uid:null, isAdmin:false };
      }
      if (prof.approved === false) {
        showBlock('Your account is not approved yet by the admin.');
        return { ok:false, uid:null, isAdmin:false };
      }
      if (prof.active === false) {
        showBlock('Your account has been deactivated by the admin.');
        return { ok:false, uid:null, isAdmin:false };
      }
      return { ok:true, uid, isAdmin:false };
    }

    async function getAssessmentRowById(id) {
      try {
        const { data, error } = await sb
          .from('assessments')
          .select('id, title, locked, window_start, window_end')
          .eq('id', id)
          .maybeSingle();
        if (error) {
          console.warn('assessments(id) lookup error:', error);
          return null;
        }
        return data || null;
      } catch { return null; }
    }

    async function gate() {
      if (!sb) {
        showBlock('Unable to initialize backend. Please refresh the page.');
        return;
      }

      // 1) Require login; for students also require approved + active. Admin bypasses locks/windows AND missing rows.
      const prof = await checkProfileAccess();
      if (!prof.ok) return;

      // 2) Load assessment row (may be null due to config/RLS; admins still bypass)
      const row = await getAssessmentRowById(ASSESSMENT_ID);

      if (prof.isAdmin) {
        // Admin: always allow, even if row is missing
        const flags = [];
        if (!row) flags.push('not configured');
        else {
          const now = new Date();
          const start = row.window_start ? new Date(row.window_start) : null;
          const end   = row.window_end ? new Date(row.window_end) : null;
          if (row.locked) flags.push('locked');
          if (start && now < start) flags.push('not yet open');
          if (end && now > end) flags.push('closed');
        }
        if (flags.length) showAdminBanner(`This assessment is ${flags.join(' & ')} for students.`);
        showMain();
        renderQuestions();
        autofillFromProfile();
        return;
      }

      // Student path: require row and enforce windows/lock
      if (!row) {
        showBlock('Assessment not available right now. Please try again later.');
        return;
      }

      const now = new Date();
      const start = row.window_start ? new Date(row.window_start) : null;
      const end   = row.window_end ? new Date(row.window_end) : null;

      if (row.locked === true) {
        showBlock('This experiment is currently locked by the admin.');
        return;
      }
      if (start && now < start) {
        showBlock('This experiment is not yet open. Please check back later.');
        return;
      }
      if (end && now > end) {
        showBlock('This experiment is closed.');
        return;
      }

      // Allowed -> reveal and continue
      showMain();
      renderQuestions();
      autofillFromProfile();
    }

    // ---- Autofill from Profile ----
    async function autofillFromProfile() {
      try {
        const { data: { session } } = await sb.auth.getSession();
        if (!session?.user) return;

        const uid = session.user.id;
        const { data: profile, error } = await sb
          .from('profiles')
          .select('name, email, prn, batch, school_name')
          .eq('id', uid)
          .maybeSingle();

        if (error || !profile) return;

        const studentNameEl = document.getElementById('studentName');
        const schoolNameEl = document.getElementById('schoolName');
        const prnEl = document.getElementById('prnNumber');
        const batchEl = document.getElementById('batchNumber');
        const emailEl = document.getElementById('emailId');
        const profileNote = document.getElementById('profileNote');

        if (studentNameEl && !studentNameEl.value) studentNameEl.value = profile.name || '';
        if (schoolNameEl && !schoolNameEl.value) schoolNameEl.value = profile.school_name || '';
        if (prnEl && !prnEl.value) prnEl.value = profile.prn || '';
        if (batchEl && !batchEl.value && profile.batch) {
          const match = Array.from(batchEl.options).find(o => (o.value || '').toLowerCase() === String(profile.batch).toLowerCase());
          if (!match && profile.batch) {
            const opt = document.createElement('option');
            opt.value = profile.batch;
            opt.textContent = profile.batch;
            batchEl.appendChild(opt);
          }
          batchEl.value = profile.batch;
        }
        if (emailEl && !emailEl.value) emailEl.value = profile.email || session.user.email || '';
        if (profileNote) profileNote.textContent = '';
      } catch {}
    }

    // ---- Utility ----
    function shuffleArray(arr){
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // ---- Questions ----
    const questions = [
      {
        type: "mcq",
        text: "1. The principle of the capillary glass tube method for clotting time is mainly based on:",
        options: [
          "Formation of a platelet plug",
          "Observation of fibrin thread formation",
          "Measurement of blood pressure",
          "Agglutination of red cells"
        ],
        answer: "Observation of fibrin thread formation"
      },
      {
        type: "mcq",
        text: "2. Which pathway of the coagulation cascade is primarily initiated when blood contacts glass in vitro?",
        options: [
          "Extrinsic pathway",
          "Intrinsic pathway",
          "Common pathway",
          "Fibrinolytic pathway"
        ],
        answer: "Intrinsic pathway"
      },
      {
        type: "mcq",
        text: "3. Which clotting factor is activated first in the intrinsic pathway when blood is drawn into a glass tube?",
        options: [
          "Factor VII",
          "Factor IX",
          "Factor XII",
          "Factor V"
        ],
        answer: "Factor XII"
      },
      {
        type: "mcq",
        text: "4. The main difference between the intrinsic and extrinsic pathways in blood coagulation is:",
        options: [
          "Source of initiating factors",
          "Requirement for platelets",
          "Involvement of calcium ions",
          "Production of thrombin"
        ],
        answer: "Source of initiating factors"
      },
      {
        type: "mcq",
        text: "5. In the procedure of the capillary tube method, why is the tube kept undisturbed and horizontal for 1-2 minutes?",
        options: [
          "To prevent clot retraction",
          "To allow uniform temperature",
          "To allow the intrinsic pathway to proceed without interference",
          "To avoid hemolysis from shaking"
        ],
        answer: "To allow the intrinsic pathway to proceed without interference"
      },
      {
        type: "mcq",
        text: "6. The final common pathway in the coagulation cascade results in the conversion of:",
        options: [
          "Prothrombin to thrombin",
          "Fibrinogen to fibrin",
          "Factor X to Factor Xa",
          "Calcium to activated platelets"
        ],
        answer: "Fibrinogen to fibrin"
      },
      {
        type: "mcq",
        text: "7. Which of the following would most likely prolong the clotting time measured by the capillary tube method?",
        options: [
          "Increased platelets",
          "Vitamin K deficiency",
          "Polycythemia",
          "Hypercalcemia"
        ],
        answer: "Vitamin K deficiency"
      },
      {
        type: "mcq",
        text: "8. In the capillary tube procedure, what is the significance of breaking the tube every 30 seconds?",
        options: [
          "To introduce air and speed up clotting",
          "To check for the formation of the fibrin thread indicating clot formation",
          "To mix the sample for even distribution",
          "To remove excess plasma"
        ],
        answer: "To check for the formation of the fibrin thread indicating clot formation"
      },
      {
        type: "mcq",
        text: "9. Which statement is TRUE regarding the extrinsic pathway of coagulation?",
        options: [
          "It is primarily triggered by exposure to subendothelial tissue factor",
          "It requires contact with glass for activation",
          "It does not require calcium ions",
          "It is measured by the capillary tube method"
        ],
        answer: "It is primarily triggered by exposure to subendothelial tissue factor"
      },
      {
        type: "image-labels",
        text: "10. Identify the labelled steps in the extrinsic pathway diagram below:",
        image: "../assets/images/experiment-8/assessmnt/extrinsic.png",
        labels: [
          { name: "1", answer: "Tissue Damage", options: [
              "Tissue Damage",
              "Tissue Factor (TF) Release",
              "Factor VII Activation",
              "Factor X Activation",
              "Thrombin Formation",
              "Fibrin Formation"
            ]
          },
          { name: "2", answer: "Tissue Factor (TF) Release", options: [
              "Tissue Damage",
              "Tissue Factor (TF) Release",
              "Factor VII Activation",
              "Factor X Activation",
              "Thrombin Formation",
              "Fibrin Formation"
            ]
          },
          { name: "3", answer: "Factor VII Activation", options: [
              "Tissue Damage",
              "Tissue Factor (TF) Release",
              "Factor VII Activation",
              "Factor X Activation",
              "Thrombin Formation",
              "Fibrin Formation"
            ]
          },
          { name: "4", answer: "Factor X Activation", options: [
              "Tissue Damage",
              "Tissue Factor (TF) Release",
              "Factor VII Activation",
              "Factor X Activation",
              "Thrombin Formation",
              "Fibrin Formation"
            ]
          },
          { name: "5", answer: "Thrombin Formation", options: [
              "Tissue Damage",
              "Tissue Factor (TF) Release",
              "Factor VII Activation",
              "Factor X Activation",
              "Thrombin Formation",
              "Fibrin Formation"
            ]
          },
          { name: "6", answer: "Fibrin Formation", options: [
              "Tissue Damage",
              "Tissue Factor (TF) Release",
              "Factor VII Activation",
              "Factor X Activation",
              "Thrombin Formation",
              "Fibrin Formation"
            ]
          }
        ]
      }
    ];

    // shuffle options to randomize
    questions.forEach(q => {
      if(q.options) shuffleArray(q.options);
      if(q.labels) q.labels.forEach(lab => shuffleArray(lab.options));
    });

    // ---- Render Questions ----
    function renderQuestions(){
      const qs = document.getElementById('questionsSection');
      if(!qs) return;
      qs.innerHTML = '<h2>Assessment Questions</h2>';
      questions.forEach((q, idx) => {
        let html = `<div class="question"><label><b>${q.text}</b></label><br>`;
        if(q.type === "mcq"){
          q.options.forEach(opt => {
            html += `<label><input type="radio" name="q${idx}" value="${opt}" required> ${opt}</label><br>`;
          });
        } else if(q.type === "dropdown"){
          html += `<select name="q${idx}" required><option value="">Select...</option>`;
          q.options.forEach(opt => { html += `<option value="${opt}">${opt}</option>`; });
          html += '</select>';
        } else if(q.type === "image-labels"){
          html += `<img src="${q.image}" alt="Labelled diagram" class="question-img"><br>`;
          q.labels.forEach((label, lid) => {
            html += `<label class="dropdown-label">${label.name}:</label> <select name="q${idx}_label${lid}" required>`;
            html += `<option value="">Select...</option>`;
            label.options.forEach(opt => { html += `<option value="${opt}">${opt}</option>`; });
            html += `</select><br>`;
          });
        }
        html += '</div>';
        qs.innerHTML += html;
      });
    }

    // ---- Assignment Upload ----
    let uploadedAssignmentPath = null;
    let uploadedAssignmentUrl  = null;
    let uploadingAssignment    = false;

    document.addEventListener('change', function onDocChange(e){
      if(!e.target) return;
      if(e.target.id !== 'assignmentFile') return;
      (async function handleFileChange(evt){
        const statusEl = document.getElementById('assignmentStatus');
        const file = evt.target.files[0];
        statusEl.textContent = '';
        uploadedAssignmentPath = null;
        uploadedAssignmentUrl  = null;

        if(!file) return;
        if(file.type !== 'application/pdf'){
          statusEl.textContent = 'Only PDF files allowed.';
          evt.target.value = '';
          return;
        }

        uploadingAssignment = true;
        statusEl.textContent = 'Uploading PDF...';

        const { data:{ session } } = await sb.auth.getSession();
        if(!session?.user){
          statusEl.textContent = 'Login required before upload.';
          uploadingAssignment = false;
          evt.target.value = '';
          return;
        }

        const uid = session.user.id;
        const filePath = `${uid}/${EXPERIMENT_ID}/${Date.now()}.pdf`;

        const { error: upErr } = await sb.storage.from(ASSIGNMENT_BUCKET).upload(
          filePath, file, { upsert:true, contentType:'application/pdf' }
        );
        if(upErr){
          statusEl.textContent = 'Upload failed: ' + upErr.message;
          uploadingAssignment = false;
          return;
        }

        const { data: urlData } = sb.storage.from(ASSIGNMENT_BUCKET).getPublicUrl(filePath);
        uploadedAssignmentPath = filePath;
        uploadedAssignmentUrl  = urlData?.publicUrl || null;
        uploadingAssignment = false;
        statusEl.textContent = 'PDF uploaded successfully.';
      })(e);
    });

    // ---- Submission ----
    document.getElementById('assessmentForm').onsubmit = async function(e){
      e.preventDefault();
      const errEl = document.getElementById('errorMsg');
      const resEl = document.getElementById('resultMsg');
      const submitBtn = document.getElementById('submitBtn');
      errEl.textContent = '';
      resEl.textContent = '';

      if(!uploadedAssignmentPath){
        errEl.textContent = uploadingAssignment
          ? 'Please wait: assignment is still uploading...'
          : 'Please upload the assignment PDF before submitting.';
        return;
      }

      const form = e.target;

      let allAnswered = true;
      const answers = [];
      for(let i=0; i<questions.length; i++){
        const q = questions[i];
        if(['mcq','dropdown'].includes(q.type)){
          const v = form[`q${i}`]?.value?.trim() || '';
          if(!v) allAnswered = false;
          answers.push(v);
        } else if(q.type === 'image-labels'){
          const labelVals = [];
          for(let lid=0; lid<q.labels.length; lid++){
            const v = form[`q${i}_label${lid}`]?.value?.trim() || '';
            if(!v) allAnswered = false;
            labelVals.push(v);
          }
          answers.push(labelVals.join('; '));
        }
      }

      if(!allAnswered){
        errEl.textContent = 'Please answer all questions.';
        return;
      }
      if(!form.declaration.checked){
        errEl.textContent = 'You must agree to the declaration.';
        return;
      }

      // Scoring
      let marks = 0;
      let maxMarks = 0;
      for(let i=0; i<questions.length; i++){
        const q = questions[i];
        if(['mcq','dropdown'].includes(q.type)){
          maxMarks += 1;
          if(answers[i] === q.answer) marks++;
        } else if(q.type === 'image-labels'){
          maxMarks += q.labels.length;
          const parts = answers[i].split(';').map(s => s.trim());
          q.labels.forEach((label, lid) => {
            if(parts[lid] && parts[lid] === label.answer) marks++;
          });
        }
      }

      submitBtn.disabled = true;
      resEl.textContent = `Submitting your attempt (${marks}/${maxMarks})...`;

      const { data:{ session } } = await sb.auth.getSession();
      if(!session?.user){
        alert('Please log in so your result is stored.');
        window.location.href = '../login_Version4.html';
        return;
      }
      const uid = session.user.id;

      // Breakdown for result page
      const breakdown = [];
      for(let i=0; i<questions.length; i++){
        const q = questions[i];
        if(['mcq','dropdown'].includes(q.type)){
          breakdown.push({
            question: q.text,
            type: q.type,
            answer: answers[i],
            correct: q.answer,
            isCorrect: answers[i] === q.answer
          });
        } else if(q.type === 'image-labels'){
          const parts = answers[i].split(';').map(s=>s.trim());
          q.labels.forEach((label, lid) => {
            breakdown.push({
              question: `${q.text} (Label ${label.name})`,
              type: 'image-label',
              answer: parts[lid],
              correct: label.answer,
              isCorrect: parts[lid] === label.answer
            });
          });
        }
      }
      breakdown.push({
        type: 'meta',
        assignment: {
          bucket: ASSIGNMENT_BUCKET,
          path: uploadedAssignmentPath,
          publicUrl: uploadedAssignmentUrl || null
        }
      });

      const durationSec = Math.round((Date.now() - pageStartTime)/1000);

      const row = {
        user_id: uid,
        user_name: form.studentName.value.trim(),
        experiment_id: EXPERIMENT_ID,
        score: marks,
        total: maxMarks,
        submitted_at: new Date().toISOString(),
        duration_sec: durationSec,
        breakdown,
        meta: {
          email: form.emailId.value.trim(),
          prn: form.prnNumber.value.trim(),
          batch: form.batchNumber.value.trim(),
          school_name: form.schoolName.value.trim(),
          assessment_title: ASSESSMENT_TITLE
        },
        assignment_bucket: ASSIGNMENT_BUCKET,
        assignment_path: uploadedAssignmentPath
      };

      const { error } = await sb.from('assessment_results').insert(row);
      if(error){
        console.error('Supabase insert error:', error);
        errEl.textContent = 'Could not save result. Please retry.';
        submitBtn.disabled = false;
        return;
      }

      window.location.href = `../result.html?exp=${encodeURIComponent(EXPERIMENT_ID)}`;
    };

    // Run gate on load
    window.addEventListener('DOMContentLoaded', gate);
  </script>
</body>
</html>
